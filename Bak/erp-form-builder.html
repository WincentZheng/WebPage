<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ERP畫面輔助產生器</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      font-size: 16px;
    }

    /* 綠色系主題（預設，不變動） */
    :root,
    [data-theme="green"] {
      --border: #c5cfb5;
      --border-dark: #6c7a57;
      --bg: #e6efd8;
      --canvas: #f2f7e6;
      --panel: #fefef9;
      --header: #4e6a3a;
      --header-dark: #3b4f2a;
      --accent: #c56a00;
      --header-gradient-start: #607c4d;
      --header-gradient-end: #4e6a3a;
      --section-bg-start: #eff5e3;
      --section-bg-end: #dde7cc;
      --grid-header-bg: #d4e4c5;
      --grid-header-hover: #c5d5b5;
      --preview-bg: #f5f9f0;
      --preview-grid-row-bg: #f5f9f0;
      --tool-bg: #f9fdf1; /* 工具框背景色 */
      --tool-hover-bg: #f5f9f0; /* 工具框懸停背景色 */
      --palette-header-hover-start: #e8f0dc; /* 區塊標題懸停背景色起始 */
      --palette-header-hover-end: #d4e0c0; /* 區塊標題懸停背景色結束 */
      --button-border: #a2b08c; /* 按鈕框線顏色 */
      --button-bg-start: #f9fdf1; /* 按鈕背景色起始 */
      --button-bg-end: #f5f9f0; /* 按鈕背景色結束 */
      --button-text: #2a371d; /* 按鈕文字顏色 */
      --button-hover-bg-start: #f5f9f0; /* 按鈕懸停背景色起始 */
      --button-hover-bg-end: #eff5e3; /* 按鈕懸停背景色結束 */
      --button-shadow: rgba(54, 74, 37, 0.15); /* 按鈕陰影顏色 */
      --button-hover-shadow: rgba(54, 74, 37, 0.2); /* 按鈕懸停陰影顏色 */
    }

    /* 藍色系主題（參考 ERP 系統風格） */
    [data-theme="blue"] {
      --border: #b8c5d1;
      --border-dark: #6b7d8f;
      --bg: #e3eef7;
      --canvas: #f0f5fa;
      --panel: #ffffff;
      --header: #2c5aa0;
      --header-dark: #1e3d6f;
      --accent: #2c5aa0;
      --header-gradient-start: #3d6bb3;
      --header-gradient-end: #2c5aa0;
      --section-bg-start: #e8f2fa;
      --section-bg-end: #d0e5f5;
      --grid-header-bg: #c5d9e8;
      --grid-header-hover: #b0c9dc;
      --preview-bg: #f0f5fa;
      --preview-grid-row-bg: #f0f5fa;
      --tool-bg: #f0f8ff; /* 工具框背景色（藍色系） */
      --tool-hover-bg: #e6f2ff; /* 工具框懸停背景色（藍色系） */
      --palette-header-hover-start: #d0e5f5; /* 區塊標題懸停背景色起始（藍色系） */
      --palette-header-hover-end: #b8d4ea; /* 區塊標題懸停背景色結束（藍色系） */
      --button-border: #8ba3c4; /* 按鈕框線顏色（藍色系） */
      --button-bg-start: #e8f2fa; /* 按鈕背景色起始（藍色系） */
      --button-bg-end: #d0e5f5; /* 按鈕背景色結束（藍色系） */
      --button-text: #1e3d6f; /* 按鈕文字顏色（藍色系） */
      --button-hover-bg-start: #d0e5f5; /* 按鈕懸停背景色起始（藍色系） */
      --button-hover-bg-end: #b8d4ea; /* 按鈕懸停背景色結束（藍色系） */
      --button-shadow: rgba(44, 90, 160, 0.15); /* 按鈕陰影顏色（藍色系） */
      --button-hover-shadow: rgba(44, 90, 160, 0.2); /* 按鈕懸停陰影顏色（藍色系） */
    }

    /* 橘色系主題（參考 ERP 系統風格） */
    [data-theme="orange"] {
      --border: #e6b88a;
      --border-dark: #cc8533;
      --bg: #fff4e6;
      --canvas: #fff8f0;
      --panel: #ffffff;
      --header: #d97706;
      --header-dark: #b45309;
      --accent: #f97316;
      --header-gradient-start: #fb923c;
      --header-gradient-end: #ea580c;
      --section-bg-start: #ffedd5;
      --section-bg-end: #fed7aa;
      --grid-header-bg: #ffd7a8;
      --grid-header-hover: #ffc47a;
      --preview-bg: #fff4e6;
      --preview-grid-row-bg: #fff4e6;
      --tool-bg: #fff8f0; /* 工具框背景色（橘色系） */
      --tool-hover-bg: #ffedd5; /* 工具框懸停背景色（橘色系） */
      --palette-header-hover-start: #fed7aa; /* 區塊標題懸停背景色起始（橘色系） */
      --palette-header-hover-end: #ffd7a8; /* 區塊標題懸停背景色結束（橘色系） */
      --button-border: #d97706; /* 按鈕框線顏色（橘色系） */
      --button-bg-start: #ffedd5; /* 按鈕背景色起始（橘色系） */
      --button-bg-end: #fed7aa; /* 按鈕背景色結束（橘色系） */
      --button-text: #b45309; /* 按鈕文字顏色（橘色系） */
      --button-hover-bg-start: #fed7aa; /* 按鈕懸停背景色起始（橘色系） */
      --button-hover-bg-end: #ffd7a8; /* 按鈕懸停背景色結束（橘色系） */
      --button-shadow: rgba(217, 119, 6, 0.15); /* 按鈕陰影顏色（橘色系） */
      --button-hover-shadow: rgba(217, 119, 6, 0.2); /* 按鈕懸停陰影顏色（橘色系） */
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #233018;
    }

    header {
      display: flex;
      align-items: center;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, var(--header-gradient-start), var(--header-gradient-end));
      gap: 12px;
      flex-wrap: wrap;
      color: #f5f7ef;
    }

    header h1 {
      font-size: 1.15rem;
      margin: 0 12px 0 0;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 .header-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      opacity: 0.95;
    }

    .version-display {
      font-size: 0.75rem;
      font-weight: 400;
      opacity: 0.85;
      margin-left: 8px;
      padding: 2px 8px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    button {
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.15);
      padding: 8px 18px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
      font-size: 0.9rem;
      color: #f5f7ef;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* 按鈕圖示樣式 */
    .btn-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    button::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    button:hover::before {
      left: 100%;
    }

    button.primary {
      background: linear-gradient(135deg, #d67a0a 0%, #c56a00 50%, #b85a00 100%);
      border-color: rgba(255, 255, 255, 0.3);
      color: white;
      box-shadow: 0 4px 12px rgba(197, 106, 0, 0.4), 
                  0 2px 4px rgba(0, 0, 0, 0.2),
                  inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    /* 橘色系主題：按鈕配色（使用藍色漸變以突出顯示） */
    [data-theme="orange"] button.primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
      border-color: rgba(255, 255, 255, 0.4);
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.5), 
                  0 2px 4px rgba(0, 0, 0, 0.2),
                  inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.3);
    }

    button:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.35);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    button.primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #e88a1a 0%, #d67a0a 50%, #c56a00 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(197, 106, 0, 0.5), 
                  0 3px 6px rgba(0, 0, 0, 0.25),
                  inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }

    /* 橘色系主題：按鈕懸停效果（使用藍色漸變） */
    [data-theme="orange"] button.primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #2563eb 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.6), 
                  0 3px 6px rgba(0, 0, 0, 0.25),
                  inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    button.primary:active:not(:disabled) {
      background: linear-gradient(135deg, #c56a00 0%, #b85a00 50%, #a85a00 100%);
      box-shadow: 0 2px 8px rgba(197, 106, 0, 0.3), 
                  inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* 橘色系主題：按鈕按下效果（使用藍色漸變） */
    [data-theme="orange"] button.primary:active:not(:disabled) {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 50%, #1e40af 100%);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4), 
                  inset 0 2px 4px rgba(0, 0, 0, 0.25);
    }

    .column-picker {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }

    .column-picker select {
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.9rem;
      background: #fefdf8;
    }

    /* 主題切換器樣式 */
    .theme-switcher {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto; /* 靠右對齊 */
      font-size: 0.9rem;
    }

    .theme-label {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }

    .theme-buttons {
      display: flex;
      gap: 4px;
      background: rgba(255, 255, 255, 0.15);
      padding: 4px;
      border-radius: 8px;
      backdrop-filter: blur(4px);
    }

    .theme-btn {
      min-width: 40px;
      height: 32px;
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      padding: 0 10px;
      color: white;
    }

    /* NBS 按鈕（綠色） */
    .theme-btn[data-theme="green"] {
      background: linear-gradient(135deg, #607c4d 0%, #4e6a3a 100%);
    }

    .theme-btn[data-theme="green"]:hover {
      background: linear-gradient(135deg, #6c8a5a 0%, #5a7a46 100%);
      transform: scale(1.05);
    }

    .theme-btn[data-theme="green"].active {
      background: linear-gradient(135deg, #6c8a5a 0%, #5a7a46 100%);
      border-color: rgba(255, 255, 255, 0.5);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* T9 按鈕（藍色） */
    .theme-btn[data-theme="blue"] {
      background: linear-gradient(135deg, #3d6bb3 0%, #2c5aa0 100%);
    }

    .theme-btn[data-theme="blue"]:hover {
      background: linear-gradient(135deg, #4d7bc3 0%, #3c6ab0 100%);
      transform: scale(1.05);
    }

    .theme-btn[data-theme="blue"].active {
      background: linear-gradient(135deg, #4d7bc3 0%, #3c6ab0 100%);
      border-color: rgba(255, 255, 255, 0.5);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* T8 按鈕（橘色） */
    .theme-btn[data-theme="orange"] {
      background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
    }

    .theme-btn[data-theme="orange"]:hover {
      background: linear-gradient(135deg, #ffa64c 0%, #ff8326 100%);
      transform: scale(1.05);
    }

    .theme-btn[data-theme="orange"].active {
      background: linear-gradient(135deg, #ffa64c 0%, #ff8326 100%);
      border-color: rgba(255, 255, 255, 0.5);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    main.layout {
      display: grid;
      grid-template-columns: 240px 1fr 260px;
      height: calc(100vh - 66px);
    }

    aside {
      padding: 16px;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    section.canvas {
      padding: 16px;
      overflow-y: auto;
      overflow-x: hidden;
      height: 100%;
      max-height: 100%;
    }

    aside {
      border-right: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.92);
    }

    aside.properties {
      border-left: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.96);
    }

    .canvas {
      background: var(--canvas);
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 16px;
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
      /* 允許內容超出，由父容器 section.canvas 處理卷軸 */
      min-height: min-content;
    }

    .doc-title-row {
      display: flex;
      align-items: center;
      padding: 12px 0;
      background: transparent;
    }

    .doc-title-row input {
      flex: 1;
      border: none;
      border-radius: 0;
      padding: 8px 0;
      font-size: 1.2rem;
      background: transparent;
      font-weight: 700;
      color: var(--header-dark);
      outline: none;
    }

    .doc-title-row input:focus {
      background: transparent;
    }

    .doc-title-row input::placeholder {
      color: #8a9a6f;
      opacity: 0.6;
    }

    .placeholder {
      border: 2px dashed #a2b08c;
      border-radius: 12px;
      padding: 48px 24px;
      text-align: center;
      color: #6c7a57;
      font-size: 0.95rem;
      background: rgba(255, 255, 255, 0.65);
    }

    .tool {
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 12px 12px 12px 24px;
      margin-bottom: 10px;
      cursor: grab;
      background: var(--tool-bg);
      transition: all 0.2s ease;
      position: relative;
      min-height: 56px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--header-dark);
      line-height: 1.6;
      letter-spacing: 0.3px;
    }

    .tool:hover {
      background: var(--tool-hover-bg);
      border-color: var(--border-dark);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .tool:active {
      cursor: grabbing;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(54, 74, 37, 0.08);
      overflow: hidden;
      position: relative;
    }

    .panel.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(197, 106, 0, 0.2);
    }

    .panel-delete {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(180, 52, 41, 0.1);
      color: #b43429;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 20;
    }

    .panel:hover .panel-delete {
      opacity: 1;
    }

    .panel-delete:hover {
      background: rgba(180, 52, 41, 0.2);
    }

    .panel-header {
      background: linear-gradient(90deg, var(--section-bg-start), var(--section-bg-end));
      border-bottom: 1px solid var(--border);
    }

    .panel-tabs {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 8px 0 8px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .panel-tab {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      cursor: move;
      font-size: 0.9rem;
      font-weight: 600;
      color: #4b5a35;
      position: relative;
      transition: all 0.2s ease;
      z-index: 0;
    }

    .panel-tab.dragging {
      opacity: 0.5;
    }

    .panel-tab.drag-over {
      border-top: 2px solid var(--accent);
    }

    .panel-tab:hover {
      background: rgba(255, 255, 255, 0.8);
      z-index: 2;
    }

    .panel-tab.active {
      background: var(--panel);
      border-color: var(--accent);
      border-bottom-color: var(--panel);
      border-width: 2px;
      color: var(--header-dark);
      z-index: 1;
      margin-bottom: -1px;
      box-shadow: 0 -2px 8px rgba(197, 106, 0, 0.2);
      font-weight: 700;
      transform: translateY(-1px);
    }

    .panel-tab-input {
      border: none;
      background: transparent;
      padding: 0;
      font-size: 0.9rem;
      font-weight: 600;
      color: inherit;
      width: 100px;
      outline: none;
    }

    .panel-tab-remove {
      margin-left: 6px;
      cursor: pointer;
      color: #8a9a6f;
      font-weight: bold;
      opacity: 0.6;
    }

    .panel-tab-remove:hover {
      opacity: 1;
      color: #b43429;
    }

    .panel-tab-add {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.3);
      border: 1px dashed var(--border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      color: #6c7a57;
      margin-left: 4px;
    }

    .panel-tab-add:hover {
      background: rgba(255, 255, 255, 0.6);
    }

    .panel-header-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
    }

    .panel-drag-handle {
      width: 20px;
      height: 20px;
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c7a57;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .panel-drag-handle:hover {
      opacity: 1;
      color: var(--accent);
    }

    .panel-drag-handle::before {
      content: "⋮⋮";
      font-size: 14px;
      line-height: 1;
      letter-spacing: -2px;
    }

    .panel.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .panel.drag-over {
      border-top: 3px solid var(--accent);
    }

    .panel-toggle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid var(--border-dark);
      background: #fffbe9;
      font-size: 1rem;
      line-height: 1;
      cursor: pointer;
      font-weight: 700;
      color: var(--header-dark);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .panel-toggle::after {
      content: "-";
    }

    .panel.collapsed .panel-toggle::after {
      content: "+";
    }

    .panel-title-input {
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      font-weight: 700;
      flex: 1;
      background: white;
      color: #2a371d;
    }

    .panel-columns,
    .panel-height {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: #4b5a35;
    }

    .panel-columns select,
    .panel-height select {
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 4px 8px;
      background: white;
    }

    .panel-body {
      --column-count: 3;
      display: grid;
      grid-template-columns: repeat(var(--column-count), minmax(0, 1fr));
      grid-auto-rows: 32px; /* 固定行高：32px，不可變 */
      align-items: start;
      row-gap: 4px; /* 固定間隔：4px */
      column-gap: 4px;
      padding: 8px 16px;
      background: var(--panel);
      min-height: 40px;
      box-sizing: border-box;
      /* 確保列高固定，不會因為內容而改變 */
      grid-template-rows: none;
    }

    .panel.collapsed .panel-body,
    .panel.collapsed .tab-body {
      display: none;
    }

    /* 頁籤容器樣式 */
    .tab-body {
      --column-count: 3;
      display: grid;
      grid-template-columns: repeat(var(--column-count), minmax(0, 1fr));
      grid-auto-rows: 32px; /* 固定行高：32px，不可變 */
      align-items: start;
      row-gap: 4px; /* 固定間隔：4px */
      column-gap: 4px;
      padding: 8px 16px;
      background: var(--panel);
      min-height: 40px;
      box-sizing: border-box;
      /* 確保列高固定，不會因為內容而改變 */
      grid-template-rows: none;
    }

    .tab-body:not(.active) {
      display: none;
    }

    .tab-body.active {
      display: grid;
    }

    .grid-panel-body {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      background: var(--border);
      overflow-x: auto;
      overflow-y: auto;
      max-height: 600px;
      max-width: 100%;
    }

    .grid-header-row {
      display: flex;
      background: var(--grid-header-bg);
      border-bottom: 2px solid var(--border-dark);
      position: sticky;
      top: 0;
      z-index: 10;
      min-width: fit-content;
    }

    /* GRID 表頭行：右方沒有欄位時顯示底色 */
    .grid-header-row::after {
      content: "";
      flex: 1;
      background: var(--grid-header-bg);
      min-height: 100%;
    }

    .grid-header-cell {
      position: relative;
      min-width: 100px;
      padding: 8px 12px;
      border-right: 1px solid var(--border-dark);
      background: var(--grid-header-bg);
      font-weight: 600;
      font-size: 0.9rem;
      color: #2a371d;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: default;
    }

    .grid-header-cell.selected {
      background: rgba(197, 106, 0, 0.15);
      border: 2px solid var(--accent);
      border-right: 1px solid var(--border-dark);
    }

    .grid-header-cell .header-title {
      flex: 1;
      text-align: center;
      cursor: text;
      padding: 2px 4px;
      border-radius: 2px;
      min-height: 20px;
    }

    .grid-header-cell .header-title:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .grid-header-cell .header-title:focus {
      background: white;
      outline: 1px solid var(--accent);
    }

    .grid-header-cell .header-title.required {
      color: #b43429;
    }

    .grid-header-cell .header-delete {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(180, 52, 41, 0.1);
      color: #b43429;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 15;
    }

    .grid-header-cell:hover .header-delete {
      opacity: 1;
    }

    .grid-header-cell .header-delete:hover {
      background: rgba(180, 52, 41, 0.2);
    }

    .grid-header-cell .grid-col-resizer {
      position: absolute;
      right: -2px;
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: col-resize;
      background: transparent;
      z-index: 20;
    }

    .grid-header-cell .grid-col-resizer:hover {
      background: var(--accent);
      opacity: 0.6;
    }

    .grid-header-cell .grid-col-resizer.active {
      background: var(--accent);
      opacity: 1;
    }

    /* 最後一欄也可以調整欄寬 */
    /* .grid-header-cell:last-child .grid-col-resizer {
      display: none;
    } */

    .grid-add-header-btn {
      min-width: 80px;
      padding: 8px;
      border-right: 1px solid var(--border-dark);
      background: var(--grid-header-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #6c7a57;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .grid-add-header-btn:hover {
      background: var(--grid-header-hover);
      color: var(--accent);
    }

    .grid-data-rows {
      display: flex;
      flex-direction: column;
    }

    .grid-data-row {
      display: flex;
      background: white;
      border-bottom: 1px solid var(--border);
      position: relative;
      min-width: fit-content;
    }

    .grid-data-row.selected {
      background: #fff4e6;
    }

    .grid-data-row-delete {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(180, 52, 41, 0.1);
      color: #b43429;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 15;
    }

    .grid-data-row:hover .grid-data-row-delete,
    .field-control .grid-panel-body .grid-data-row:hover .grid-data-row-delete,
    .field.field-grid-tab .grid-panel-body .grid-data-row:hover .grid-data-row-delete {
      opacity: 1;
    }

    .grid-data-row-delete:hover,
    .field-control .grid-panel-body .grid-data-row-delete:hover,
    .field.field-grid-tab .grid-panel-body .grid-data-row-delete:hover {
      background: rgba(180, 52, 41, 0.2);
    }

    .grid-data-cell {
      min-width: 100px;
      padding: 6px 12px;
      border-right: 1px solid var(--border);
      background: white;
      min-height: 32px;
      display: flex;
      align-items: center;
      cursor: text;
    }

    .grid-data-cell input {
      width: 100%;
      border: none !important;
      border-bottom: none !important;
      background: transparent;
      padding: 2px 4px;
      font-size: 0.9rem;
      outline: none;
      text-decoration: none !important;
    }

    .grid-data-cell input:focus {
      background: rgba(197, 106, 0, 0.05);
      border: none !important;
      border-bottom: none !important;
    }

    .grid-data-row.selected .grid-data-cell {
      background: #fff4e6;
    }

    .grid-add-row-btn {
      padding: 8px;
      text-align: center;
      background: rgba(255, 255, 255, 0.8);
      border-top: 1px solid var(--border);
      cursor: pointer;
      color: #6c7a57;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .grid-add-row-btn:hover {
      background: rgba(197, 106, 0, 0.1);
      color: var(--accent);
    }

    .field {
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 4px 0;
      box-shadow: none;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      min-height: auto;
      height: auto;
      align-self: start;
      position: relative;
    }

    .field.selected {
      background: rgba(197, 106, 0, 0.05);
    }

    .field.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .field.drag-over {
      border-top: 2px solid var(--accent);
      margin-top: 2px;
    }

    .field.selected .field-control input,
    .field.selected .field-control textarea,
    .field.selected .field-control select {
      border-bottom-color: var(--accent);
      border-bottom-width: 2px;
    }

    .field-delete {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(180, 52, 41, 0.1);
      color: #b43429;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
    }

    .field:hover .field-delete {
      opacity: 1;
    }

    .field-delete:hover {
      background: rgba(180, 52, 41, 0.2);
    }

    .field-label {
      min-width: 110px;
      font-size: 0.85rem;
      color: #475467;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }

    .field-label.required {
      color: #b43429;
    }

    /* 唯讀狀態：標題反灰 */
    .field-label.readonly,
    .field[data-readonly="true"] .field-label {
      color: #999;
      opacity: 0.6;
    }

    /* 欄位標題可編輯樣式 */
    .label-text {
      outline: none;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
      min-width: 60px;
      cursor: text;
    }

    .label-text:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .label-text:focus {
      background: rgba(197, 106, 0, 0.1);
      border: 1px solid var(--accent);
      padding: 1px 3px;
    }

    .label-text:empty::before {
      content: "未命名欄位";
      color: #9ca3af;
    }

    .field-control {
      flex: 1;
    }

    /* GRID 表格在欄位內時，確保樣式與 GRID 面板一致 */
    .field-control .grid-panel-body {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      background: var(--border);
      overflow-x: auto;
      overflow-y: auto;
      max-height: 600px;
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
    }

    /* [區塊面板(有頁籤)]頁籤內的 GRID 表格也要有卷軸 */
    .field.field-grid-tab .field-control {
      width: 100%;
      overflow: visible;
    }

    .field.field-grid-tab .grid-panel-body {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      background: var(--border);
      overflow-x: auto !important;
      overflow-y: auto !important;
      max-height: 600px;
      width: 100%;
      box-sizing: border-box;
    }

    /* GRID 表格：確保資料行右方沒有欄位時顯示底色 */
    .field-control .grid-panel-body .grid-data-row,
    .field.field-grid-tab .grid-panel-body .grid-data-row {
      background: white;
      position: relative;
      min-width: fit-content;
    }

    .field-control .grid-panel-body .grid-data-row::after,
    .field.field-grid-tab .grid-panel-body .grid-data-row::after {
      content: "";
      flex: 1;
      background: var(--border);
      min-height: 32px;
    }

    /* [區塊面板(有頁籤)]頁籤內的 GRID 表格：確保表頭行也有正確的寬度 */
    .field.field-grid-tab .grid-panel-body .grid-header-row {
      min-width: fit-content;
    }

    /* [區塊面板(有頁籤)]頁籤內的 GRID 表格：表頭行右方沒有欄位時顯示底色 */
    .field-control .grid-panel-body .grid-header-row::after,
    .field.field-grid-tab .grid-panel-body .grid-header-row::after {
      content: "";
      flex: 1;
      background: var(--grid-header-bg);
      min-height: 100%;
    }

    .field-control input,
    .field-control textarea,
    .field-control select {
      padding: 4px 0;
      border: none;
      border-bottom: 1px solid #d0d5dd;
      border-radius: 0;
      font-size: 0.95rem;
      width: 100%;
      background: transparent;
      height: auto;
      box-sizing: border-box;
    }

    /* 數值欄位：靠右對齊 */
    .field[data-type="number"] .field-control input {
      text-align: right;
    }

    /* 唯讀狀態：控件內容反灰 */
    .field-control.readonly input,
    .field-control.readonly textarea,
    .field-control.readonly select,
    .field[data-readonly="true"] .field-control input,
    .field[data-readonly="true"] .field-control textarea,
    .field[data-readonly="true"] .field-control select {
      color: #999;
      opacity: 0.6;
      cursor: not-allowed;
    }

    .field-control input:focus,
    .field-control textarea:focus,
    .field-control select:focus {
      outline: none;
      border-bottom-color: var(--accent);
      border-bottom-width: 2px;
    }

    /* GRID 表格內的 input 不要有底線 */
    .field-control .grid-panel-body .grid-data-cell input {
      border: none !important;
      border-bottom: none !important;
      text-decoration: none !important;
    }

    .field-control .grid-panel-body .grid-data-cell input:focus {
      border: none !important;
      border-bottom: none !important;
    }

    .field-control textarea {
      resize: vertical;
    }

    /* 多行備註欄位：顯示完整邊框 */
    .field[data-type="textarea"] .field-control textarea,
    .field[data-type="text"][data-row-height]:not([data-row-height="1"]) .field-control textarea {
      border: 1px solid #d0d5dd;
      border-radius: 6px;
      padding: 8px;
      background: white;
    }

    .field[data-type="textarea"] .field-control textarea:focus,
    .field[data-type="text"][data-row-height]:not([data-row-height="1"]) .field-control textarea:focus {
      outline: none;
      border-color: var(--accent);
      border-width: 2px;
    }

    .field.selected[data-type="textarea"] .field-control textarea,
    .field.selected[data-type="text"][data-row-height]:not([data-row-height="1"]) .field-control textarea {
      border-color: var(--accent);
      border-width: 2px;
    }

    /* 欄位本身的高度設定 */
    .field[data-row-height="1"] {
      min-height: 32px;
    }

    .field[data-row-height="2"] {
      min-height: 64px;
    }

    .field[data-row-height="3"] {
      min-height: 96px;
      align-items: flex-start;
    }

    .field[data-row-height="3"] .field-label {
      align-items: flex-start;
      padding-top: 4px;
    }

    .field[data-row-height="3"] .field-control {
      display: flex;
      align-items: flex-end;
    }

    .field[data-row-height="4"] {
      min-height: 128px;
      align-items: flex-start;
    }

    .field[data-row-height="4"] .field-label {
      align-items: flex-start;
      padding-top: 4px;
    }

    .field[data-row-height="4"] .field-control {
      display: flex;
      align-items: flex-end;
    }

    .field[data-row-height="5"] {
      min-height: 160px;
      align-items: flex-start;
    }

    .field[data-row-height="5"] .field-label {
      align-items: flex-start;
      padding-top: 4px;
    }

    .field[data-row-height="5"] .field-control {
      display: flex;
      align-items: flex-end;
    }

    /* textarea 的高度設定 */
    .field[data-row-height="1"] .field-control textarea {
      min-height: 24px;
      height: 24px;
    }

    .field[data-row-height="2"] .field-control textarea {
      min-height: 48px;
      height: 48px;
    }

    .field[data-row-height="3"] .field-control textarea {
      min-height: 72px;
      height: 72px;
    }

    .field[data-row-height="4"] .field-control textarea {
      min-height: 96px;
      height: 96px;
    }

    .field[data-row-height="5"] .field-control textarea {
      min-height: 120px;
      height: 120px;
    }

    .field-control select {
      height: auto;
      min-height: auto;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23475567' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right center;
      padding-right: 24px;
    }

    .field-control .field-button {
      border: 1px solid var(--button-border);
      border-radius: 8px;
      padding: 5px 20px;
      background: linear-gradient(to bottom, var(--button-bg-start), var(--button-bg-end));
      color: var(--button-text);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 4px var(--button-shadow);
      transition: all 0.2s ease;
      text-align: center;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 按鈕文字可編輯樣式 */
    .field-control .field-button[contenteditable="true"] {
      outline: none;
      min-height: 24px;
    }

    .field-control .field-button[contenteditable="true"]:hover {
      box-shadow: 0 2px 4px var(--button-shadow), inset 0 0 0 1px rgba(255, 255, 255, 0.2);
    }

    .field-control .field-button[contenteditable="true"]:focus {
      box-shadow: 0 2px 4px var(--button-shadow), inset 0 0 0 2px var(--accent);
      background: linear-gradient(to bottom, var(--button-hover-bg-start), var(--button-hover-bg-end));
    }

    .field-control .field-button[contenteditable="true"]:empty::before {
      content: "按鈕";
      color: rgba(0, 0, 0, 0.3);
    }

    /* 按鈕欄位：沒有 label，control 佔滿寬度 */
    .field.field-button {
      display: flex;
      align-items: center;
      gap: 0;
    }

    .field.field-button .field-control {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    /* 按鈕寬度控制 */
    .field.field-button[data-width="small"] .field-control .field-button {
      width: 120px;
      min-width: 80px;
      max-width: 100%;
    }

    .field.field-button[data-width="medium"] .field-control .field-button {
      width: 200px;
      min-width: 80px;
      max-width: 100%;
    }

    .field.field-button[data-width="full"] .field-control .field-button {
      width: 100%;
      min-width: 200px;
    }

    /* 按鈕寬度調整器 */
    .field.field-button .button-width-resizer {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: ew-resize;
      background: transparent;
      z-index: 10;
    }

    .field.field-button .button-width-resizer:hover {
      background: var(--accent);
    }

    .field.field-button .button-width-resizer.active {
      background: var(--accent);
    }

    .field.field-button .field-control {
      position: relative;
    }

    .field-control .field-button:hover {
      background: linear-gradient(to bottom, var(--button-hover-bg-start), var(--button-hover-bg-end));
      box-shadow: 0 3px 6px var(--button-hover-shadow);
      transform: translateY(-1px);
    }

    .field-control .field-button:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px var(--button-shadow);
    }

    .field.selected .field-control .field-button {
      box-shadow: 0 2px 6px rgba(197, 106, 0, 0.3);
      border-color: var(--accent);
    }

    /* 固定文字欄位：無框線、背景透明 */
    .field.field-fixedtext .field-control input {
      border: none !important;
      border-bottom: none !important;
      background: transparent !important;
      padding: 4px 0;
      box-shadow: none;
    }

    .field.field-fixedtext .field-control input:focus {
      outline: none;
      border: none !important;
      border-bottom: none !important;
    }

    .field.selected.field-fixedtext .field-control input {
      border: none !important;
      border-bottom: none !important;
    }

    .properties h2,
    .palette h2 {
      margin-top: 0;
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--header-dark);
    }

    .tool.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .tool.drag-over {
      border-top: 2px solid var(--accent);
    }

    .tool-drag-handle {
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c7a57;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
      pointer-events: auto;
    }

    .tool:hover .tool-drag-handle {
      opacity: 0.6;
    }

    .tool-drag-handle:hover {
      opacity: 1 !important;
      color: var(--accent);
    }

    .tool-drag-handle::before {
      content: "⋮⋮";
      font-size: 12px;
      line-height: 1;
      letter-spacing: -2px;
    }

    /* 換行處理 */
    .tool br {
      display: block;
      margin: 6px 0 0 0;
      line-height: 0;
      height: 0;
    }

    /* 描述文字樣式 - 預設同一行 */
    .tool > span {
      display: inline;
      font-size: 0.75rem;
      color: #8a9a6f;
      margin-left: 8px;
      font-weight: 400;
      letter-spacing: 0.1px;
    }

    /* 描述文字樣式 - 換行後（在 br 之後） */
    .tool br + span {
      display: block;
      margin-left: 0;
      margin-top: 6px;
      line-height: 1.5;
    }

    .palette-section {
      margin-bottom: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      background: var(--panel);
    }

    .palette-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: linear-gradient(90deg, var(--section-bg-start), var(--section-bg-end));
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--header-dark);
    }

    .palette-section-header:hover {
      background: linear-gradient(90deg, var(--palette-header-hover-start), var(--palette-header-hover-end));
    }

    .palette-section-toggle {
      width: 20px;
      height: 20px;
      border: none;
      background: transparent;
      font-size: 16px;
      font-weight: bold;
      color: var(--header-dark);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
    }

    .palette-section-toggle:hover {
      color: var(--accent);
    }

    .palette-section.collapsed .palette-section-toggle::after {
      content: "+";
    }

    .palette-section:not(.collapsed) .palette-section-toggle::after {
      content: "-";
    }

    .palette-section-body {
      padding: 8px;
      display: block;
    }

    .palette-section.collapsed .palette-section-body {
      display: none;
    }

    .properties form {
      display: flex;
      flex-direction: column;
      gap: 20px;
      font-size: 0.9rem;
    }

    .properties-section {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      background: var(--panel);
      margin-bottom: 20px;
    }

    .properties-section:last-child {
      margin-bottom: 0;
    }

    .properties-section-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: linear-gradient(90deg, var(--section-bg-start), var(--section-bg-end));
      border-bottom: 1px solid var(--border);
      user-select: none;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--header-dark);
    }

    .properties-section-body {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .properties label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: #475467;
      font-weight: 600;
    }

    /* Checkbox label 使用水平排列 */
    .properties label:has(input[type="checkbox"]) {
      flex-direction: row;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    /* Checkbox 樣式調整 */
    .properties input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
      cursor: pointer;
      flex-shrink: 0;
    }

    .properties input,
    .properties select,
    .properties textarea {
      border: 1px solid #d0d5dd;
      border-radius: 6px;
      padding: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      resize: vertical;
    }
    
    .properties textarea {
      min-height: 60px;
    }

    .empty-note {
      font-size: 0.85rem;
      color: #6f7e5a;
      margin-top: 8px;
    }

    .field[data-width="small"] {
      grid-column: span 1;
    }

    .field[data-width="medium"] {
      grid-column: span 2;
    }

    .field[data-width="full"] {
      grid-column: 1 / -1;
    }

    /* 空欄位樣式 */
    .field-empty {
      min-height: 32px;
    }

    .field-empty.selected {
      background: rgba(197, 106, 0, 0.05);
    }

    .toast {
      position: fixed;
      right: 24px;
      bottom: 24px;
      background: rgba(33, 42, 24, 0.95);
      color: white;
      padding: 12px 18px;
      border-radius: 999px;
      opacity: 0;
      transform: translateY(10px);
      transition: 0.2s ease;
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .preview-modal.show {
      display: flex;
    }

    .preview-modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
    }

    .preview-modal-content {
      position: relative;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 1200px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      z-index: 1001;
    }

    /* 範本模態視窗可調整寬度和高度 */
    #template-modal-content {
      resize: both;
      overflow: auto;
      width: 900px;
      height: 600px;
      min-width: 600px;
      min-height: 400px;
      max-width: 95vw;
      max-height: 95vh;
    }

    /* 調整大小時的視覺提示 */
    #template-modal-content::-webkit-resizer {
      background: var(--border);
      border-radius: 0 0 12px 0;
    }

    .preview-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, var(--section-bg-start), var(--section-bg-end));
      border-radius: 12px 12px 0 0;
    }

    .preview-modal-header h2 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--header-dark);
    }

    .preview-modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(180, 52, 41, 0.1);
      color: #b43429;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .preview-modal-close:hover {
      background: rgba(180, 52, 41, 0.2);
    }

    .preview-modal-body {
      padding: 24px;
      overflow: auto;
      flex: 1;
      background: var(--bg);
    }

    .preview-content {
      background: var(--preview-bg);
      padding: 24px;
      border-radius: 8px;
      min-height: 200px;
    }

    /* 預覽模式：功能標題樣式（一致且粗體） */
    .preview-content .doc-title-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: #233018;
      padding: 8px 0;
      margin: 0;
      line-height: 1.5;
    }

    /* 範本列表樣式 */
    .template-item {
      padding: 12px 16px;
      margin-bottom: 8px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .template-item:hover {
      background: var(--tool-hover-bg);
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .template-item-name {
      font-weight: 600;
      color: var(--header-dark);
    }

    .template-item-size {
      font-size: 0.875rem;
      color: #666;
    }

    /* 預覽模式：面板樣式 */
    .preview-content .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      position: relative;
    }

    /* 預覽模式：面板標題列樣式 */
    .preview-content .panel-header {
      background: linear-gradient(90deg, var(--section-bg-start), var(--section-bg-end));
      border-bottom: 1px solid var(--border);
    }

    /* 預覽模式：頁籤樣式 */
    .preview-content .panel-tabs {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 8px 0 8px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .preview-content .panel-tab {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      font-size: 0.9rem;
      font-weight: 600;
      color: #4b5a35;
      position: relative;
    }

    .preview-content .panel-tab.active {
      background: var(--panel);
      border-color: var(--accent);
      border-bottom-color: var(--panel);
      border-width: 2px;
      color: var(--header-dark);
      z-index: 1;
      margin-bottom: -1px;
      box-shadow: 0 -2px 8px rgba(197, 106, 0, 0.2);
      font-weight: 700;
      transform: translateY(-1px);
    }

    .preview-content .panel-tab-text {
      display: inline-block;
    }

    .preview-content .panel-body {
      display: grid;
      grid-template-columns: repeat(var(--column-count, 3), 1fr);
      align-items: start;
      gap: 4px;
      padding: 8px 16px;
    }

    .preview-content .tab-body {
      display: grid;
      grid-template-columns: repeat(var(--column-count, 3), 1fr);
      align-items: start;
      gap: 4px;
      padding: 8px 16px;
    }

    .preview-content .tab-body:not(.active) {
      display: none;
    }

    .preview-content .tab-body.active {
      display: grid;
    }

    .preview-content .field {
      display: flex;
      align-items: center;
      gap: 16px;
      align-self: start;
      height: auto;
    }

    .preview-content .field[data-width="small"] {
      grid-column: span 1;
    }

    .preview-content .field[data-width="medium"] {
      grid-column: span 2;
    }

    .preview-content .field[data-width="full"] {
      grid-column: 1 / -1;
    }

    .preview-content .field-label {
      min-width: 110px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .preview-content .field-control {
      flex: 1;
    }

    /* 預覽模式：GRID 表格在欄位內時，確保樣式與 GRID 面板一致 */
    .preview-content .field-control .grid-panel-body {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      background: var(--border);
      overflow-x: auto;
      overflow-y: auto;
      max-height: 600px;
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
    }

    /* 預覽模式：[區塊面板(有頁籤)]頁籤內的 GRID 表格也要有卷軸 */
    .preview-content .field.field-grid-tab .field-control {
      width: 100%;
      overflow: visible;
    }

    .preview-content .field.field-grid-tab .grid-panel-body {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      background: var(--border);
      overflow-x: auto !important;
      overflow-y: auto !important;
      max-height: 600px;
      width: 100%;
      box-sizing: border-box;
    }

    /* 預覽模式：GRID 表格：確保資料行右方沒有欄位時顯示底色 */
    .preview-content .field-control .grid-panel-body .grid-data-row,
    .preview-content .field.field-grid-tab .grid-panel-body .grid-data-row {
      background: white;
      min-width: fit-content;
    }

    .preview-content .field-control .grid-panel-body .grid-data-row::after,
    .preview-content .field.field-grid-tab .grid-panel-body .grid-data-row::after {
      content: "";
      flex: 1;
      background: var(--border);
      min-height: 32px;
    }

    /* 預覽模式：[區塊面板(有頁籤)]頁籤內的 GRID 表格：確保表頭行也有正確的寬度 */
    .preview-content .field.field-grid-tab .grid-panel-body .grid-header-row {
      min-width: fit-content;
    }

    /* 預覽模式：[區塊面板(有頁籤)]頁籤內的 GRID 表格：表頭行右方沒有欄位時顯示底色 */
    .preview-content .field-control .grid-panel-body .grid-header-row::after,
    .preview-content .field.field-grid-tab .grid-panel-body .grid-header-row::after {
      content: "";
      flex: 1;
      background: var(--grid-header-bg);
      min-height: 100%;
    }

    .preview-content .field-control input,
    .preview-content .field-control select {
      padding: 4px 0;
      border: none;
      border-bottom: 1px solid #d0d5dd;
      border-radius: 0;
      background: transparent;
    }

    /* 登入畫面樣式 */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--section-bg-start) 0%, var(--section-bg-end) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .login-container {
      background: var(--panel);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      padding: 48px 40px;
      width: 100%;
      max-width: 420px;
      border: 1px solid var(--border);
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-icon {
      width: 64px;
      height: 64px;
      color: var(--header);
      margin-bottom: 16px;
    }

    .login-header h1 {
      font-size: 24px;
      font-weight: 600;
      color: var(--header);
      margin: 0;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .login-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .login-field label {
      font-size: 14px;
      font-weight: 500;
      color: var(--header-dark);
    }

    .login-field input {
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 16px;
      background: var(--panel);
      color: var(--header-dark);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .login-field input:focus {
      outline: none;
      border-color: var(--header);
      box-shadow: 0 0 0 3px rgba(78, 106, 58, 0.1);
    }

    .login-field input::placeholder {
      color: #999;
    }

    .login-error {
      padding: 12px 16px;
      background: #fee;
      border: 1px solid #fcc;
      border-radius: 6px;
      color: #c33;
      font-size: 14px;
      text-align: center;
    }

    .login-submit-btn {
      padding: 14px 24px;
      background: linear-gradient(135deg, var(--header-gradient-start) 0%, var(--header-gradient-end) 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 8px;
    }

    .login-submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(78, 106, 58, 0.3);
    }

    .login-submit-btn:active {
      transform: translateY(0);
    }

    .login-submit-btn .btn-icon {
      width: 20px;
      height: 20px;
    }

    .main-app {
      width: 100%;
      height: 100%;
    }

    /* 預覽模式：數值欄位靠右對齊 */
    .preview-content .field[data-type="number"] .field-control input,
    .preview-content .field[data-type="number"] .field-control input.number-input {
      text-align: right !important;
    }

    /* 預覽模式：唯讀狀態標題反灰 */
    .preview-content .field-label.readonly,
    .preview-content .field[data-readonly="true"] .field-label {
      color: #999;
      opacity: 0.6;
    }

    /* 預覽模式：唯讀狀態控件內容反灰 */
    .preview-content .field-control.readonly input,
    .preview-content .field-control.readonly textarea,
    .preview-content .field-control.readonly select,
    .preview-content .field[data-readonly="true"] .field-control input,
    .preview-content .field[data-readonly="true"] .field-control textarea,
    .preview-content .field[data-readonly="true"] .field-control select {
      color: #999;
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* 預覽模式：GRID 表格內的 input 不要有底線 */
    .preview-content .field-control .grid-panel-body .grid-data-cell input {
      border: none !important;
      border-bottom: none !important;
      text-decoration: none !important;
    }

    /* 預覽模式：GRID 表格內的數值欄位靠右對齊 */
    .preview-content .field-control .grid-panel-body .grid-data-cell[data-type="number"] input,
    .preview-content .field-control .grid-panel-body .grid-data-cell input.number-input {
      text-align: right !important;
    }

    /* 預覽模式：所有 textarea 欄位顯示完整邊框 */
    .preview-content .field-control textarea {
      border: 1px solid #d0d5dd !important;
      border-radius: 6px !important;
      padding: 8px !important;
      background: white !important;
    }

    .preview-content .field-control .field-button {
      border: 1px solid var(--button-border);
      border-radius: 8px;
      padding: 5px 20px;
      background: linear-gradient(to bottom, var(--button-bg-start), var(--button-bg-end));
      color: var(--button-text);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 4px var(--button-shadow);
      text-align: center;
      width: 100%;
    }

    .preview-content .field.field-button {
      display: flex;
      align-items: center;
      gap: 0;
    }

    .preview-content .field.field-button .field-control {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .preview-content .field.field-button[data-width="small"] .field-control .field-button {
      width: 120px;
      min-width: 80px;
      max-width: 100%;
    }

    .preview-content .field.field-button[data-width="medium"] .field-control .field-button {
      width: 200px;
      min-width: 80px;
      max-width: 100%;
    }

    .preview-content .field.field-button[data-width="full"] .field-control .field-button {
      width: 100%;
      min-width: 200px;
    }

    /* 預覽模式：固定文字欄位 */
    .preview-content .field.field-fixedtext .field-control input {
      border: none !important;
      border-bottom: none !important;
      background: transparent !important;
      padding: 4px 0;
      box-shadow: none;
    }

    .preview-content .grid-panel-body {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      background: var(--border);
      overflow-x: auto;
      overflow-y: auto;
      max-height: 600px;
      max-width: 100%;
    }

    .preview-content .grid-header-row {
      display: flex;
      background: var(--grid-header-bg);
      border-bottom: 2px solid var(--border-dark);
      position: sticky;
      top: 0;
      min-width: fit-content;
      z-index: 10;
    }

    /* 預覽模式：GRID 表頭行：右方沒有欄位時顯示底色 */
    .preview-content .grid-header-row::after {
      content: "";
      flex: 1;
      background: var(--grid-header-bg);
      min-height: 100%;
    }

    .preview-content .grid-header-cell {
      position: relative;
      min-width: 100px;
      padding: 8px 12px;
      border-right: 1px solid var(--border-dark);
      background: var(--grid-header-bg);
    }

    .preview-content .grid-header-cell .grid-col-resizer {
      position: absolute;
      right: -2px;
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: col-resize;
      background: transparent;
      z-index: 20;
    }

    .preview-content .grid-header-cell .grid-col-resizer:hover {
      background: var(--accent);
      opacity: 0.6;
    }

    .preview-content .grid-header-cell .grid-col-resizer.active {
      background: var(--accent);
      opacity: 1;
    }

    /* 最後一欄也可以調整欄寬 */
    /* .preview-content .grid-header-cell:last-child .grid-col-resizer {
      display: none;
    } */

    .preview-content .field-control .grid-panel-body .grid-header-cell,
    .preview-content .field.field-grid-tab .grid-panel-body .grid-header-cell {
      position: relative;
      min-width: 100px;
      padding: 8px 12px;
      border-right: 1px solid var(--border-dark);
      background: var(--grid-header-bg);
      font-weight: 600;
      font-size: 0.9rem;
      color: #2a371d;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preview-content .grid-header-cell .header-title {
      flex: 1;
      text-align: center;
      padding: 2px 4px;
      border-radius: 2px;
      min-height: 20px;
    }

    .preview-content .grid-header-cell .header-title.required {
      color: #b43429;
    }

    .preview-content .grid-data-rows {
      display: flex;
      flex-direction: column;
    }

    .preview-content .grid-data-row {
      display: flex;
      background: var(--preview-grid-row-bg);
      border-bottom: 1px solid var(--border);
      position: relative;
      min-width: fit-content;
    }

    .preview-content .grid-data-row-delete {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(180, 52, 41, 0.1);
      color: #b43429;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 15;
    }

    .preview-content .grid-data-row:hover .grid-data-row-delete {
      opacity: 1;
    }

    .preview-content .grid-data-row-delete:hover {
      background: rgba(180, 52, 41, 0.2);
    }

    .preview-content .grid-data-cell {
      min-width: 100px;
      padding: 6px 12px;
      border-right: 1px solid var(--border);
      background: white; /* 與編輯模式一致 */
      min-height: 32px;
      display: flex;
      align-items: center;
    }

    .preview-content .grid-data-cell input {
      width: 100%;
      border: none !important;
      border-bottom: none !important;
      background: transparent;
      padding: 2px 4px;
      font-size: 0.9rem;
      outline: none;
      text-decoration: none !important;
    }

    /* 欄位規格彈窗樣式 */
    .field-spec-modal-btn {
      padding: 4px 12px;
      font-size: 0.85rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      margin-left: auto;
    }

    .field-spec-modal-btn:hover:not(:disabled) {
      background: #a85a00;
    }

    .field-spec-modal-btn:disabled {
      background: #d0d5dd;
      color: #9ca3af;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .properties-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .field-spec-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .field-spec-modal.show {
      display: flex;
    }

    .field-spec-modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
    }

    .field-spec-modal-content {
      position: relative;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      z-index: 1001;
    }

    .field-spec-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, #eff5e3, #dde7cc);
      border-radius: 12px 12px 0 0;
    }

    .field-spec-modal-header h2 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--header-dark);
    }

    .field-spec-modal-field-title {
      font-weight: 800;
      font-size: 1.35rem;
      color: var(--accent);
      margin-right: 10px;
      padding: 4px 12px;
      background: rgba(197, 106, 0, 0.1);
      border-radius: 6px;
      display: inline-block;
      border: 2px solid rgba(197, 106, 0, 0.3);
    }

    .field-spec-modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(180, 52, 41, 0.1);
      color: #b43429;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .field-spec-modal-close:hover {
      background: rgba(180, 52, 41, 0.2);
    }

    .field-spec-modal-body {
      padding: 24px;
      overflow: auto;
      flex: 1;
      background: var(--bg);
    }

    .field-spec-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .field-spec-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field-spec-row label {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field-spec-label {
      font-weight: 600;
      color: var(--header-dark);
      font-size: 0.95rem;
    }

    .field-spec-row input[type="text"],
    .field-spec-row select {
      padding: 10px 12px;
      border: 1px solid #d0d5dd;
      border-radius: 6px;
      font-size: 1rem;
      background: white;
      transition: border-color 0.2s;
    }

    .field-spec-row input[type="text"]:focus,
    .field-spec-row select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(197, 106, 0, 0.1);
    }

    .field-spec-row textarea {
      padding: 12px;
      border: 1px solid #d0d5dd;
      border-radius: 6px;
      font-size: 1rem;
      background: white;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
      transition: border-color 0.2s;
    }

    .field-spec-row textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(197, 106, 0, 0.1);
    }

    .field-spec-checkboxes {
      flex-direction: row;
      flex-wrap: wrap;
      gap: 16px;
    }

    .field-spec-checkbox-label {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .field-spec-checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .field-spec-checkbox-label span {
      font-weight: 500;
      color: var(--header-dark);
    }

    .field-spec-textarea-row textarea {
      min-height: 120px;
    }

    .field-spec-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      background: white;
      border-radius: 0 0 12px 12px;
    }

    .field-spec-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .field-spec-btn-cancel {
      background: #f3f4f6;
      color: #374151;
    }

    .field-spec-btn-cancel:hover {
      background: #e5e7eb;
    }

    .field-spec-btn-save {
      background: var(--accent);
      color: white;
    }

    .field-spec-btn-save:hover {
      background: #a85a00;
    }

    /* 欄位規格預覽彈窗 */
    .field-spec-preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .field-spec-preview-modal.show {
      display: flex;
    }

    .field-spec-preview-modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
    }

    .field-spec-preview-modal-content {
      position: relative;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 24px 80px rgba(0, 0, 0, 0.15), 0 8px 24px rgba(0, 0, 0, 0.1);
      width: 95%;
      max-width: 1400px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      z-index: 1001;
      overflow: hidden;
    }

    .field-spec-preview-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 32px;
      border-bottom: 2px solid #e5e7eb;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border-radius: 16px 16px 0 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .field-spec-preview-modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      letter-spacing: -0.02em;
    }

    .field-spec-preview-modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .field-spec-preview-modal-close:hover {
      background: rgba(180, 52, 41, 0.2);
    }

    .field-spec-preview-modal-body {
      padding: 32px;
      overflow: auto;
      flex: 1;
      background: #f9fafb;
    }

    /* 表格樣式 */
    .field-spec-preview-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 48px;
      font-size: 0.875rem;
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06);
    }

    .field-spec-preview-table caption {
      text-align: left;
      font-size: 1.125rem;
      font-weight: 700;
      padding: 16px 20px;
      margin-bottom: 0;
      color: #dc2626;
      background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%);
      border-bottom: 3px solid #1f2937;
      letter-spacing: -0.01em;
    }

    .field-spec-preview-table th,
    .field-spec-preview-table td {
      padding: 14px 16px;
      text-align: left;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
    }

    .field-spec-preview-table th:last-child,
    .field-spec-preview-table td:last-child {
      border-right: none;
    }

    .field-spec-preview-table thead {
      background: linear-gradient(135deg, #DDEBF7 0%, #C5DDF0 100%);
    }

    .field-spec-preview-table th {
      background: transparent;
      font-weight: 600;
      color: #1e3a5f;
      white-space: nowrap;
      font-size: 0.875rem;
      letter-spacing: 0.01em;
    }

    .field-spec-preview-table tbody tr:last-child td {
      border-bottom: none;
    }

    .field-spec-preview-table td {
      background: #ffffff;
      color: #1f2937;
      transition: background-color 0.15s ease;
    }

    .field-spec-preview-table tbody tr:nth-child(even) td {
      background: #f8fafc;
    }

    .field-spec-preview-table tbody tr:hover td {
      background: #E8F2FA;
    }

    .field-spec-preview-table tbody tr:hover {
      box-shadow: inset 3px 0 0 #8BB4D8;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  <script>
    // 確認 xlsx-js-style 已載入
    (function() {
      if (typeof XLSX !== 'undefined') {
        window._xlsxStyleLoaded = true;
        console.log('xlsx-js-style loaded successfully');
      } else {
        window._xlsxStyleLoaded = false;
        console.error('xlsx-js-style failed to load');
      }
    })();
  </script>
</head>
<body>
  <!-- 登入畫面 -->
  <div id="login-screen" class="login-screen">
    <div class="login-container">
      <div class="login-header">
        <svg class="login-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 6C4 4.89543 4.89543 4 6 4H18C19.1046 4 20 4.89543 20 6V18C20 19.1046 19.1046 20 18 20H6C4.89543 20 4 19.1046 4 18V6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M8 8H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M8 12H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M8 16H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h1>ERP畫面輔助產生器</h1>
      </div>
      <form id="login-form" class="login-form">
        <div class="login-field">
          <label for="login-username">帳號</label>
          <input 
            type="text" 
            id="login-username" 
            name="username" 
            placeholder="員工編號" 
            required 
            autocomplete="username"
          />
        </div>
        <div class="login-field">
          <label for="login-password">密碼</label>
          <input 
            type="password" 
            id="login-password" 
            name="password" 
            placeholder="請輸入密碼" 
            required 
            autocomplete="current-password"
          />
        </div>
        <div id="login-error" class="login-error" style="display: none;">
          帳號或密碼錯誤，請重新輸入
        </div>
        <button type="submit" class="login-submit-btn">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <polyline points="10 17 15 12 10 7"></polyline>
            <line x1="15" y1="12" x2="3" y2="12"></line>
          </svg>
          登入
        </button>
      </form>
    </div>
  </div>

  <!-- 主畫面容器（初始隱藏） -->
  <div id="main-app" class="main-app" style="display: none;">
  <header>
    <h1>
      <svg class="header-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 6C4 4.89543 4.89543 4 6 4H18C19.1046 4 20 4.89543 20 6V18C20 19.1046 19.1046 20 18 20H6C4.89543 20 4 19.1046 4 18V6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M8 8H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M8 12H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M8 16H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M4 6H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      畫面輔助產生器
      <span class="version-display">v251204-3</span>
    </h1>
    <button id="btn-preview" class="primary">
      <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
      畫面預覽
    </button>
    <button id="btn-export" class="primary">
      <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      規格預覽
    </button>
    <button id="btn-clear">
      <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
      清空畫布
    </button>
    <button id="btn-save" disabled>
      <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
        <polyline points="17 21 17 13 7 13 7 21"></polyline>
        <polyline points="7 3 7 8 15 8"></polyline>
      </svg>
      存檔
    </button>
    <button id="btn-save-layout">
      <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
        <polyline points="17 21 17 13 7 13 7 21"></polyline>
        <polyline points="7 3 7 8 15 8"></polyline>
        <line x1="12" y1="10" x2="12" y2="16"></line>
        <line x1="9" y1="13" x2="15" y2="13"></line>
      </svg>
      另存新檔
    </button>
    <button id="btn-load-layout">
      <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
        <path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2z"></path>
      </svg>
      開啟舊檔
    </button>
    <button id="btn-load-template">
      <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      載入範本
    </button>
    <button id="btn-logout" style="margin-left: auto;">
      <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
      登出
    </button>
    <input id="input-load-layout" type="file" accept="application/json" hidden />
    <label class="column-picker">
      預設欄數
      <select id="column-count">
        <option value="3">3 欄</option>
        <option value="4">4 欄</option>
        <option value="5">5 欄</option>
      </select>
    </label>
    <div class="theme-switcher">
      <span class="theme-label">主題色系：</span>
      <div class="theme-buttons">
        <button class="theme-btn" data-theme="green" title="NBS">NBS</button>
        <button class="theme-btn" data-theme="blue" title="T9">T9</button>
        <button class="theme-btn" data-theme="orange" title="T8">T8</button>
      </div>
    </div>
  </header>
  <main class="layout">
    <aside class="palette">
      <h2>欄位工具</h2>
      
      <!-- 區帶區域 -->
      <div class="palette-section">
        <div class="palette-section-header" data-section="panels">
          <span>區帶</span>
          <button class="palette-section-toggle" aria-label="收合/展開">-</button>
        </div>
        <div class="palette-section-body" id="palette-panels">
          <div class="tool" draggable="true" data-type="panel-no-tabs">
            <div class="tool-drag-handle" draggable="true"></div>
            區塊面板(無頁籤)<br><span>無頁籤的容器</span>
          </div>
          <div class="tool" draggable="true" data-type="panel">
            <div class="tool-drag-handle" draggable="true"></div>
            區塊面板(有頁籤)<br><span>建立容器後才能放欄位</span>
          </div>
          <div class="tool" draggable="true" data-type="grid-panel">
            <div class="tool-drag-handle" draggable="true"></div>
            GRID 面板<br><span>表格容器，預設4列</span>
          </div>
        </div>
      </div>

      <!-- 資料欄位區域 -->
      <div class="palette-section">
        <div class="palette-section-header" data-section="fields">
          <span>資料欄位</span>
          <button class="palette-section-toggle" aria-label="收合/展開">-</button>
        </div>
        <div class="palette-section-body" id="palette-fields">
          <div class="tool" draggable="true" data-type="text">
            <div class="tool-drag-handle" draggable="true"></div>
            單行文字 <span>客戶、單號</span>
          </div>
          <div class="tool" draggable="true" data-type="number">
            <div class="tool-drag-handle" draggable="true"></div>
            數值欄位 <span>數量、金額</span>
          </div>
          <div class="tool" draggable="true" data-type="date">
            <div class="tool-drag-handle" draggable="true"></div>
            日期欄位 <span>下單日</span>
          </div>
          <div class="tool" draggable="true" data-type="select">
            <div class="tool-drag-handle" draggable="true"></div>
            下拉選單 <span>狀態</span>
          </div>
          <div class="tool" draggable="true" data-type="textarea">
            <div class="tool-drag-handle" draggable="true"></div>
            多行備註 <span>備註說明</span>
          </div>
          <div class="tool" draggable="true" data-type="empty">
            <div class="tool-drag-handle" draggable="true"></div>
            空欄位 <span>空白佔位</span>
          </div>
          <div class="tool" draggable="true" data-type="button">
            <div class="tool-drag-handle" draggable="true"></div>
            按鈕 <span>按鈕控件</span>
          </div>
          <div class="tool" draggable="true" data-type="fixedtext">
            <div class="tool-drag-handle" draggable="true"></div>
            固定文字 <span>固定顯示文字</span>
          </div>
        </div>
      </div>
      
      <p class="empty-note">先新增區塊，再把欄位拖曳進容器中。</p>
    </aside>
    <section id="canvas" class="canvas" aria-live="polite">
      <div class="doc-title-row">
        <input id="document-title" type="text" value="銷售訂單" placeholder="請輸入單據標題" />
      </div>
      <div id="canvas-placeholder" class="placeholder">
        拖曳左側「區塊面板」至此開始設計單據版面
      </div>
    </section>
    <aside class="properties">
      <h2>欄位屬性</h2>
      <form id="field-properties">
        <!-- 快速排版區塊 -->
        <div class="properties-section">
          <div class="properties-section-header">
            <span>快速排版</span>
          </div>
          <div class="properties-section-body">
        <label>
          標題
          <input id="prop-label" type="text" placeholder="例如：客戶名稱" />
        </label>
            <label>
              DB欄位名稱(Eng)
              <input id="prop-db-field" type="text" placeholder="例如：X_customer" />
        </label>
        <label>
          欄寬
          <select id="prop-width">
            <option value="small">小 (跨 1 欄)</option>
            <option value="medium">中 (跨 2 欄)</option>
            <option value="full">全寬</option>
          </select>
        </label>
        <label>
          列高
          <select id="prop-row-height">
            <option value="1">1 列</option>
            <option value="2">2 列</option>
            <option value="3">3 列</option>
            <option value="4">4 列</option>
            <option value="5">5 列</option>
          </select>
        </label>
        <label id="prop-text-color-label" style="display: none;">
          文字顏色
          <input id="prop-text-color" type="color" value="#233018" />
        </label>
          </div>
        </div>
        <!-- 欄位規格區塊 -->
        <div class="properties-section">
          <div class="properties-section-header">
            <span>欄位規格</span>
            <button type="button" id="btn-field-spec-modal" class="field-spec-modal-btn" title="開窗設定">開窗設定</button>
          </div>
          <div class="properties-section-body">
            <label>
              長度
              <input id="prop-length" type="text" placeholder="N/A" value="N/A" />
            </label>
            <label>
              類型
              <select id="prop-field-type">
                <option value="real" selected>實欄位</option>
                <option value="virtual">虛欄位</option>
                <option value="relation">關聯欄位</option>
          </select>
        </label>
        <label>
          預設值
          <input id="prop-default" type="text" placeholder="預設值" />
        </label>
        <label>
          <input id="prop-required" type="checkbox" />
          必填
        </label>
            <label>
              <input id="prop-readonly" type="checkbox" />
              唯讀
            </label>
            <label>
              <input id="prop-primary-key" type="checkbox" />
              主鍵
            </label>
            <label>
              下拉選項
              <input id="prop-select-options" type="text" placeholder="選項1;選項2;選項3" />
            </label>
            <label>
              關聯功能 / 關聯欄位 / 返回欄位
              <textarea id="prop-relation-field" placeholder="關聯功能(T-Code):&#10;關聯欄位:&#10;返回欄位:" rows="3"></textarea>
            </label>
            <label>
              其他說明
              <textarea id="prop-other-note" placeholder="N/A" rows="5">N/A</textarea>
            </label>
          </div>
        </div>
      </form>
      <!-- 區塊屬性區塊 -->
      <div class="properties-section" id="panel-properties-section" style="display: none;">
        <div class="properties-section-header">
          <span>區塊屬性</span>
        </div>
        <div class="properties-section-body">
          <form id="panel-properties">
        <label>
              資料表識別
              <select id="prop-panel-table-id">
                <option value="A">A 表</option>
                <option value="B">B 表</option>
                <option value="C">C 表</option>
                <option value="D">D 表</option>
                <option value="E">E 表</option>
                <option value="custom">其他</option>
          </select>
              <input type="text" id="prop-panel-table-id-custom" placeholder="請輸入資料表識別" style="display: none; margin-top: 6px;" />
            </label>
            <label>
              關聯的父表
              <select id="prop-panel-parent-table">
                <option value="" selected>N/A</option>
                <option value="A">A 表</option>
                <option value="B">B 表</option>
                <option value="C">C 表</option>
                <option value="D">D 表</option>
                <option value="E">E 表</option>
                <option value="custom">其他</option>
              </select>
              <input type="text" id="prop-panel-parent-table-custom" placeholder="請輸入關聯的父表" style="display: none; margin-top: 6px;" />
            </label>
            <label>
              DB 資料表名(Eng)
              <input id="prop-panel-db-table" type="text" placeholder="例如：X_customer不知道請留空" />
        </label>
            <label id="prop-panel-tab-title-label" style="display: none;">
              頁籤標題
              <input id="prop-panel-tab-title" type="text" placeholder="例如：基本資料" />
        </label>
      </form>
        </div>
      </div>
      <p class="empty-note">先選取欄位或區塊，再調整屬性。</p>
    </aside>
  </main>
  <div id="toast" class="toast">已複製到剪貼簿</div>
  <div id="preview-modal" class="preview-modal">
    <div class="preview-modal-overlay"></div>
    <div class="preview-modal-content">
      <div class="preview-modal-header">
        <h2>HTML 預覽</h2>
        <button class="preview-modal-close" aria-label="關閉">×</button>
      </div>
      <div class="preview-modal-body">
        <div id="preview-content" class="preview-content"></div>
      </div>
    </div>
  </div>
  <div id="field-spec-modal" class="field-spec-modal">
    <div class="field-spec-modal-overlay"></div>
    <div class="field-spec-modal-content">
      <div class="field-spec-modal-header">
        <h2><span class="field-spec-modal-field-title"></span>欄位規格設定</h2>
        <button class="field-spec-modal-close" aria-label="關閉">×</button>
      </div>
      <div class="field-spec-modal-body">
        <form id="field-spec-form" class="field-spec-form">
          <div class="field-spec-row">
            <label>
              <span class="field-spec-label">長度</span>
              <input type="text" id="modal-prop-length" placeholder="N/A" />
            </label>
          </div>
          <div class="field-spec-row">
            <label>
              <span class="field-spec-label">類型</span>
              <select id="modal-prop-field-type">
                <option value="real">實欄位</option>
                <option value="virtual">虛欄位</option>
                <option value="relation">關聯欄位</option>
              </select>
            </label>
          </div>
          <div class="field-spec-row">
            <label>
              <span class="field-spec-label">預設值</span>
              <input type="text" id="modal-prop-default" placeholder="預設值" />
            </label>
          </div>
          <div class="field-spec-row field-spec-checkboxes">
            <label class="field-spec-checkbox-label">
              <input type="checkbox" id="modal-prop-required" />
              <span>必填</span>
            </label>
            <label class="field-spec-checkbox-label">
              <input type="checkbox" id="modal-prop-readonly" />
              <span>唯讀</span>
            </label>
            <label class="field-spec-checkbox-label">
              <input type="checkbox" id="modal-prop-primary-key" />
              <span>主鍵</span>
            </label>
          </div>
          <div class="field-spec-row field-spec-textarea-row">
            <label>
              <span class="field-spec-label">下拉選項</span>
              <textarea id="modal-prop-select-options" placeholder="選項1;選項2;選項3" rows="4"></textarea>
            </label>
          </div>
          <div class="field-spec-row field-spec-textarea-row">
            <label>
              <span class="field-spec-label">關聯功能 / 關聯欄位 / 返回欄位</span>
              <textarea id="modal-prop-relation-field" placeholder="關聯功能(T-Code):&#10;關聯欄位:&#10;返回欄位:" rows="4"></textarea>
            </label>
          </div>
          <div class="field-spec-row field-spec-textarea-row">
            <label>
              <span class="field-spec-label">其他說明</span>
              <textarea id="modal-prop-other-note" placeholder="N/A" rows="6"></textarea>
            </label>
          </div>
        </form>
      </div>
      <div class="field-spec-modal-footer">
        <button type="button" class="field-spec-btn field-spec-btn-cancel" id="field-spec-modal-cancel">取消</button>
        <button type="button" class="field-spec-btn field-spec-btn-save" id="field-spec-modal-save">儲存</button>
      </div>
    </div>
  </div>
  <div id="field-spec-preview-modal" class="field-spec-preview-modal">
    <div class="field-spec-preview-modal-overlay"></div>
    <div class="field-spec-preview-modal-content">
      <div class="field-spec-preview-modal-header">
        <h2>欄位規格預覽</h2>
        <div style="display: flex; align-items: center; gap: 12px;">
          <button id="btn-export-spec-excel" class="btn-export-excel" style="padding: 8px 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);" onmouseover="this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.4)'; this.style.transform='translateY(-1px)';" onmouseout="this.style.boxShadow='0 2px 4px rgba(16, 185, 129, 0.3)'; this.style.transform='translateY(0)';" onmousedown="this.style.transform='translateY(0)';" onmouseup="this.style.transform='translateY(-1px)';">匯出 Excel</button>
        <button class="field-spec-preview-modal-close" aria-label="關閉">×</button>
        </div>
      </div>
      <div class="field-spec-preview-modal-body" id="field-spec-preview-content">
        <!-- 表格內容將在這裡動態生成 -->
      </div>
    </div>
  </div>
  <div id="template-modal" class="preview-modal">
    <div class="preview-modal-overlay"></div>
    <div id="template-modal-content" class="preview-modal-content">
      <div class="preview-modal-header">
        <h2>載入範本</h2>
        <button class="preview-modal-close" aria-label="關閉">×</button>
      </div>
      <div class="preview-modal-body" style="display: flex; gap: 16px;">
        <div style="flex: 0 0 300px; min-width: 250px;">
          <div style="margin-bottom: 16px;">
            <button id="btn-select-template-folder" style="padding: 8px 16px; background: linear-gradient(135deg, var(--accent) 0%, var(--header-dark) 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 600; width: 100%;">
              選擇範本資料夾
            </button>
            <p id="template-folder-path" style="margin-top: 8px; color: #666; font-size: 0.875rem;"></p>
            <button id="btn-generate-template-list" style="padding: 8px 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 600; width: 100%; margin-top: 8px; display: none;">
              產生檔案list
            </button>
          </div>
          <div id="template-list" style="max-height: 500px; overflow-y: auto;">
            <p style="text-align: center; color: #999; padding: 32px;">請先選擇範本資料夾</p>
          </div>
        </div>
        <div style="flex: 1; border-left: 1px solid var(--border); padding-left: 16px; min-width: 300px; display: flex; flex-direction: column; min-height: 0;">
          <div id="template-preview-container" style="flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden;">
            <p style="text-align: center; color: #999; padding: 32px;">請選擇範本檔案以預覽</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const fieldTemplates = {
      text(label = "客戶名稱", placeholder = "請輸入內容") {
        return `<input type="text" placeholder="${placeholder}" />`;
      },
      number(label = "數量", placeholder = "0") {
        return `<input type="text" class="number-input" placeholder="${placeholder}" inputmode="numeric" />`;
      },
      date() {
        return `<input type="date" />`;
      },
      select() {
        return `<select>
            <option value="">請選擇</option>
            <option>草稿</option>
            <option>已核准</option>
            <option>已結案</option>
          </select>`;
      },
      textarea(label = "備註", placeholder = "備註內容") {
        return `<textarea placeholder="${placeholder}"></textarea>`;
      },
      button(text = "按鈕") {
        return `<button type="button" class="field-button">${text}</button>`;
      },
      fixedtext(text = "固定文字") {
        return `<input type="text" value="${text}" />`;
      }
    };

    const canvas = document.getElementById("canvas");
    const placeholder = document.getElementById("canvas-placeholder");
    const propLabel = document.getElementById("prop-label");
    const propDbField = document.getElementById("prop-db-field");
    const propWidth = document.getElementById("prop-width");
    const propRowHeight = document.getElementById("prop-row-height");
    const propTextColor = document.getElementById("prop-text-color");
    const propTextColorLabel = document.getElementById("prop-text-color-label");
    const propLength = document.getElementById("prop-length");
    const propFieldType = document.getElementById("prop-field-type");
    const propSelectOptions = document.getElementById("prop-select-options");
    // const propTcode = document.getElementById("prop-tcode"); // 已移除關聯功能(T-Code)屬性
    const propRelationField = document.getElementById("prop-relation-field");
    const propOtherNote = document.getElementById("prop-other-note");
    const propRequired = document.getElementById("prop-required");
    const propReadonly = document.getElementById("prop-readonly");
    const propPrimaryKey = document.getElementById("prop-primary-key");
    const propDefault = document.getElementById("prop-default");
    const propPanelTableId = document.getElementById("prop-panel-table-id");
    const propPanelTableIdCustom = document.getElementById("prop-panel-table-id-custom");
    const propPanelParentTable = document.getElementById("prop-panel-parent-table");
    const propPanelParentTableCustom = document.getElementById("prop-panel-parent-table-custom");
    const propPanelDbTable = document.getElementById("prop-panel-db-table");
    const propPanelTabTitle = document.getElementById("prop-panel-tab-title");
    const propPanelTabTitleLabel = document.getElementById("prop-panel-tab-title-label");
    const panelPropertiesSection = document.getElementById("panel-properties-section");
    const panelProperties = document.getElementById("panel-properties");
    const fieldProperties = document.getElementById("field-properties");
    const columnCountSelect = document.getElementById("column-count");
    const themeButtons = document.querySelectorAll(".theme-btn");
    const btnSave = document.getElementById("btn-save");
    const btnSaveLayout = document.getElementById("btn-save-layout");
    const btnLoadLayout = document.getElementById("btn-load-layout");
    const inputLoadLayout = document.getElementById("input-load-layout");
    let currentFileHandle = null; // 追蹤當前開啟的檔案 handle
    
    // 更新存檔按鈕的啟用/禁用狀態
    function updateSaveButtonState() {
      if (btnSave) {
        btnSave.disabled = !currentFileHandle;
      }
    }
    
    // 初始狀態：禁用存檔按鈕
    updateSaveButtonState();
    const documentTitleInput = document.getElementById("document-title");
    const toast = document.getElementById("toast");
    const btnPreview = document.getElementById("btn-preview");
    const btnExport = document.getElementById("btn-export");
    const btnClear = document.getElementById("btn-clear");
    const previewModal = document.getElementById("preview-modal");
    const previewContent = document.getElementById("preview-content");
    const previewModalClose = previewModal.querySelector(".preview-modal-close");
    const previewModalOverlay = previewModal.querySelector(".preview-modal-overlay");
    const templateModal = document.getElementById("template-modal");
    const templateList = document.getElementById("template-list");
    const templateFolderPath = document.getElementById("template-folder-path");
    const btnSelectTemplateFolder = document.getElementById("btn-select-template-folder");
    const btnGenerateTemplateList = document.getElementById("btn-generate-template-list");
    const btnLoadTemplate = document.getElementById("btn-load-template");
    const templateModalClose = templateModal ? templateModal.querySelector(".preview-modal-close") : null;
    const templateModalOverlay = templateModal ? templateModal.querySelector(".preview-modal-overlay") : null;
    let selectedField = null;
    let selectedGridHeaderCell = null;
    let activePanelBody = null;
    let templateDirectoryHandle = null; // 追蹤範本資料夾 handle
    const palette = document.querySelector(".palette");
    const palettePanels = document.getElementById("palette-panels");
    const paletteFields = document.getElementById("palette-fields");

    // 載入工具順序
    function loadToolOrder() {
      const savedOrder = localStorage.getItem("wysiwyg-tool-order");
      
      // 面板工具
      const panelTools = Array.from(palettePanels.querySelectorAll(".tool"));
      const panelToolMap = new Map(panelTools.map(t => [t.dataset.type, t]));
      const defaultPanelOrder = ["panel-no-tabs", "panel", "grid-panel"];
      
      // 資料欄位工具
      const fieldTools = Array.from(paletteFields.querySelectorAll(".tool"));
      const fieldToolMap = new Map(fieldTools.map(t => [t.dataset.type, t]));
      const defaultFieldOrder = ["text", "number", "date", "select", "textarea", "empty", "button", "fixedtext"];
      
      let panelOrder, fieldOrder;
      if (savedOrder) {
        try {
          const order = JSON.parse(savedOrder);
          panelOrder = order.panels || defaultPanelOrder;
          fieldOrder = order.fields || defaultFieldOrder;
        } catch (e) {
          console.error("載入工具順序失敗", e);
          panelOrder = defaultPanelOrder;
          fieldOrder = defaultFieldOrder;
        }
      } else {
        panelOrder = defaultPanelOrder;
        fieldOrder = defaultFieldOrder;
      }
      
      // 按照順序重新排列面板工具
      panelOrder.forEach(type => {
        const tool = panelToolMap.get(type);
        if (tool) {
          palettePanels.appendChild(tool);
        }
      });
      
      // 按照順序重新排列資料欄位工具
      fieldOrder.forEach(type => {
        const tool = fieldToolMap.get(type);
        if (tool) {
          paletteFields.appendChild(tool);
        }
      });
      
      // 添加任何新工具（如果有的話）
      panelTools.forEach(tool => {
        if (!panelOrder.includes(tool.dataset.type)) {
          palettePanels.appendChild(tool);
        }
      });
      
      fieldTools.forEach(tool => {
        if (!fieldOrder.includes(tool.dataset.type)) {
          paletteFields.appendChild(tool);
        }
      });
      
      // 重新設置事件監聽器
      setupToolDragEvents();
    }

    // 保存工具順序
    function saveToolOrder() {
      const panelTools = Array.from(palettePanels.querySelectorAll(".tool"));
      const fieldTools = Array.from(paletteFields.querySelectorAll(".tool"));
      const order = {
        panels: panelTools.map(t => t.dataset.type),
        fields: fieldTools.map(t => t.dataset.type)
      };
      localStorage.setItem("wysiwyg-tool-order", JSON.stringify(order));
    }

    // 載入區域收合狀態
    function loadSectionCollapseState() {
      const savedState = localStorage.getItem("wysiwyg-section-collapse");
      if (savedState) {
        try {
          const state = JSON.parse(savedState);
          if (state.panels) {
            document.querySelector('[data-section="panels"]').closest(".palette-section").classList.add("collapsed");
          }
          if (state.fields) {
            document.querySelector('[data-section="fields"]').closest(".palette-section").classList.add("collapsed");
          }
        } catch (e) {
          console.error("載入區域收合狀態失敗", e);
        }
      }
    }

    // 保存區域收合狀態
    function saveSectionCollapseState() {
      const state = {
        panels: document.querySelector('[data-section="panels"]').closest(".palette-section").classList.contains("collapsed"),
        fields: document.querySelector('[data-section="fields"]').closest(".palette-section").classList.contains("collapsed")
      };
      localStorage.setItem("wysiwyg-section-collapse", JSON.stringify(state));
    }

    // 初始化：載入工具順序和收合狀態
    loadToolOrder();
    loadSectionCollapseState();

    // 為屬性區塊 body 添加點擊事件處理，防止事件冒泡
    document.querySelectorAll(".properties-section-body").forEach(body => {
      body.addEventListener("click", (e) => {
        e.stopPropagation();
      });
    });

    // 區域收合/展開功能
    document.querySelectorAll(".palette-section-header").forEach(header => {
      header.addEventListener("click", (e) => {
        if (e.target.classList.contains("palette-section-toggle")) {
          return; // 按鈕點擊由下面的處理
        }
        const section = header.closest(".palette-section");
        section.classList.toggle("collapsed");
        saveSectionCollapseState();
      });
    });

    document.querySelectorAll(".palette-section-toggle").forEach(toggle => {
      toggle.addEventListener("click", (e) => {
        e.stopPropagation();
        const section = toggle.closest(".palette-section");
        section.classList.toggle("collapsed");
        saveSectionCollapseState();
      });
    });

    // 工具拖曳到畫布
    function setupToolDragEvents() {
      document.querySelectorAll(".tool").forEach((tool) => {
        const dragHandle = tool.querySelector(".tool-drag-handle");
        
        // 拖曳手柄：用於排序
        if (dragHandle) {
          dragHandle.addEventListener("mousedown", (event) => {
            event.stopPropagation();
          });
          
          dragHandle.addEventListener("dragstart", (event) => {
            event.stopPropagation();
            event.dataTransfer.setData("move-tool", "true");
            event.dataTransfer.effectAllowed = "move";
            tool.classList.add("dragging");
            window._draggedTool = tool;
          });
          
          dragHandle.addEventListener("dragend", () => {
            tool.classList.remove("dragging");
            palettePanels.querySelectorAll(".tool").forEach(t => t.classList.remove("drag-over"));
            paletteFields.querySelectorAll(".tool").forEach(t => t.classList.remove("drag-over"));
            window._draggedTool = null;
          });
        }
        
        // 工具本身：用於拖曳到畫布（排除拖曳手柄）
        tool.addEventListener("dragstart", (event) => {
          // 如果點擊的是拖曳手柄，不處理
          if (event.target.classList.contains("tool-drag-handle") || 
              event.target.closest(".tool-drag-handle")) {
            event.preventDefault();
            return;
          }
          event.dataTransfer.setData("field-type", tool.dataset.type);
        });
      });
    }

    // 初始化工具拖曳事件
    setupToolDragEvents();

    // 工具排序：處理 dragover 和 drop（分別處理兩個區域）
    [palettePanels, paletteFields].forEach(container => {
      container.addEventListener("dragover", (event) => {
        // 在 dragover 中，dataTransfer.getData() 可能無法正常工作，使用全局變數
        if (window._draggedTool && container.contains(window._draggedTool)) {
          event.preventDefault();
          event.dataTransfer.dropEffect = "move";
          const afterElement = getDragAfterElementForTool(container, event.clientY);
          const tools = container.querySelectorAll(".tool");
          tools.forEach(tool => {
            if (tool === window._draggedTool) return;
            tool.classList.remove("drag-over");
          });
          if (afterElement && afterElement !== window._draggedTool) {
            afterElement.classList.add("drag-over");
          }
        }
      });

      container.addEventListener("drop", (event) => {
        // 使用全局變數檢查是否為工具排序
        if (window._draggedTool && container.contains(window._draggedTool)) {
          event.preventDefault();
          event.stopPropagation();
          const afterElement = getDragAfterElementForTool(container, event.clientY);
          
          if (afterElement == null) {
            container.appendChild(window._draggedTool);
          } else {
            container.insertBefore(window._draggedTool, afterElement);
          }
          
          window._draggedTool.classList.remove("dragging");
          container.querySelectorAll(".tool").forEach(t => t.classList.remove("drag-over"));
          window._draggedTool = null;
          
          // 保存順序
          saveToolOrder();
        }
      });
    });

    // 獲取工具拖曳位置後的下一個元素
    function getDragAfterElementForTool(container, y) {
      const draggableElements = [...container.querySelectorAll(".tool:not(.dragging)")];
      
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    columnCountSelect.addEventListener("change", () => {
      if (activePanelBody) {
        setPanelColumns(activePanelBody.closest(".panel"), columnCountSelect.value);
      }
    });

    // 主題切換功能
    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("erp-form-builder-theme", theme);
    }

    function getTheme() {
      return localStorage.getItem("erp-form-builder-theme") || "green";
    }

    // 載入保存的主題
    const savedTheme = getTheme();
    setTheme(savedTheme);
    
    // 更新主題按鈕的 active 狀態
    function updateThemeButtons(activeTheme) {
      themeButtons.forEach((btn) => {
        if (btn.dataset.theme === activeTheme) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
    }

    // 初始化按鈕狀態
    updateThemeButtons(savedTheme);


    // 主題按鈕事件監聽
    themeButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const theme = btn.dataset.theme;
        setTheme(theme);
        updateThemeButtons(theme);
      });
    });

    // 存檔功能
    async function saveFile(fileHandle = null) {
      try {
        // 收集所有佈局資料
        const layoutData = collectLayout();
        
        // 驗證資料格式
        if (!layoutData || !layoutData.layout) {
          throw new Error("無法收集佈局資料");
        }
        
        if (!Array.isArray(layoutData.layout.panels)) {
          throw new Error("面板資料格式錯誤");
        }
        
        // 轉換為 JSON 字串，使用縮排格式化
        const jsonString = JSON.stringify(layoutData, null, 2);
        
        // 建立 Blob
        const blob = new Blob([jsonString], {
          type: "application/json;charset=utf-8"
        });
        
        // 如果有 fileHandle，直接寫入
        if (fileHandle) {
          const writable = await fileHandle.createWritable();
          await writable.write(blob);
          await writable.close();
          showToast("檔案已儲存");
          return fileHandle;
        }
        
        // 生成預設檔名：表單標題_yyyy-MM-dd.json
        const title = (documentTitleInput.value || "功能名稱").trim();
        const date = new Date();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const defaultFileName = `${title}_${year}-${month}-${day}.json`;
        
        // 檢查是否支援 File System Access API (Chrome/Edge)
        if (window.showSaveFilePicker) {
          try {
            const newFileHandle = await window.showSaveFilePicker({
              suggestedName: defaultFileName,
              types: [{
                description: "JSON 檔案",
                accept: {
                  "application/json": [".json"]
                }
              }]
            });
            
            const writable = await newFileHandle.createWritable();
            await writable.write(blob);
            await writable.close();
            showToast("檔案已儲存");
            return newFileHandle;
          } catch (error) {
            // 用戶取消操作，不顯示錯誤
            if (error.name === "AbortError") {
              return null;
            }
            
            // 其他錯誤，回退到傳統下載方式
            console.warn("File System Access API 失敗，使用傳統下載方式:", error);
            downloadFile(blob, defaultFileName);
            return null;
          }
        } else {
          // 不支援 File System Access API，使用傳統下載方式
          downloadFile(blob, defaultFileName);
          return null;
        }
      } catch (error) {
        console.error("儲存失敗:", error);
        alert(`儲存失敗：${error.message || "請稍後再試"}`);
        return null;
      }
    }

    // 存檔按鈕
    btnSave.addEventListener("click", async () => {
      // 如果有 currentFileHandle，直接存檔
      if (currentFileHandle) {
        await saveFile(currentFileHandle);
      } else {
        // 沒有 currentFileHandle，與另存新檔一樣
        const newFileHandle = await saveFile();
        if (newFileHandle) {
          currentFileHandle = newFileHandle;
          // 更新存檔按鈕狀態（啟用）
          updateSaveButtonState();
        }
      }
    });

    // 另存新檔
    btnSaveLayout.addEventListener("click", async () => {
      const newFileHandle = await saveFile();
      if (newFileHandle) {
        // 更新 currentFileHandle 為新檔案
        currentFileHandle = newFileHandle;
        // 更新存檔按鈕狀態（啟用）
        updateSaveButtonState();
      }
    });
    
    // 傳統檔案下載函數
    function downloadFile(blob, fileName) {
      try {
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
        link.download = fileName;
        link.style.display = "none";
          document.body.appendChild(link);
          link.click();
        
        // 清理
        setTimeout(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }, 100);
        
          showToast("畫面檔已下載");
      } catch (error) {
        console.error("下載檔案失敗:", error);
        throw new Error("無法下載檔案");
      }
    }

    // 開啟舊檔
    btnLoadLayout.addEventListener("click", async () => {
      // 檢查是否支援 File System Access API
      if (window.showOpenFilePicker) {
        try {
          // 嘗試從 IndexedDB 讀取上次的目錄 handle（用於開啟舊檔）
          let startIn = undefined;
          try {
            const savedHandle = await getSavedOpenDirectoryHandle();
            if (savedHandle) {
              startIn = savedHandle;
            }
          } catch (e) {
            console.log('無法讀取記憶的開啟目錄:', e);
          }
          
          // 構建選項對象
          const pickerOptions = {
            types: [{
              description: "JSON 檔案",
              accept: {
                "application/json": [".json"]
              }
            }]
          };
          
          // 只有當 startIn 不是 undefined 時才添加它
          if (startIn !== undefined) {
            pickerOptions.startIn = startIn;
          }
          
          const [fileHandle] = await window.showOpenFilePicker(pickerOptions);
          
          // 保存檔案 handle
          currentFileHandle = fileHandle;
          
          // 讀取檔案內容
          const file = await fileHandle.getFile();
          
          // 驗證檔案類型
          if (!file.name.toLowerCase().endsWith(".json")) {
            alert("請選擇 JSON 格式的檔案");
            currentFileHandle = null;
            // 更新存檔按鈕狀態（禁用）
            updateSaveButtonState();
            return;
          }
          
          const reader = new FileReader();
          
          reader.onload = () => {
            try {
              // 解析 JSON
              let payload;
              try {
                payload = JSON.parse(reader.result);
              } catch (parseError) {
                throw new Error("檔案不是有效的 JSON 格式");
              }
              
              if (!payload) {
                throw new Error("檔案內容為空");
              }
              
              // 標準化資料格式
              let layoutData = normalizeLayoutData(payload);
              
              // 驗證資料結構
              if (!layoutData.layout) {
                throw new Error("找不到 layout 資料");
              }
              
              if (!Array.isArray(layoutData.layout.panels)) {
                throw new Error("panels 必須是陣列格式");
              }
              
              // 應用佈局
              applyLayout(layoutData);
              showToast("畫面檔已開啟");
              // 更新存檔按鈕狀態（啟用）
              updateSaveButtonState();
      } catch (error) {
              console.error("開啟錯誤:", error);
              alert(`開啟失敗：${error.message || "檔案格式不正確"}`);
              currentFileHandle = null;
              // 更新存檔按鈕狀態（禁用）
              updateSaveButtonState();
            }
          };
          
          reader.onerror = () => {
            alert("讀取檔案失敗，請確認檔案可正常讀取");
            currentFileHandle = null;
            // 更新存檔按鈕狀態（禁用）
            updateSaveButtonState();
          };
          
          // 讀取檔案內容
          reader.readAsText(file, "utf-8");
          
          // 嘗試記憶檔案所在的目錄
          // 由於 FileSystemFileHandle 沒有 getParent() 方法
          // 我們需要通過其他方式來記憶目錄
          // 這裡我們嘗試：如果用戶選擇了檔案，我們可以通過請求目錄權限來記憶
          // 但為了不影響用戶體驗，我們只在首次使用時請求
          // 或者，我們可以通過 localStorage 儲存檔案路徑（但這需要用戶手動選擇目錄）
          
          // 方法：嘗試通過 showDirectoryPicker 來記憶目錄（可選）
          // 但這會改變用戶體驗，所以我們先不實現
          // 如果用戶希望記憶目錄，可以在首次使用時手動選擇目錄
        } catch (error) {
          // 用戶取消操作，不顯示錯誤
          if (error.name !== "AbortError") {
            console.error("開啟檔案失敗:", error);
            // 回退到傳統檔案選擇方式
      inputLoadLayout.click();
          }
        }
      } else {
        // 不支援 File System Access API，使用傳統檔案選擇方式
        inputLoadLayout.click();
      }
    });

    // 傳統檔案選擇方式（回退方案）
    inputLoadLayout.addEventListener("change", (event) => {
      const file = event.target.files?.[0];
      if (!file) {
        return;
      }
      
      // 驗證檔案類型
      if (!file.name.toLowerCase().endsWith(".json")) {
        alert("請選擇 JSON 格式的檔案");
        inputLoadLayout.value = "";
        return;
      }
      
      // 傳統方式無法保存 fileHandle
      currentFileHandle = null;
      
      const reader = new FileReader();
      
      reader.onload = () => {
        try {
          // 解析 JSON
          let payload;
          try {
            payload = JSON.parse(reader.result);
          } catch (parseError) {
            throw new Error("檔案不是有效的 JSON 格式");
          }
          
          if (!payload) {
            throw new Error("檔案內容為空");
          }
          
          // 標準化資料格式
          let layoutData = normalizeLayoutData(payload);
          
          // 驗證資料結構
          if (!layoutData.layout) {
            throw new Error("找不到 layout 資料");
          }
          
          if (!Array.isArray(layoutData.layout.panels)) {
            throw new Error("panels 必須是陣列格式");
          }
          
          // 應用佈局
          applyLayout(layoutData);
          showToast("畫面檔已開啟");
        } catch (error) {
          console.error("開啟錯誤:", error);
          alert(`開啟失敗：${error.message || "檔案格式不正確"}`);
        } finally {
          inputLoadLayout.value = "";
        }
      };
      
      reader.onerror = () => {
        alert("讀取檔案失敗，請確認檔案可正常讀取");
        inputLoadLayout.value = "";
      };
      
      // 讀取檔案內容
      reader.readAsText(file, "utf-8");
    });
    
    // 標準化佈局資料格式
    function normalizeLayoutData(payload) {
      // 格式 1: 新格式 {meta: {...}, layout: {...}}
      if (payload.layout && typeof payload.layout === "object") {
        return payload;
      }
      
      // 格式 2: 直接是 {title: "...", panels: [...]}
      if (payload.panels && Array.isArray(payload.panels)) {
        return {
          meta: {
            version: 1,
            generatedAt: new Date().toISOString()
          },
          layout: payload
        };
      }
      
      // 格式 3: 直接是 panels 陣列（舊格式）
      if (Array.isArray(payload)) {
        return {
          meta: {
            version: 1,
            generatedAt: new Date().toISOString()
          },
          layout: {
            title: "銷售訂單",
            panels: payload
          }
        };
      }
      
      // 格式不符
      throw new Error("不支援的檔案格式，請確認檔案是由此系統匯出的");
    }

    // 注意：面板拖曳排序的 dragover 處理在下面

      canvas.addEventListener("drop", (event) => {
        event.preventDefault();
        const type = event.dataTransfer.getData("field-type");
        const movePanel = event.dataTransfer.getData("move-panel");
        
        // 處理面板排序
        if (movePanel === "true" && window._draggedPanel) {
          const panels = Array.from(canvas.querySelectorAll(".panel"));
          const draggedPanel = window._draggedPanel;
          const afterElement = getDragAfterElement(canvas, event.clientY);
          
          if (afterElement == null) {
            canvas.appendChild(draggedPanel);
          } else {
            canvas.insertBefore(draggedPanel, afterElement);
          }
          
          draggedPanel.classList.remove("dragging");
          canvas.querySelectorAll(".panel").forEach(p => p.classList.remove("drag-over"));
          window._draggedPanel = null;
          return;
        }
        
        // 處理新增面板
        if (type === "panel" || type === "panel-no-tabs") {
          addPanel({ type });
        } else if (type === "grid-panel") {
          // GRID 面板：檢查是否拖曳到「區塊面板(有頁籤)」
          const targetPanel = event.target.closest(".panel");
          if (targetPanel && targetPanel.querySelector(".panel-tabs")) {
            // 找到「區塊面板(有頁籤)」，自動新增頁籤並將 GRID 面板內容放入
            const tabsContainer = targetPanel.querySelector(".panel-tabs");
            if (tabsContainer) {
              // 創建新頁籤
              const newTab = document.createElement("div");
              newTab.className = "panel-tab active";
              newTab.draggable = true;
              newTab.innerHTML = `
                <input type="text" class="panel-tab-input" value="新頁籤" />
                <span class="panel-tab-remove">×</span>
              `;
              targetPanel.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("active"));
              const tabAdd = tabsContainer.querySelector(".panel-tab-add");
              if (tabAdd) {
                tabsContainer.insertBefore(newTab, tabAdd);
              } else {
                tabsContainer.appendChild(newTab);
              }
              
              // 為新頁籤綁定拖曳事件（使用與 addPanel 相同的邏輯）
              let draggedTab = null;
              
              // 拖曳開始
              newTab.addEventListener("dragstart", (e) => {
                draggedTab = newTab;
                newTab.classList.add("dragging");
                e.dataTransfer.effectAllowed = "move";
              });
              
              // 拖曳結束
              newTab.addEventListener("dragend", (e) => {
                newTab.classList.remove("dragging");
                tabsContainer.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("drag-over"));
                draggedTab = null;
              });
              
              // 拖曳懸停
              newTab.addEventListener("dragover", (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
                if (draggedTab && draggedTab !== newTab) {
                  tabsContainer.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("drag-over"));
                  newTab.classList.add("drag-over");
                }
              });
              
              // 拖曳進入
              newTab.addEventListener("dragenter", (e) => {
                e.preventDefault();
                if (draggedTab && draggedTab !== newTab) {
                  newTab.classList.add("drag-over");
                }
              });
              
              // 拖曳離開
              newTab.addEventListener("dragleave", (e) => {
                newTab.classList.remove("drag-over");
              });
              
              // 放置
              newTab.addEventListener("drop", (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (draggedTab && draggedTab !== newTab) {
                  const tabs = Array.from(tabsContainer.querySelectorAll(".panel-tab"));
                  const tabBodies = Array.from(targetPanel.querySelectorAll(".tab-body"));
                  const draggedIndex = tabs.indexOf(draggedTab);
                  const targetIndex = tabs.indexOf(newTab);
                  
                  // 移動頁籤
                  if (draggedIndex < targetIndex) {
                    tabsContainer.insertBefore(draggedTab, newTab.nextSibling);
                  } else {
                    tabsContainer.insertBefore(draggedTab, newTab);
                  }
                  
                  // 移動對應的 tab-body
                  const draggedTabBody = tabBodies[draggedIndex];
                  const targetTabBody = tabBodies[targetIndex];
                  if (draggedTabBody && targetTabBody) {
                    if (draggedIndex < targetIndex) {
                      targetTabBody.parentNode.insertBefore(draggedTabBody, targetTabBody.nextSibling);
                    } else {
                      targetTabBody.parentNode.insertBefore(draggedTabBody, targetTabBody);
                    }
                  }
                  
                  // 更新所有頁籤和 tab-body 的 data-tab-index
                  const updatedTabs = Array.from(tabsContainer.querySelectorAll(".panel-tab"));
                  const updatedTabBodies = Array.from(targetPanel.querySelectorAll(".tab-body"));
                  updatedTabs.forEach((t, newIdx) => {
                    t.dataset.tabIndex = String(newIdx);
                    if (updatedTabBodies[newIdx]) {
                      updatedTabBodies[newIdx].dataset.tabIndex = String(newIdx);
                    }
                  });
                  
                  tabsContainer.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("drag-over"));
                }
              });
              
              // 為所有現有頁籤也綁定拖曳事件（確保一致性）
              targetPanel.querySelectorAll(".panel-tab").forEach((tab) => {
                if (tab !== newTab) {
                  // 拖曳開始
                  tab.addEventListener("dragstart", (e) => {
                    draggedTab = tab;
                    tab.classList.add("dragging");
                    e.dataTransfer.effectAllowed = "move";
                  });
                  
                  // 拖曳結束
                  tab.addEventListener("dragend", (e) => {
                    tab.classList.remove("dragging");
                    tabsContainer.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("drag-over"));
                    draggedTab = null;
                  });
                  
                  // 拖曳懸停
                  tab.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = "move";
                    if (draggedTab && draggedTab !== tab) {
                      tabsContainer.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("drag-over"));
                      tab.classList.add("drag-over");
                    }
                  });
                  
                  // 拖曳進入
                  tab.addEventListener("dragenter", (e) => {
                    e.preventDefault();
                    if (draggedTab && draggedTab !== tab) {
                      tab.classList.add("drag-over");
                    }
                  });
                  
                  // 拖曳離開
                  tab.addEventListener("dragleave", (e) => {
                    tab.classList.remove("drag-over");
                  });
                  
                  // 放置
                  tab.addEventListener("drop", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (draggedTab && draggedTab !== tab) {
                      const tabs = Array.from(tabsContainer.querySelectorAll(".panel-tab"));
                      const tabBodies = Array.from(targetPanel.querySelectorAll(".tab-body"));
                      const draggedIndex = tabs.indexOf(draggedTab);
                      const targetIndex = tabs.indexOf(tab);
                      
                      // 移動頁籤
                      if (draggedIndex < targetIndex) {
                        tabsContainer.insertBefore(draggedTab, tab.nextSibling);
                      } else {
                        tabsContainer.insertBefore(draggedTab, tab);
                      }
                      
                      // 移動對應的 tab-body
                      const draggedTabBody = tabBodies[draggedIndex];
                      const targetTabBody = tabBodies[targetIndex];
                      if (draggedTabBody && targetTabBody) {
                        if (draggedIndex < targetIndex) {
                          targetTabBody.parentNode.insertBefore(draggedTabBody, targetTabBody.nextSibling);
                        } else {
                          targetTabBody.parentNode.insertBefore(draggedTabBody, targetTabBody);
                        }
                      }
                      
                      // 更新所有頁籤和 tab-body 的 data-tab-index
                      const updatedTabs = Array.from(tabsContainer.querySelectorAll(".panel-tab"));
                      const updatedTabBodies = Array.from(targetPanel.querySelectorAll(".tab-body"));
                      updatedTabs.forEach((t, newIdx) => {
                        t.dataset.tabIndex = String(newIdx);
                        if (updatedTabBodies[newIdx]) {
                          updatedTabBodies[newIdx].dataset.tabIndex = String(newIdx);
                        }
                      });
                      
                      tabsContainer.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("drag-over"));
                    }
                  });
                }
              });
              
              // 創建對應的新 tab-body
              const newTabBody = document.createElement("div");
              newTabBody.className = "tab-body active";
              const columns = targetPanel.dataset.columns || "3";
              newTabBody.style.setProperty("--column-count", columns);
              newTabBody.dataset.columns = columns;
              
              // 獲取當前面板的列高
              const currentHeight = parseInt(targetPanel.dataset.panelHeight) || 3;
              // 使用與 setPanelHeight 相同的計算公式：36 * heightValue + 12
              const minHeight = (currentHeight * 36) + 12;
              newTabBody.style.minHeight = `${minHeight}px`;
              newTabBody.dataset.panelHeight = String(currentHeight);
              
              // 初始化新頁籤的區塊屬性（使用預設值）
              newTabBody.dataset.panelTableId = "A";
              newTabBody.dataset.panelParentTable = "";
              newTabBody.dataset.panelDbTable = "";
              
              targetPanel.querySelectorAll(".tab-body").forEach(tb => tb.classList.remove("active"));
              targetPanel.appendChild(newTabBody);
              
              // 創建 GRID 頁籤欄位（類似 GRID 面板，但作為欄位放入頁籤）
              const gridField = document.createElement("div");
              gridField.className = "field field-grid-tab";
              gridField.dataset.type = "grid-tab";
              gridField.dataset.width = "full";
              gridField.innerHTML = `
                <div class="field-delete" title="刪除欄位">×</div>
                <div class="field-control">
                  <div class="grid-panel-body"></div>
                </div>
              `;
              
              // 初始化 GRID 結構（預設4列）
              const gridBody = gridField.querySelector(".grid-panel-body");
              if (gridBody) {
                initGridPanel(gridBody, {});
              }
              
              // 為新的 tab-body 綁定拖曳事件
              newTabBody.addEventListener("dragover", (event) => {
                event.preventDefault();
                const moving = event.dataTransfer.getData("move-field");
                if (moving && window._draggedField) {
                  event.dataTransfer.dropEffect = "move";
                } else {
                  event.dataTransfer.dropEffect = "copy";
                }
              });
              
              newTabBody.addEventListener("drop", (event) => {
                event.preventDefault();
                event.stopPropagation();
                const moving = event.dataTransfer.getData("move-field");
                if (moving && window._draggedField) {
                  const draggedField = window._draggedField;
                  newTabBody.appendChild(draggedField);
                  draggedField.classList.remove("dragging");
                  window._draggedField = null;
                  isDraggingField = false;
                  selectField(draggedField);
                  setActivePanel(newTabBody);
                  return;
                }
                const fieldType = event.dataTransfer.getData("field-type");
                if (!fieldType || fieldType === "panel" || fieldType === "panel-no-tabs" || fieldType === "grid-panel") {
                  return;
                }
                addField(fieldType, {}, newTabBody);
              });
              
              // 將 GRID 頁籤放入新頁籤
              newTabBody.appendChild(gridField);
              
              // 設置活動面板
              setActivePanel(newTabBody);
              
              // 綁定頁籤點擊事件
              const tabInput = newTab.querySelector(".panel-tab-input");
              newTab.addEventListener("click", () => {
                targetPanel.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("active"));
                newTab.classList.add("active");
                targetPanel.querySelectorAll(".tab-body").forEach(tb => tb.classList.remove("active"));
                newTabBody.classList.add("active");
                setActivePanel(newTabBody);
                if (tabInput) {
                  targetPanel.dataset.title = tabInput.value;
                }
              });
              
              // 頁籤標題編輯
              if (tabInput) {
                tabInput.addEventListener("focus", () => {
                  // 當 focus 在頁籤標題輸入框時，切換到該頁籤並顯示區塊屬性
                  if (!newTab.classList.contains("active")) {
                    // 切換頁籤 active 狀態
                    targetPanel.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("active"));
                    newTab.classList.add("active");
                    
                    // 切換對應的 tab-body
                    targetPanel.querySelectorAll(".tab-body").forEach(tb => tb.classList.remove("active"));
                    newTabBody.classList.add("active");
                    
                    // 清除選中的欄位，確保顯示區塊屬性
                    selectField(null);
                    selectGridHeaderCell(null);
                    // 顯示該頁籤的區塊屬性
                    setActivePanel(newTabBody);
                  } else {
                    // 如果已經是 active 頁籤，確保顯示區塊屬性
                    selectField(null);
                    selectGridHeaderCell(null);
                    setActivePanel(newTabBody);
                  }
                });
                
                tabInput.addEventListener("input", () => {
                  if (newTab.classList.contains("active")) {
                    targetPanel.dataset.title = tabInput.value;
                  }
                });
                tabInput.addEventListener("blur", () => {
                  if (!tabInput.value.trim()) {
                    tabInput.value = "頁籤";
                  }
                });
              }
              
              // 刪除頁籤
              const tabRemove = newTab.querySelector(".panel-tab-remove");
              if (tabRemove) {
                tabRemove.addEventListener("click", (e) => {
                  e.stopPropagation();
                  if (targetPanel.querySelectorAll(".panel-tab").length <= 1) {
                    showToast("至少需要一個頁籤");
                    return;
                  }
                  const wasActive = newTab.classList.contains("active");
                  
                  // 刪除對應的 tab-body
                  newTabBody.remove();
                  
                  // 刪除頁籤
                  newTab.remove();
                  
                  // 如果刪除的是 active 頁籤，激活第一個頁籤
                  if (wasActive) {
                    const firstTab = targetPanel.querySelector(".panel-tab");
                    if (firstTab) {
                      firstTab.classList.add("active");
                      targetPanel.dataset.title = firstTab.querySelector(".panel-tab-input").value;
                      const firstTabBody = targetPanel.querySelector(".tab-body");
                      if (firstTabBody) {
                        targetPanel.querySelectorAll(".tab-body").forEach(tb => tb.classList.remove("active"));
                        firstTabBody.classList.add("active");
                        setActivePanel(firstTabBody);
                      }
                    }
                  }
                });
              }
              
              // 綁定 GRID 頁籤的刪除按鈕
              const gridFieldDelete = gridField.querySelector(".field-delete");
              if (gridFieldDelete) {
                gridFieldDelete.addEventListener("click", (e) => {
                  e.stopPropagation();
                  if (confirm("確定要刪除此 GRID 頁籤？")) {
                    gridField.remove();
                    selectField(null);
                  }
                });
              }
            }
          } else {
            // 沒有拖曳到「區塊面板(有頁籤)」，正常創建 GRID 面板
            addPanel({ type });
          }
        } else if (type) {
          showToast("請先將欄位拖曳到某個區塊面板內");
        }
      });
      
      // 面板拖曳排序：處理 dragover 事件
      canvas.addEventListener("dragover", (event) => {
        event.preventDefault();
        const movePanel = event.dataTransfer.getData("move-panel");
        if (movePanel === "true" && window._draggedPanel) {
          const afterElement = getDragAfterElement(canvas, event.clientY);
          const panels = canvas.querySelectorAll(".panel");
          panels.forEach(panel => {
            if (panel === window._draggedPanel) return;
            panel.classList.remove("drag-over");
          });
          if (afterElement && afterElement !== window._draggedPanel) {
            afterElement.classList.add("drag-over");
          }
        }
      });
      
      // 獲取拖曳位置後的下一個元素
      function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll(".panel:not(.dragging)")];
        
        return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
      }

    // 追蹤是否正在拖曳欄位
    let isDraggingField = false;

    canvas.addEventListener("click", (event) => {
      // 如果正在拖曳欄位，不處理點擊事件
      if (isDraggingField) {
        isDraggingField = false;
        return;
      }
      
      // 如果點擊的是屬性面板區域，不處理
      if (event.target.closest(".properties") || 
          event.target.closest(".properties-section") ||
          event.target.closest(".properties-section-header") ||
          event.target.closest(".properties-section-body")) {
        return;
      }
      
      // 如果點擊的是面板的控制元素，不處理
      if (event.target.closest(".panel-header-controls") || 
          event.target.closest(".panel-tabs") ||
          event.target.closest(".panel-delete")) {
        return;
      }
      
      // 如果點擊的是欄位標題（可編輯），不處理（讓標題可以編輯）
      if (event.target.classList.contains("label-text")) {
        return;
      }
      
      // 如果點擊的是 grid header cell 或標題，不處理（由 focus 事件處理）
      if (event.target.closest(".grid-header-cell") || 
          event.target.closest(".header-title")) {
        return;
      }
      
      // 如果點擊的是欄位內的 input/textarea/select，不處理（由 focus 事件處理）
      if (event.target.closest(".field-control input") || 
          event.target.closest(".field-control textarea") ||
          event.target.closest(".field-control select")) {
        return;
      }
      
      // 如果點擊的是按鈕（可編輯），不處理（讓按鈕可以編輯）
      if (event.target.classList.contains("field-button") && event.target.contentEditable === "true") {
        return;
      }
      
      const field = event.target.closest(".field");
      if (field) {
        selectField(field);
        setActivePanel(field.closest(".panel-body, .tab-body"));
        return;
      }
      const panel = event.target.closest(".panel");
      if (panel) {
        selectField(null);
        selectGridHeaderCell(null);
        setActivePanel(panel.querySelector(".panel-body"));
        return;
      }
      selectField(null);
      selectGridHeaderCell(null);
      setActivePanel(null);
    });

    propLabel.addEventListener("input", () => {
      if (selectedField && selectedField.dataset.type !== "empty" && selectedField.dataset.type !== "button") {
        const labelText = selectedField.querySelector(".label-text");
        if (labelText) {
          labelText.textContent = propLabel.value || "未命名欄位";
        }
      } else if (selectedGridHeaderCell) {
        const titleEl = selectedGridHeaderCell.querySelector(".header-title");
        if (titleEl) {
          titleEl.textContent = propLabel.value || "未命名欄位";
          updateGridHeaderRequired(selectedGridHeaderCell);
          updateGridHeaderReadonly(selectedGridHeaderCell);
        }
      }
    });

    propDbField.addEventListener("input", () => {
      if (selectedField && selectedField.dataset.type !== "empty" && selectedField.dataset.type !== "button") {
        selectedField.dataset.dbField = propDbField.value || "";
      } else if (selectedGridHeaderCell) {
        selectedGridHeaderCell.dataset.dbField = propDbField.value || "";
      }
    });

    propWidth.addEventListener("change", () => {
      if (selectedField) {
        selectedField.dataset.width = propWidth.value;
      } else if (selectedGridHeaderCell) {
        selectedGridHeaderCell.dataset.width = propWidth.value;
      }
    });

    propRowHeight.addEventListener("change", () => {
      if (selectedField) {
        const newRowHeight = propRowHeight.value;
        const oldRowHeight = selectedField.dataset.rowHeight || "1";
        selectedField.dataset.rowHeight = newRowHeight;
        // 更新 grid-row 使欄位可以跨越多行（固定行高 32px + 4px間隔）
        const rowSpan = parseInt(newRowHeight);
        selectedField.style.gridRow = `span ${rowSpan}`;
        
        // 如果是 text 類型的欄位，根據列高切換 input 和 textarea
        if (selectedField.dataset.type === "text") {
          const controlDiv = selectedField.querySelector(".field-control");
          const currentInput = controlDiv.querySelector("input, textarea");
          
          if (parseInt(newRowHeight) > 1 && currentInput && currentInput.tagName === "INPUT") {
            // 從 input 切換到 textarea
            const value = currentInput.value || "";
            const placeholder = currentInput.getAttribute("data-placeholder") || currentInput.placeholder || "請輸入內容";
            const textarea = document.createElement("textarea");
            textarea.placeholder = placeholder;
            textarea.value = value;
            if (placeholder) {
              textarea.setAttribute("data-placeholder", placeholder);
            }
            currentInput.replaceWith(textarea);
          } else if (parseInt(newRowHeight) === 1 && currentInput && currentInput.tagName === "TEXTAREA") {
            // 從 textarea 切換到 input
            const value = currentInput.value || "";
            const placeholder = currentInput.getAttribute("data-placeholder") || currentInput.placeholder || "請輸入內容";
            const input = document.createElement("input");
            input.type = "text";
            input.placeholder = placeholder;
            input.value = value;
            if (placeholder) {
              input.setAttribute("data-placeholder", placeholder);
            }
            currentInput.replaceWith(input);
          }
        }
      } else if (selectedGridHeaderCell) {
        selectedGridHeaderCell.dataset.rowHeight = propRowHeight.value;
      }
    });

    propLength.addEventListener("input", () => {
      if (selectedField && selectedField.dataset.type !== "empty" && selectedField.dataset.type !== "button") {
        selectedField.dataset.fieldLength = propLength.value || "N/A";
      } else if (selectedGridHeaderCell) {
        selectedGridHeaderCell.dataset.fieldLength = propLength.value || "N/A";
      }
    });

    propFieldType.addEventListener("change", () => {
      if (selectedField && selectedField.dataset.type !== "empty" && selectedField.dataset.type !== "button") {
        selectedField.dataset.fieldType = propFieldType.value || "real";
      } else if (selectedGridHeaderCell) {
        selectedGridHeaderCell.dataset.fieldType = propFieldType.value || "real";
      }
    });

    propSelectOptions.addEventListener("input", () => {
      if (selectedField && selectedField.dataset.type !== "empty" && selectedField.dataset.type !== "button") {
        selectedField.dataset.selectOptions = propSelectOptions.value || "";
        // 如果是 select 類型的欄位，更新選項
        if (selectedField.dataset.type === "select") {
          const selectElement = selectedField.querySelector(".field-control select");
          if (selectElement && propSelectOptions.value) {
            const options = propSelectOptions.value.split(";").filter(opt => opt.trim());
            selectElement.innerHTML = '<option value="">請選擇</option>';
            options.forEach(opt => {
              const option = document.createElement("option");
              option.value = opt.trim();
              option.textContent = opt.trim();
              selectElement.appendChild(option);
            });
          }
        }
      } else if (selectedGridHeaderCell) {
        selectedGridHeaderCell.dataset.selectOptions = propSelectOptions.value || "";
      }
    });

    // propTcode 事件監聽器已移除（關聯功能(T-Code)屬性已移除）

    propRelationField.addEventListener("input", () => {
      if (selectedField && selectedField.dataset.type !== "empty" && selectedField.dataset.type !== "button") {
        selectedField.dataset.relationField = propRelationField.value || "";
      } else if (selectedGridHeaderCell) {
        selectedGridHeaderCell.dataset.relationField = propRelationField.value || "";
      }
    });

    propOtherNote.addEventListener("input", () => {
      if (selectedField && selectedField.dataset.type !== "empty" && selectedField.dataset.type !== "button") {
        selectedField.dataset.otherNote = propOtherNote.value || "N/A";
      } else if (selectedGridHeaderCell) {
        selectedGridHeaderCell.dataset.otherNote = propOtherNote.value || "N/A";
      }
    });

    propRequired.addEventListener("change", () => {
      if (selectedField && selectedField.dataset.type !== "button") {
        const isRequired = propRequired.checked;
        selectedField.dataset.required = isRequired ? "true" : "false";
        const label = selectedField.querySelector(".field-label");
        if (label) {
          if (isRequired) {
            label.classList.add("required");
          } else {
            label.classList.remove("required");
          }
        }
      } else if (selectedGridHeaderCell) {
        const isRequired = propRequired.checked;
        selectedGridHeaderCell.dataset.required = isRequired ? "true" : "false";
        updateGridHeaderRequired(selectedGridHeaderCell);
      }
    });

    propReadonly.addEventListener("change", () => {
      if (selectedField && selectedField.dataset.type !== "empty" && selectedField.dataset.type !== "button") {
        const isReadonly = propReadonly.checked;
        selectedField.dataset.readonly = isReadonly ? "true" : "false";
        // 更新唯讀樣式
        updateFieldReadonlyStyle(selectedField, isReadonly);
      } else if (selectedGridHeaderCell) {
        const isReadonly = propReadonly.checked;
        selectedGridHeaderCell.dataset.readonly = isReadonly ? "true" : "false";
        updateGridHeaderReadonly(selectedGridHeaderCell);
      }
    });

    // 更新欄位唯讀樣式
    function updateFieldReadonlyStyle(field, isReadonly) {
      const label = field.querySelector(".field-label");
      const control = field.querySelector(".field-control");
      
      if (label) {
        if (isReadonly) {
          label.classList.add("readonly");
        } else {
          label.classList.remove("readonly");
        }
      }
      
      if (control) {
        if (isReadonly) {
          control.classList.add("readonly");
        } else {
          control.classList.remove("readonly");
        }
      }
    }

    propPrimaryKey.addEventListener("change", () => {
      if (selectedField && selectedField.dataset.type !== "empty" && selectedField.dataset.type !== "button") {
        const isPrimaryKey = propPrimaryKey.checked;
        selectedField.dataset.primaryKey = isPrimaryKey ? "true" : "false";
      } else if (selectedGridHeaderCell) {
        const isPrimaryKey = propPrimaryKey.checked;
        selectedGridHeaderCell.dataset.primaryKey = isPrimaryKey ? "true" : "false";
      }
    });

    propDefault.addEventListener("input", () => {
      if (selectedField && selectedField.dataset.type !== "empty") {
        // 只保存到 dataset.defaultValue，不更新欄位的實際值
        selectedField.dataset.defaultValue = propDefault.value || "";
        
        // 如果是下拉選單，更新顯示的預設值
        if (selectedField.dataset.type === "select") {
          const selectInput = selectedField.querySelector(".field-control select");
          if (selectInput) {
            const defaultValue = propDefault.value || "";
            if (defaultValue) {
              const options = Array.from(selectInput.options);
              const matchingOption = options.find(opt => 
                opt.value === defaultValue || 
                opt.textContent === defaultValue ||
                opt.value.trim() === defaultValue.trim() ||
                opt.textContent.trim() === defaultValue.trim()
              );
              if (matchingOption) {
                selectInput.value = matchingOption.value;
              } else {
                // 如果找不到匹配的選項，添加一個預設值選項
                const existingDefault = selectInput.querySelector('option[data-is-default="true"]');
                if (existingDefault) {
                  existingDefault.remove();
                }
                const defaultOption = document.createElement("option");
                defaultOption.value = defaultValue;
                defaultOption.textContent = defaultValue;
                defaultOption.selected = true;
                defaultOption.setAttribute("data-is-default", "true");
                selectInput.insertBefore(defaultOption, selectInput.firstChild);
              }
            } else {
              // 如果預設值為空，移除預設值選項
              const existingDefault = selectInput.querySelector('option[data-is-default="true"]');
              if (existingDefault) {
                existingDefault.remove();
                selectInput.value = "";
              }
            }
          }
        }
        // 如果是數值欄位，更新顯示的預設值（格式化）
        else if (selectedField.dataset.type === "number") {
          const numberInput = selectedField.querySelector(".field-control input.number-input");
          if (numberInput && !numberInput.value) {
            const defaultValue = propDefault.value || "";
            if (defaultValue) {
              const formatNumber = (value) => {
                if (!value) return "";
                const numStr = value.toString().replace(/[^\d.-]/g, "");
                if (!numStr) return "";
                const parts = numStr.split(".");
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return parts.join(".");
              };
              numberInput.value = formatNumber(defaultValue);
            }
          }
        }
      } else if (selectedGridHeaderCell) {
        selectedGridHeaderCell.dataset.defaultValue = propDefault.value || "";
      }
    });

    propTextColor.addEventListener("input", () => {
      if (selectedField && selectedField.dataset.type === "fixedtext") {
        const color = propTextColor.value;
        selectedField.dataset.textColor = color;
        const input = selectedField.querySelector(".field-control input");
        if (input) {
          input.style.color = color;
        }
      }
    });

    // 資料表識別：處理下拉選單和自訂輸入框
    propPanelTableId.addEventListener("change", () => {
      if (activePanelBody) {
        const panel = activePanelBody.closest(".panel");
        if (panel) {
          // 對於有頁籤的面板，屬性保存到 tab-body；否則保存到 panel
          const targetElement = activePanelBody.classList.contains("tab-body") ? activePanelBody : panel;
          const value = propPanelTableId.value;
          if (value === "custom") {
            // 顯示自訂輸入框
            propPanelTableIdCustom.style.display = "block";
            propPanelTableIdCustom.focus();
            // 如果有已保存的自訂值，載入它
            const customValue = targetElement.dataset.panelTableIdCustom || "";
            propPanelTableIdCustom.value = customValue;
            targetElement.dataset.panelTableId = "custom";
            targetElement.dataset.panelTableIdCustom = customValue;
          } else {
            // 隱藏自訂輸入框並保存選中的值
            propPanelTableIdCustom.style.display = "none";
            targetElement.dataset.panelTableId = value;
            targetElement.dataset.panelTableIdCustom = "";
          }
        }
      }
    });

    // 資料表識別自訂輸入框
    propPanelTableIdCustom.addEventListener("input", () => {
      if (activePanelBody) {
        const panel = activePanelBody.closest(".panel");
        if (panel) {
          // 對於有頁籤的面板，屬性保存到 tab-body；否則保存到 panel
          const targetElement = activePanelBody.classList.contains("tab-body") ? activePanelBody : panel;
          targetElement.dataset.panelTableIdCustom = propPanelTableIdCustom.value || "";
        }
      }
    });

    // 關聯的父表：處理下拉選單和自訂輸入框
    propPanelParentTable.addEventListener("change", () => {
      if (activePanelBody) {
        const panel = activePanelBody.closest(".panel");
        if (panel) {
          // 對於有頁籤的面板，屬性保存到 tab-body；否則保存到 panel
          const targetElement = activePanelBody.classList.contains("tab-body") ? activePanelBody : panel;
          const value = propPanelParentTable.value;
          if (value === "custom") {
            // 顯示自訂輸入框
            propPanelParentTableCustom.style.display = "block";
            propPanelParentTableCustom.focus();
            // 如果有已保存的自訂值，載入它
            const customValue = targetElement.dataset.panelParentTableCustom || "";
            propPanelParentTableCustom.value = customValue;
            targetElement.dataset.panelParentTable = "custom";
            targetElement.dataset.panelParentTableCustom = customValue;
          } else {
            // 隱藏自訂輸入框並保存選中的值
            propPanelParentTableCustom.style.display = "none";
            targetElement.dataset.panelParentTable = value || "";
            targetElement.dataset.panelParentTableCustom = "";
          }
        }
      }
    });

    // 關聯的父表自訂輸入框
    propPanelParentTableCustom.addEventListener("input", () => {
      if (activePanelBody) {
        const panel = activePanelBody.closest(".panel");
        if (panel) {
          // 對於有頁籤的面板，屬性保存到 tab-body；否則保存到 panel
          const targetElement = activePanelBody.classList.contains("tab-body") ? activePanelBody : panel;
          targetElement.dataset.panelParentTableCustom = propPanelParentTableCustom.value || "";
        }
      }
    });

    // DB 資料表名(Eng)
    propPanelDbTable.addEventListener("input", () => {
      if (activePanelBody) {
        const panel = activePanelBody.closest(".panel");
        if (panel) {
          // 對於有頁籤的面板，屬性保存到 tab-body；否則保存到 panel
          const targetElement = activePanelBody.classList.contains("tab-body") ? activePanelBody : panel;
          targetElement.dataset.panelDbTable = propPanelDbTable.value || "";
        }
      }
    });

    // 頁籤標題（適用於所有面板類型）
    if (propPanelTabTitle) {
      propPanelTabTitle.addEventListener("input", () => {
        if (activePanelBody) {
          const panel = activePanelBody.closest(".panel");
          if (panel) {
            const hasTabs = panel.querySelector(".panel-tabs");
            const value = propPanelTabTitle.value || "";
            
            if (hasTabs) {
              // 有頁籤的面板：更新當前活動頁籤的標題
              const activeTab = panel.querySelector(".panel-tab.active");
              if (activeTab) {
                const tabInput = activeTab.querySelector(".panel-tab-input");
                if (tabInput) {
                  tabInput.value = value || "頁籤";
                  // 更新面板標題
                  panel.dataset.title = tabInput.value;
                }
              }
            } else {
              // 無頁籤的面板或 GRID 面板：直接更新面板標題
              panel.dataset.title = value || "區塊";
            }
            
            // 保存到面板的 dataset
            panel.dataset.panelTabTitle = value;
          }
        }
      });
    }

    function setPanelHeight(panel, height) {
      const heightValue = parseInt(height) || 3;
      // 固定計算：每行 32px (grid-auto-rows) + 4px (row-gap) = 36px
      // 但第一行沒有 gap，所以 n 行 = (n * 32) + ((n-1) * 4) + 16 (padding)
      // 簡化：36n - 4 + 16 = 36n + 12
      // 為了確保列高固定，使用：36 * heightValue + 12
      const minHeight = (heightValue * 36) + 12;
      
      // 應用到活動的 tab-body（對於有頁籤的面板）或 panel-body（對於無頁籤的面板）
      const activePanelBody = panel.querySelector(".tab-body.active") || panel.querySelector(".panel-body");
      if (activePanelBody) {
        activePanelBody.style.minHeight = `${minHeight}px`;
        // 同步更新所有 tab-body 的 minHeight（保持一致性）
        panel.querySelectorAll(".tab-body").forEach((tabBody) => {
          tabBody.style.minHeight = `${minHeight}px`;
        });
        // 如果沒有 tab-body，更新 panel-body
        if (!panel.querySelector(".tab-body")) {
          const panelBody = panel.querySelector(".panel-body");
          if (panelBody) {
            panelBody.style.minHeight = `${minHeight}px`;
          }
        }
      }
      
      panel.dataset.panelHeight = String(heightValue);
      
      // 更新面板 header 中的列高選擇器
      const heightSelect = panel.querySelector(".panel-height-select");
      const heightCustom = panel.querySelector(".panel-height-custom");
      
      if (heightSelect) {
        const isCustom = !["1", "2", "3", "4", "5", "6", "7", "8"].includes(String(heightValue));
        if (isCustom) {
          heightSelect.value = "custom";
          if (heightCustom) {
            heightCustom.style.display = "inline-block";
            heightCustom.value = String(heightValue);
          }
        } else {
          heightSelect.value = String(heightValue);
          if (heightCustom) {
            heightCustom.style.display = "none";
          }
        }
      }
    }

    function generatePreviewHTML() {
      const clone = canvas.cloneNode(true);
      clone.querySelectorAll(".panel").forEach((panel) => panel.classList.remove("active"));
      clone.querySelectorAll(".placeholder").forEach((node) => node.remove());

      // 確保所有面板的 data-columns 屬性都被正確保留
      const originalPanels = canvas.querySelectorAll(".panel:not(.grid-panel)");
      const clonedPanels = clone.querySelectorAll(".panel:not(.grid-panel)");
      originalPanels.forEach((originalPanel, index) => {
        const clonedPanel = clonedPanels[index];
        if (clonedPanel) {
          const columns = originalPanel.dataset.columns || "3";
          clonedPanel.dataset.columns = columns;
          const clonedBody = clonedPanel.querySelector(".panel-body");
          if (clonedBody) {
            clonedBody.style.setProperty("--column-count", columns);
          }
        }
      });

      const titleInputClone = clone.querySelector("#document-title");
      if (titleInputClone) {
        const titleValue = document.createElement("div");
        titleValue.className = "doc-title-value";
        titleValue.textContent = titleInputClone.value || "單據標題";
        titleInputClone.replaceWith(titleValue);
      }

      clone.querySelectorAll(".panel-tab-input").forEach((input) => {
        const text = document.createElement("span");
        text.className = "panel-tab-text";
        text.textContent = input.value || "頁籤";
        input.replaceWith(text);
      });

      clone.querySelectorAll(".panel-columns, .panel-height, .panel-toggle, .panel-delete, .field-delete, .grid-add-header-btn, .grid-add-row-btn, .header-delete, .panel-tab-add, .panel-tab-remove, .panel-drag-handle, .panel-column-custom, .panel-height-custom, .button-width-resizer, .grid-data-row-delete").forEach((node) => node.remove());
      // 保留 .grid-col-resizer 以便在預覽模式中調整欄寬

      // 移除 GRID 面板的編輯功能
      clone.querySelectorAll(".header-title").forEach((title) => {
        title.contentEditable = false;
      });

      // Grid 面板不顯示頁籤容器（已經在創建時移除了）
      // 此處不需要額外處理，因為 Grid 面板不會有 .panel-tabs

      // 處理 text 類型欄位：如果列高 > 1，將 input 轉換為 textarea
      clone.querySelectorAll(".field[data-type='text']").forEach((field) => {
        const rowHeight = parseInt(field.dataset.rowHeight || "1");
        if (rowHeight > 1) {
          const controlDiv = field.querySelector(".field-control");
          const input = controlDiv?.querySelector("input");
          if (input && input.tagName === "INPUT") {
            const value = input.value || "";
            const textarea = document.createElement("textarea");
            textarea.value = value;
            // 如果沒有值，不設置 placeholder（避免顯示「請輸入內容」）
            if (value && value.trim() !== "") {
              const placeholder = input.getAttribute("data-placeholder") || input.placeholder || "請輸入內容";
              textarea.placeholder = placeholder;
            if (placeholder) {
              textarea.setAttribute("data-placeholder", placeholder);
              }
            }
            input.replaceWith(textarea);
          }
        }
      });

      // 確保所有欄位控件的值都被設置為屬性（這樣在 innerHTML 時會被保留）
      clone.querySelectorAll(".field-control input, .field-control textarea, .field-control select, .field-control button").forEach((input) => {
        if (input.tagName === "BUTTON") {
          // 按鈕的文字已經在 innerHTML 中，不需要額外處理
          input.disabled = false;
        } else if (input.tagName === "SELECT") {
          // select 的值通過 selectedIndex 保留
          const selectedOption = input.options[input.selectedIndex];
          if (selectedOption) {
            input.value = selectedOption.value;
          }
          // 如果沒有選中值，移除 placeholder
          if (!input.value || input.value === "") {
            input.removeAttribute("placeholder");
          }
          input.readOnly = true;
          input.disabled = false;
        } else if (input.tagName === "TEXTAREA") {
          // textarea 的值通過 innerHTML 保留（textarea 的內容是文本節點）
          input.innerHTML = input.value;
          // 如果沒有值，移除 placeholder
          if (!input.value || input.value.trim() === "") {
            input.removeAttribute("placeholder");
          }
          input.readOnly = true;
          input.disabled = false;
        } else {
          // input 的值通過 value 屬性保留
          const value = input.value || "";
          input.setAttribute("value", value);
          // 如果沒有值，移除 placeholder
          if (!value || value.trim() === "") {
            input.removeAttribute("placeholder");
          }
          input.readOnly = true;
          input.disabled = false;
          
          // 如果是數值欄位，設置靠右對齊
          const field = input.closest(".field");
          if (field && field.dataset.type === "number") {
            input.style.textAlign = "right";
          }
        }
      });

      clone.querySelectorAll(".grid-data-cell input").forEach((input) => {
        const value = input.value || "";
        input.setAttribute("value", value);
        // 如果沒有值，移除 placeholder
        if (!value || value.trim() === "") {
          input.removeAttribute("placeholder");
        }
        input.readOnly = true;
        input.disabled = false;
        
        // 如果是數值欄位，設置靠右對齊
        const cell = input.closest(".grid-data-cell");
        if (cell && cell.dataset.type === "number") {
          input.style.textAlign = "right";
        } else if (input.classList.contains("number-input")) {
          input.style.textAlign = "right";
        }
      });

      // 保留 class="field"、data-width、data-row-height、data-type 和面板的 data-columns 以維持布局，但移除其他 data 屬性
      let html = clone.innerHTML;
      // 先保留 data-columns、data-row-height 和 data-type（用臨時標記）
      html = html.replace(/\sdata-columns="([^"]*)"/g, ' data-columns-temp="$1"');
      html = html.replace(/\sdata-row-height="([^"]*)"/g, ' data-row-height-temp="$1"');
      html = html.replace(/\sdata-type="([^"]*)"/g, ' data-type-temp="$1"');
      // 移除其他 data 屬性（但保留 data-width）
      html = html.replace(/\sdata-(?!width)[^=]+="[^"]*"/g, "");
      // 恢復 data-columns、data-row-height 和 data-type
      html = html.replace(/\sdata-columns-temp="([^"]*)"/g, ' data-columns="$1"');
      html = html.replace(/\sdata-row-height-temp="([^"]*)"/g, ' data-row-height="$1"');
      html = html.replace(/\sdata-type-temp="([^"]*)"/g, ' data-type="$1"');
      html = html.trim();
      
      return html;
    }

    btnPreview.addEventListener("click", () => {
      const previewHTML = generatePreviewHTML();
      previewContent.innerHTML = previewHTML;
      
      // 從原始 canvas 獲取面板欄數並應用到預覽模式
      const originalPanels = canvas.querySelectorAll(".panel:not(.grid-panel)");
      const previewPanels = previewContent.querySelectorAll(".panel:not(.grid-panel)");
      
      originalPanels.forEach((originalPanel, index) => {
        const previewPanel = previewPanels[index];
        if (previewPanel) {
          // 從原始面板獲取欄數
          const columns = originalPanel.dataset.columns || "3";
          const previewBody = previewPanel.querySelector(".panel-body");
          if (previewBody) {
            // 設置 CSS 變數
            previewBody.style.setProperty("--column-count", columns);
            // 同時設置 data-columns 屬性以確保一致性
            previewPanel.dataset.columns = columns;
          }
        }
      });
      
      // 確保所有值都被正確設置（因為 innerHTML 可能不會保留某些值）
      const originalInputs = canvas.querySelectorAll(".field-control input, .field-control textarea, .field-control select, .field-control button");
      const previewInputs = previewContent.querySelectorAll(".field-control input, .field-control textarea, .field-control select, .field-control button");
      
      originalInputs.forEach((original, index) => {
        const preview = previewInputs[index];
        if (preview && original) {
          if (original.tagName === "BUTTON") {
            // 按鈕類型：恢復按鈕文字
            preview.textContent = original.textContent || "按鈕";
            preview.disabled = false;
          } else if (original.tagName === "SELECT") {
            preview.selectedIndex = original.selectedIndex;
            preview.value = original.value;
            preview.readOnly = true;
            preview.disabled = false;
          } else {
            preview.value = original.value;
            preview.readOnly = true;
            preview.disabled = false;
            
            // 如果是數值欄位，設置靠右對齊
            if (preview.tagName === "INPUT") {
              const previewField = preview.closest(".field");
              if (previewField && previewField.dataset.type === "number") {
                preview.style.textAlign = "right";
              } else if (preview.classList.contains("number-input")) {
                preview.style.textAlign = "right";
              }
            }
          }
        }
      });

      // 恢復 GRID 面板的值
      const originalGridInputs = canvas.querySelectorAll(".grid-data-cell input");
      const previewGridInputs = previewContent.querySelectorAll(".grid-data-cell input");
      
      originalGridInputs.forEach((original, index) => {
        const preview = previewGridInputs[index];
        if (preview && original) {
          preview.value = original.value;
          preview.readOnly = true;
          preview.disabled = false;
          
          // 如果是數值欄位，設置靠右對齊
          const previewCell = preview.closest(".grid-data-cell");
          if (previewCell && previewCell.dataset.type === "number") {
            preview.style.textAlign = "right";
          } else if (preview.classList.contains("number-input")) {
            preview.style.textAlign = "right";
          }
        }
      });

      // 為預覽模式的 GRID 添加欄寬調整功能
      previewContent.querySelectorAll(".grid-panel-body, .field-control .grid-panel-body").forEach((gridBody) => {
        setupGridColumnResizers(gridBody);
      });

      // 為預覽模式的頁籤添加點擊事件，使其可以切換
      previewContent.querySelectorAll(".panel-tab").forEach((tab) => {
        tab.style.cursor = "pointer";
        // 使用事件委派，因為頁籤可能包含文本節點
        tab.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const panel = tab.closest(".panel");
          if (panel) {
            // 移除所有頁籤的 active 類
            panel.querySelectorAll(".panel-tab").forEach((t) => t.classList.remove("active"));
            // 添加當前頁籤的 active 類
            tab.classList.add("active");
            
            // 獲取頁籤索引
            const allTabs = Array.from(panel.querySelectorAll(".panel-tab"));
            const tabIndex = allTabs.indexOf(tab);
            
            // 切換對應的 tab-body
            const tabBodies = panel.querySelectorAll(".tab-body");
            tabBodies.forEach((body, idx) => {
              if (idx === tabIndex) {
                body.classList.add("active");
                body.style.display = "grid";
              } else {
                body.classList.remove("active");
                body.style.display = "none";
              }
            });
          }
        });
      });
      
      // 確保初始狀態下只有 active 的 tab-body 顯示
      previewContent.querySelectorAll(".tab-body").forEach((body) => {
        if (body.classList.contains("active")) {
          body.style.display = "grid";
        } else {
          body.style.display = "none";
        }
      });

      previewModal.classList.add("show");
      document.body.style.overflow = "hidden";
    });

    function closePreviewModal() {
      previewModal.classList.remove("show");
      document.body.style.overflow = "";
    }

    previewModalClose.addEventListener("click", closePreviewModal);
    previewModalOverlay.addEventListener("click", closePreviewModal);

    // 按 ESC 鍵關閉彈窗
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && previewModal.classList.contains("show")) {
        closePreviewModal();
      }
      if (e.key === "Escape" && templateModal && templateModal.classList.contains("show")) {
        closeTemplateModal();
      }
    });

    // 範本基礎路徑（相對路徑）
    const TEMPLATE_BASE_PATH = './template/';
    
    // 檢測是否為本地檔案協議
    function isLocalFileProtocol() {
      return window.location.protocol === 'file:';
    }
    
    // 載入範本功能
    function openTemplateModal() {
      if (templateModal) {
        templateModal.classList.add("show");
        document.body.style.overflow = "hidden";
        // 初始化預覽容器高度
        updateTemplatePreviewHeight();
        // 根據協議類型顯示/隱藏「產生檔案list」按鈕
        if (btnGenerateTemplateList) {
          if (isLocalFileProtocol()) {
            // 如果是本地檔案協議，且已選擇資料夾，則顯示按鈕
            btnGenerateTemplateList.style.display = templateDirectoryHandle ? 'block' : 'none';
          } else {
            // 如果是 HTTP/HTTPS 協議，隱藏按鈕
            btnGenerateTemplateList.style.display = 'none';
          }
        }
        // 自動載入範本列表
        loadTemplateList();
      }
    }
    
    // 更新預覽容器高度，使其適應模態視窗高度
    function updateTemplatePreviewHeight() {
      const templateModalContent = document.getElementById("template-modal-content");
      const templatePreviewContainer = document.getElementById("template-preview-container");
      const templateList = document.getElementById("template-list");
      
      if (!templateModalContent || !templatePreviewContainer) return;
      
      // 獲取模態視窗內容的高度
      const modalContentHeight = templateModalContent.offsetHeight;
      // 獲取標題列高度（約 60px）
      const headerHeight = 60;
      // 獲取底部邊距（約 16px）
      const padding = 16;
      // 獲取範本列表區域的高度（如果存在）
      const listHeight = templateList ? templateList.offsetHeight : 0;
      // 獲取範本列表區域的 margin-bottom（約 16px）
      const listMarginBottom = 16;
      
      // 計算預覽容器的可用高度
      // 總高度 - 標題列 - 底部邊距 - 範本列表區域（如果左側有列表）
      const availableHeight = modalContentHeight - headerHeight - padding * 2;
      
      // 設置預覽容器的最大高度
      const previewContent = templatePreviewContainer.querySelector('.preview-content');
      if (previewContent) {
        previewContent.style.maxHeight = `${availableHeight}px`;
      }
    }
    
    // 監聽模態視窗大小變化
    let templateModalResizeObserver = null;
    if (templateModal) {
      const templateModalContent = document.getElementById("template-modal-content");
      if (templateModalContent && window.ResizeObserver) {
        templateModalResizeObserver = new ResizeObserver(() => {
          updateTemplatePreviewHeight();
        });
        templateModalResizeObserver.observe(templateModalContent);
      }
    }

    function closeTemplateModal() {
      if (templateModal) {
        templateModal.classList.remove("show");
        document.body.style.overflow = "";
      }
    }

    if (templateModalClose) {
      templateModalClose.addEventListener("click", closeTemplateModal);
    }
    if (templateModalOverlay) {
      templateModalOverlay.addEventListener("click", closeTemplateModal);
    }

    // 載入範本按鈕
    if (btnLoadTemplate) {
      btnLoadTemplate.addEventListener("click", openTemplateModal);
    }

    // 選擇範本資料夾
    if (btnSelectTemplateFolder) {
      btnSelectTemplateFolder.addEventListener("click", async () => {
        if (window.showDirectoryPicker) {
          try {
            templateDirectoryHandle = await window.showDirectoryPicker();
            const folderName = templateDirectoryHandle.name;
            if (templateFolderPath) {
              templateFolderPath.textContent = `已選擇：${folderName}`;
            }
            // 顯示「產生檔案list」按鈕（僅在本地檔案協議時）
            if (btnGenerateTemplateList && isLocalFileProtocol()) {
              btnGenerateTemplateList.style.display = 'block';
            }
            await loadTemplateList();
          } catch (error) {
            if (error.name !== "AbortError") {
              console.error("選擇資料夾失敗:", error);
              alert("選擇資料夾失敗，請重試");
            }
          }
        } else {
          alert("您的瀏覽器不支援選擇資料夾功能，請使用 Chrome 或 Edge 瀏覽器");
        }
      });
    }

    // 產生 template-list.json
    if (btnGenerateTemplateList) {
      btnGenerateTemplateList.addEventListener("click", async () => {
        if (!templateDirectoryHandle) {
          alert("請先選擇範本資料夾");
          return;
        }

        if (!window.showDirectoryPicker) {
          alert("您的瀏覽器不支援此功能，請使用 Chrome 或 Edge 瀏覽器");
          return;
        }

        try {
          // 掃描資料夾中的所有 JSON 檔案
          const jsonFiles = [];
          for await (const [name, handle] of templateDirectoryHandle.entries()) {
            if (handle.kind === 'file' && name.toLowerCase().endsWith('.json') && name !== 'template-list.json') {
              jsonFiles.push(name);
            }
          }

          if (jsonFiles.length === 0) {
            alert("資料夾中沒有找到 JSON 範本檔案");
            return;
          }

          // 按檔名排序
          jsonFiles.sort((a, b) => a.localeCompare(b));

          // 創建 template-list.json 內容
          const listContent = JSON.stringify(jsonFiles, null, 2);

          // 檢查檔案是否已存在
          let fileHandle;
          try {
            fileHandle = await templateDirectoryHandle.getFileHandle('template-list.json', { create: true });
          } catch (error) {
            // 如果檔案已存在，獲取現有檔案 handle
            fileHandle = await templateDirectoryHandle.getFileHandle('template-list.json');
          }

          // 請求寫入權限
          const writable = await fileHandle.createWritable();
          await writable.write(listContent);
          await writable.close();

          showToast(`已產生 template-list.json，包含 ${jsonFiles.length} 個範本檔案`);
          
          // 重新載入範本列表
          await loadTemplateList();
        } catch (error) {
          console.error("產生 template-list.json 失敗:", error);
          alert(`產生檔案失敗：${error.message || "無法寫入檔案"}`);
        }
      });
    }

    // 載入範本列表
    async function loadTemplateList() {
      if (!templateList) return;

      try {
        templateList.innerHTML = '<p style="text-align: center; color: #999; padding: 32px;">載入中...</p>';
        
        let files = [];
        
        // 優先檢查是否已選擇本機資料夾（無論協議類型）
        if (templateDirectoryHandle) {
          // 如果已選擇本機資料夾，使用 File System Access API
          for await (const [name, handle] of templateDirectoryHandle.entries()) {
            if (handle.kind === 'file' && name.toLowerCase().endsWith('.json')) {
              const file = await handle.getFile();
              files.push({
                name: name,
                handle: handle,
                size: file.size,
                isLocal: true
              });
            }
          }
        } else if (isLocalFileProtocol()) {
          // 如果是本地檔案協議但未選擇資料夾，提示選擇
          templateList.innerHTML = '<p style="text-align: center; color: #999; padding: 32px;">請先選擇範本資料夾</p>';
          return;
        } else {
          // 如果是 HTTP/HTTPS 協議，使用 fetch API 從相對路徑載入
          try {
            // 嘗試載入 template-list.json（如果存在）
            const listUrl = TEMPLATE_BASE_PATH + 'template-list.json';
            let templateListData = null;
            
            try {
              const response = await fetch(listUrl);
              if (response.ok) {
                templateListData = await response.json();
              }
            } catch (e) {
              // 如果 template-list.json 不存在，嘗試掃描常見的範本檔名
              console.log('template-list.json 不存在，嘗試掃描範本檔案');
            }
            
            // 如果有 template-list.json，使用它
            if (templateListData && Array.isArray(templateListData)) {
              for (const fileName of templateListData) {
                if (fileName.toLowerCase().endsWith('.json')) {
                  try {
                    const fileUrl = TEMPLATE_BASE_PATH + fileName;
                    const response = await fetch(fileUrl, { method: 'HEAD' });
                    if (response.ok) {
                      const contentLength = response.headers.get('content-length');
                      files.push({
                        name: fileName,
                        url: fileUrl,
                        size: contentLength ? parseInt(contentLength) : 0,
                        isLocal: false
                      });
                    }
                  } catch (e) {
                    console.log(`無法載入範本檔案: ${fileName}`, e);
                  }
                }
              }
            } else {
              // 如果沒有 template-list.json，嘗試載入常見的範本檔名
              const commonNames = ['default.json', 'sample.json', 'template.json', 'example.json'];
              for (const fileName of commonNames) {
                try {
                  const fileUrl = TEMPLATE_BASE_PATH + fileName;
                  const response = await fetch(fileUrl, { method: 'HEAD' });
                  if (response.ok) {
                    const contentLength = response.headers.get('content-length');
                    files.push({
                      name: fileName,
                      url: fileUrl,
                      size: contentLength ? parseInt(contentLength) : 0,
                      isLocal: false
                    });
                  }
                } catch (e) {
                  // 檔案不存在，忽略
                }
              }
            }
          } catch (error) {
            console.error("從 HTTP/HTTPS 載入範本列表失敗:", error);
            throw error;
          }
        }

        if (files.length === 0) {
          templateList.innerHTML = '<p style="text-align: center; color: #999; padding: 32px;">沒有找到 JSON 範本檔案</p>';
          return;
        }

        // 按檔名排序
        files.sort((a, b) => a.name.localeCompare(b.name));

        // 顯示範本列表
        templateList.innerHTML = files.map(file => {
          const sizeKB = file.size > 0 ? (file.size / 1024).toFixed(2) : '?';
          return `
            <div class="template-item" data-file-name="${file.name}">
              <div style="flex: 1;">
                <div class="template-item-name">${file.name}</div>
                <div class="template-item-size">${sizeKB} KB</div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="template-load-btn" data-file-name="${file.name}" style="padding: 4px 12px; background: linear-gradient(135deg, var(--accent) 0%, var(--header-dark) 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; white-space: nowrap;">載入</button>
              </div>
            </div>
          `;
        }).join('');

        // 為每個範本項目添加點擊事件（點擊時直接預覽）
        templateList.querySelectorAll('.template-item').forEach(item => {
          item.addEventListener('click', async (e) => {
            // 如果點擊的是載入按鈕，則載入範本
            if (e.target.classList.contains('template-load-btn')) {
              e.stopPropagation();
              const fileName = e.target.dataset.fileName;
              await loadTemplate(fileName);
            } else {
              // 否則預覽範本
              const fileName = item.dataset.fileName;
              await previewTemplate(fileName);
            }
          });
        });

        // 為載入按鈕添加事件（防止事件冒泡）
        templateList.querySelectorAll('.template-load-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const fileName = btn.dataset.fileName;
            await loadTemplate(fileName);
          });
        });
      } catch (error) {
        console.error("載入範本列表失敗:", error);
        templateList.innerHTML = '<p style="text-align: center; color: #dc2626; padding: 32px;">載入範本列表失敗：' + error.message + '</p>';
      }
    }

    // 預覽範本
    async function previewTemplate(fileName) {
      const templatePreviewContainer = document.getElementById("template-preview-container");
      if (!templatePreviewContainer) return;

      try {
        templatePreviewContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 32px;">載入預覽中...</p>';
        
        // 移除其他項目的選中狀態
        templateList.querySelectorAll('.template-item').forEach(item => {
          item.classList.remove('selected');
        });
        
        // 標記當前選中的項目
        const selectedItem = templateList.querySelector(`.template-item[data-file-name="${fileName}"]`);
        if (selectedItem) {
          selectedItem.classList.add('selected');
        }

        let layoutData = null;
        
        // 優先檢查是否已選擇本機資料夾（無論協議類型）
        if (templateDirectoryHandle) {
          // 如果已選擇本機資料夾，使用 File System Access API
          const fileHandle = await templateDirectoryHandle.getFileHandle(fileName);
          const file = await fileHandle.getFile();
          
          const reader = new FileReader();
          reader.onload = () => {
            try {
              // 解析 JSON
              let payload;
              try {
                payload = JSON.parse(reader.result);
              } catch (parseError) {
                throw new Error("檔案不是有效的 JSON 格式");
              }
              
              if (!payload) {
                throw new Error("檔案內容為空");
              }
              
              // 標準化資料格式
              layoutData = normalizeLayoutData(payload);
              
              // 驗證資料結構
              if (!layoutData.layout) {
                throw new Error("找不到 layout 資料");
              }
              
              if (!Array.isArray(layoutData.layout.panels)) {
                throw new Error("panels 必須是陣列格式");
              }
              
              // 生成預覽 HTML
              generatePreviewHTMLFromLayout(layoutData).then(previewHTML => {
              templatePreviewContainer.innerHTML = `
                <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                  <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--header-dark);">${fileName}</h3>
                  <button id="btn-load-from-preview" data-file-name="${fileName}" style="padding: 8px 16px; background: linear-gradient(135deg, var(--accent) 0%, var(--header-dark) 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                    載入到畫布
                  </button>
                </div>
                <div class="preview-content" style="flex: 1; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 16px; background: var(--preview-bg); min-height: 0;">
                  ${previewHTML}
                </div>
              `;
              
              // 更新預覽容器高度（確保預覽內容適應視窗大小）
              updateTemplatePreviewHeight();
              
              // 為載入按鈕添加事件
              const loadBtn = document.getElementById("btn-load-from-preview");
              if (loadBtn) {
                loadBtn.addEventListener("click", async () => {
                  await loadTemplate(fileName);
                });
              }
            }).catch(error => {
              console.error("生成預覽 HTML 失敗:", error);
              templatePreviewContainer.innerHTML = `<p style="text-align: center; color: #dc2626; padding: 32px;">預覽失敗：${error.message || "生成預覽時發生錯誤"}</p>`;
            });
          } catch (error) {
            console.error("預覽範本錯誤:", error);
            templatePreviewContainer.innerHTML = `<p style="text-align: center; color: #dc2626; padding: 32px;">預覽失敗：${error.message || "檔案格式不正確"}</p>`;
          }
        };
        
          reader.onerror = () => {
            templatePreviewContainer.innerHTML = '<p style="text-align: center; color: #dc2626; padding: 32px;">讀取檔案失敗，請確認檔案可正常讀取</p>';
          };
          
          // 讀取檔案內容
          reader.readAsText(file, "utf-8");
          return; // 本機檔案使用異步回調，提前返回
        } else if (isLocalFileProtocol()) {
          // 如果是本地檔案協議但未選擇資料夾，提示選擇
          alert("請先選擇範本資料夾");
          return;
        } else {
          // 如果是 HTTP/HTTPS 協議，使用 fetch API
          const fileUrl = TEMPLATE_BASE_PATH + fileName;
          const response = await fetch(fileUrl);
          
          if (!response.ok) {
            throw new Error(`無法載入範本檔案: ${response.statusText}`);
          }
          
          const payload = await response.json();
          
          if (!payload) {
            throw new Error("檔案內容為空");
          }
          
          // 標準化資料格式
          layoutData = normalizeLayoutData(payload);
          
          // 驗證資料結構
          if (!layoutData.layout) {
            throw new Error("找不到 layout 資料");
          }
          
          if (!Array.isArray(layoutData.layout.panels)) {
            throw new Error("panels 必須是陣列格式");
          }
          
          // 生成預覽 HTML
          generatePreviewHTMLFromLayout(layoutData).then(previewHTML => {
            templatePreviewContainer.innerHTML = `
              <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--header-dark);">${fileName}</h3>
                <button id="btn-load-from-preview" data-file-name="${fileName}" style="padding: 8px 16px; background: linear-gradient(135deg, var(--accent) 0%, var(--header-dark) 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                  載入到畫布
                </button>
              </div>
              <div class="preview-content" style="flex: 1; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 16px; background: var(--preview-bg); min-height: 0;">
                ${previewHTML}
              </div>
            `;
            
            // 更新預覽容器高度
            updateTemplatePreviewHeight();
            
            // 為載入按鈕添加事件
            const loadBtn = document.getElementById("btn-load-from-preview");
            if (loadBtn) {
              loadBtn.addEventListener("click", async () => {
                await loadTemplate(fileName);
              });
            }
          }).catch(error => {
            console.error("生成預覽 HTML 失敗:", error);
            templatePreviewContainer.innerHTML = `<p style="text-align: center; color: #dc2626; padding: 32px;">預覽失敗：${error.message || "生成預覽時發生錯誤"}</p>`;
          });
        }
      } catch (error) {
        console.error("預覽範本失敗:", error);
        templatePreviewContainer.innerHTML = `<p style="text-align: center; color: #dc2626; padding: 32px;">預覽失敗：${error.message || "無法讀取檔案"}</p>`;
      }
    }

    // 從佈局資料生成預覽 HTML（使用臨時隱藏畫布，不影響主畫布）
    let previewGenerationInProgress = false;
    
    function generatePreviewHTMLFromLayout(layoutData) {
      // 如果正在生成預覽，取消之前的操作
      if (previewGenerationInProgress) {
        return Promise.reject(new Error("預覽生成中，請稍候"));
      }
      
      return new Promise((resolve, reject) => {
        previewGenerationInProgress = true;
        
        // 保存當前畫布狀態
        const currentTitle = documentTitleInput.value;
        const currentLayout = collectLayout();
        
        // 在應用佈局之前就隱藏主畫布，避免任何視覺閃爍
        const originalCanvasVisibility = canvas.style.visibility;
        const originalCanvasOpacity = canvas.style.opacity;
        const originalCanvasPosition = canvas.style.position;
        const originalCanvasLeft = canvas.style.left;
        const originalCanvasHeight = canvas.style.height;
        
        // 使用多種方法確保畫布完全隱藏且不佔用空間
        canvas.style.visibility = 'hidden';
        canvas.style.opacity = '0';
        canvas.style.position = 'absolute';
        canvas.style.left = '-9999px';
        canvas.style.height = '0';
        canvas.style.overflow = 'hidden';
        
        // 使用 requestAnimationFrame 確保樣式已應用
        requestAnimationFrame(() => {
          try {
            // 臨時應用範本佈局到畫布
            applyLayout(layoutData);
            
            // 等待 DOM 更新完成後生成預覽
            requestAnimationFrame(() => {
              setTimeout(() => {
                try {
                  // 生成預覽 HTML
                  const previewHTML = generatePreviewHTML();
                  
                  // 立即恢復原始畫布狀態（在顯示畫布之前）
                  if (currentLayout && currentLayout.layout) {
                    applyLayout(currentLayout);
                  } else {
                    // 如果沒有原始佈局，只恢復標題
                    documentTitleInput.value = currentTitle;
                    ensurePlaceholder();
                  }
                  
                  // 等待恢復完成後再顯示畫布
                  requestAnimationFrame(() => {
                    // 恢復畫布顯示
                    canvas.style.visibility = originalCanvasVisibility || '';
                    canvas.style.opacity = originalCanvasOpacity || '';
                    canvas.style.position = originalCanvasPosition || '';
                    canvas.style.left = originalCanvasLeft || '';
                    canvas.style.height = originalCanvasHeight || '';
                    canvas.style.overflow = '';
                    
                    previewGenerationInProgress = false;
                    resolve(previewHTML);
                  });
                } catch (error) {
                  console.error("生成預覽 HTML 失敗:", error);
                  // 恢復原始狀態
                  try {
                    if (currentLayout && currentLayout.layout) {
                      applyLayout(currentLayout);
                    } else {
                      documentTitleInput.value = currentTitle;
                      ensurePlaceholder();
                    }
                  } catch (restoreError) {
                    console.error("恢復畫布失敗:", restoreError);
                  }
                  
                  // 恢復畫布顯示
                  canvas.style.visibility = originalCanvasVisibility || '';
                  canvas.style.opacity = originalCanvasOpacity || '';
                  canvas.style.position = originalCanvasPosition || '';
                  canvas.style.left = originalCanvasLeft || '';
                  canvas.style.height = originalCanvasHeight || '';
                  canvas.style.overflow = '';
                  
                  previewGenerationInProgress = false;
                  reject(error);
                }
              }, 50); // 減少等待時間，因為已經使用了 requestAnimationFrame
            });
          } catch (error) {
            console.error("應用佈局失敗:", error);
            // 恢復原始狀態
            try {
              if (currentLayout && currentLayout.layout) {
                applyLayout(currentLayout);
              } else {
                documentTitleInput.value = currentTitle;
                ensurePlaceholder();
              }
            } catch (restoreError) {
              console.error("恢復畫布失敗:", restoreError);
            }
            
            // 恢復畫布顯示
            canvas.style.visibility = originalCanvasVisibility || '';
            canvas.style.opacity = originalCanvasOpacity || '';
            canvas.style.position = originalCanvasPosition || '';
            canvas.style.left = originalCanvasLeft || '';
            canvas.style.height = originalCanvasHeight || '';
            canvas.style.overflow = '';
            
            previewGenerationInProgress = false;
            reject(error);
          }
        });
      });
    }

    // 載入範本
    async function loadTemplate(fileName) {
      try {
        let payload = null;
        
        // 優先檢查是否已選擇本機資料夾（無論協議類型）
        if (templateDirectoryHandle) {
          // 如果已選擇本機資料夾，使用 File System Access API
          const fileHandle = await templateDirectoryHandle.getFileHandle(fileName);
          const file = await fileHandle.getFile();
          
          const reader = new FileReader();
          reader.onload = () => {
            try {
              // 解析 JSON
              let payload;
              try {
                payload = JSON.parse(reader.result);
              } catch (parseError) {
                throw new Error("檔案不是有效的 JSON 格式");
              }
              
              if (!payload) {
                throw new Error("檔案內容為空");
              }
              
              // 標準化資料格式
              let layoutData = normalizeLayoutData(payload);
              
              // 驗證資料結構
              if (!layoutData.layout) {
                throw new Error("找不到 layout 資料");
              }
              
              if (!Array.isArray(layoutData.layout.panels)) {
                throw new Error("panels 必須是陣列格式");
              }
              
              // 應用佈局
              applyLayout(layoutData);
              
              // 清除 currentFileHandle（因為是範本，不是開啟的檔案）
              currentFileHandle = null;
              updateSaveButtonState();
              
              // 關閉模態視窗
              closeTemplateModal();
              
              showToast("範本已載入");
            } catch (error) {
              console.error("載入範本錯誤:", error);
              alert(`載入範本失敗：${error.message || "檔案格式不正確"}`);
            }
          };
          
          reader.onerror = () => {
            alert("讀取檔案失敗，請確認檔案可正常讀取");
          };
          
          // 讀取檔案內容
          reader.readAsText(file, "utf-8");
          return; // 本機檔案使用異步回調，提前返回
        } else if (isLocalFileProtocol()) {
          // 如果是本地檔案協議但未選擇資料夾，提示選擇
          alert("請先選擇範本資料夾");
          return;
        }
        
        // 如果是 HTTP/HTTPS 協議，使用 fetch API
        const fileUrl = TEMPLATE_BASE_PATH + fileName;
        const response = await fetch(fileUrl);
        
        if (!response.ok) {
          throw new Error(`無法載入範本檔案: ${response.statusText}`);
        }
        
        payload = await response.json();
        
        if (!payload) {
          throw new Error("檔案內容為空");
        }
        
        // 標準化資料格式
        let layoutData = normalizeLayoutData(payload);
        
        // 驗證資料結構
        if (!layoutData.layout) {
          throw new Error("找不到 layout 資料");
        }
        
        if (!Array.isArray(layoutData.layout.panels)) {
          throw new Error("panels 必須是陣列格式");
        }
        
        // 應用佈局
        applyLayout(layoutData);
        
        // 清除 currentFileHandle（因為是範本，不是開啟的檔案）
        currentFileHandle = null;
        updateSaveButtonState();
        
        // 關閉模態視窗
        closeTemplateModal();
        
        showToast("範本已載入");
      } catch (error) {
        console.error("載入範本失敗:", error);
        alert(`載入範本失敗：${error.message || "無法讀取檔案"}`);
      }
    }

    // 欄位規格彈窗相關元素
    const fieldSpecModal = document.getElementById("field-spec-modal");
    const btnFieldSpecModal = document.getElementById("btn-field-spec-modal");
    const fieldSpecModalClose = fieldSpecModal.querySelector(".field-spec-modal-close");
    const fieldSpecModalOverlay = fieldSpecModal.querySelector(".field-spec-modal-overlay");
    const fieldSpecModalCancel = document.getElementById("field-spec-modal-cancel");
    const fieldSpecModalSave = document.getElementById("field-spec-modal-save");
    const modalPropLength = document.getElementById("modal-prop-length");
    const modalPropFieldType = document.getElementById("modal-prop-field-type");
    const modalPropDefault = document.getElementById("modal-prop-default");
    const modalPropRequired = document.getElementById("modal-prop-required");
    const modalPropReadonly = document.getElementById("modal-prop-readonly");
    const modalPropPrimaryKey = document.getElementById("modal-prop-primary-key");
    const modalPropSelectOptions = document.getElementById("modal-prop-select-options");
    // const modalPropTcode = document.getElementById("modal-prop-tcode"); // 已移除關聯功能(T-Code)屬性
    const modalPropRelationField = document.getElementById("modal-prop-relation-field");
    const modalPropOtherNote = document.getElementById("modal-prop-other-note");

    // 打開欄位規格彈窗
    function openFieldSpecModal() {
      // 檢查是否有選中的欄位或 grid header cell
      if (!selectedField && !selectedGridHeaderCell) {
        showToast("請先選取欄位");
        return;
      }

      // 獲取欄位標題並更新彈窗標題
      const fieldTitleEl = fieldSpecModal.querySelector(".field-spec-modal-field-title");
      let fieldTitle = "";
      
      if (selectedField) {
        const labelText = selectedField.querySelector(".label-text");
        if (labelText) {
          fieldTitle = labelText.textContent.trim() || "未命名欄位";
        }
      } else if (selectedGridHeaderCell) {
        const titleEl = selectedGridHeaderCell.querySelector(".header-title");
        if (titleEl) {
          let titleText = titleEl.textContent.trim() || "未命名欄位";
          // 如果標題有括號（唯讀狀態），提取實際標題
          if (titleText.startsWith("(") && titleText.endsWith(")")) {
            titleText = titleText.slice(1, -1).trim();
          }
          fieldTitle = titleText;
        }
      }
      
      if (fieldTitleEl) {
        fieldTitleEl.textContent = fieldTitle ? `${fieldTitle} ` : "";
      }

      // 從右側屬性面板載入數據到彈窗
      modalPropLength.value = propLength.value || "N/A";
      modalPropFieldType.value = propFieldType.value || "real";
      modalPropDefault.value = propDefault.value || "";
      modalPropRequired.checked = propRequired.checked;
      modalPropReadonly.checked = propReadonly.checked;
      modalPropPrimaryKey.checked = propPrimaryKey.checked;
      modalPropSelectOptions.value = propSelectOptions.value || "";
      // modalPropTcode 已移除
      modalPropRelationField.value = propRelationField.value || "";
      modalPropOtherNote.value = propOtherNote.value || "N/A";

      fieldSpecModal.classList.add("show");
      document.body.style.overflow = "hidden";
    }

    // 關閉欄位規格彈窗
    function closeFieldSpecModal() {
      fieldSpecModal.classList.remove("show");
      document.body.style.overflow = "";
    }

    // 保存欄位規格設定
    function saveFieldSpecModal() {
      // 將彈窗中的數據同步到右側屬性面板
      propLength.value = modalPropLength.value || "N/A";
      propFieldType.value = modalPropFieldType.value || "real";
      propDefault.value = modalPropDefault.value || "";
      propRequired.checked = modalPropRequired.checked;
      propReadonly.checked = modalPropReadonly.checked;
      propPrimaryKey.checked = modalPropPrimaryKey.checked;
      propSelectOptions.value = modalPropSelectOptions.value || "";
      // propTcode 已移除
      propRelationField.value = modalPropRelationField.value || "";
      propOtherNote.value = modalPropOtherNote.value || "N/A";

      // 觸發相應的事件來更新選中的欄位或 grid header cell
      if (selectedField) {
        propLength.dispatchEvent(new Event("input"));
        propFieldType.dispatchEvent(new Event("change"));
        propDefault.dispatchEvent(new Event("input"));
        propRequired.dispatchEvent(new Event("change"));
        propReadonly.dispatchEvent(new Event("change"));
        propPrimaryKey.dispatchEvent(new Event("change"));
        propSelectOptions.dispatchEvent(new Event("input"));
        // propTcode 已移除
        propRelationField.dispatchEvent(new Event("input"));
        propOtherNote.dispatchEvent(new Event("input"));
      } else if (selectedGridHeaderCell) {
        propLength.dispatchEvent(new Event("input"));
        propFieldType.dispatchEvent(new Event("change"));
        propDefault.dispatchEvent(new Event("input"));
        propRequired.dispatchEvent(new Event("change"));
        propReadonly.dispatchEvent(new Event("change"));
        propPrimaryKey.dispatchEvent(new Event("change"));
        propSelectOptions.dispatchEvent(new Event("input"));
        // propTcode 已移除
        propRelationField.dispatchEvent(new Event("input"));
        propOtherNote.dispatchEvent(new Event("input"));
      }

      closeFieldSpecModal();
      showToast("欄位規格已儲存");
    }

    // 事件監聽器
    btnFieldSpecModal.addEventListener("click", openFieldSpecModal);
    fieldSpecModalClose.addEventListener("click", closeFieldSpecModal);
    fieldSpecModalOverlay.addEventListener("click", closeFieldSpecModal);
    fieldSpecModalCancel.addEventListener("click", closeFieldSpecModal);
    fieldSpecModalSave.addEventListener("click", saveFieldSpecModal);

    // 按 ESC 鍵關閉欄位規格彈窗
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && fieldSpecModal.classList.contains("show")) {
        closeFieldSpecModal();
      }
    });

    btnClear.addEventListener("click", () => {
      if (confirm("確定要清空畫布？")) {
        canvas.querySelectorAll(".panel").forEach((panel) => panel.remove());
        selectField(null);
        selectGridHeaderCell(null);
        setActivePanel(null);
        ensurePlaceholder();
        // 清空功能標題並設置預設值
        const documentTitleInput = document.getElementById("document-title");
        if (documentTitleInput) {
          documentTitleInput.value = "功能名稱";
        }
        // 清除當前檔案 handle（清空畫布後，畫布不再是從開啟舊檔來的）
        currentFileHandle = null;
        // 更新存檔按鈕狀態（禁用）
        updateSaveButtonState();
      }
    });

    // 欄位規格預覽彈窗相關元素
    const fieldSpecPreviewModal = document.getElementById("field-spec-preview-modal");
    const fieldSpecPreviewContent = document.getElementById("field-spec-preview-content");
    const fieldSpecPreviewModalClose = fieldSpecPreviewModal.querySelector(".field-spec-preview-modal-close");
    const fieldSpecPreviewModalOverlay = fieldSpecPreviewModal.querySelector(".field-spec-preview-modal-overlay");

    // 生成欄位規格預覽表格（重寫版本：以面板為群組，順序：面板 > 頁籤 > 欄位設定）
    function generateFieldSpecPreview() {
      const layout = collectLayout();
      const panels = layout.layout.panels;
      const documentTitle = layout.layout.title || "銷售訂單";
      
      let html = `<div style="margin-bottom: 32px; padding: 20px 24px; background: linear-gradient(135deg, #C5DDF0 0%, #DDEBF7 100%); border-radius: 12px; box-shadow: 0 4px 12px rgba(139, 180, 216, 0.25);">
        <h3 style="margin: 0; font-size: 1.75rem; font-weight: 700; color: #1e3a5f; letter-spacing: -0.02em;">${documentTitle}</h3>
      </div>`;
      
      // 按面板順序分群
      panels.forEach((panel, panelIndex) => {
        const isGrid = panel.type === "grid-panel";
        const hasTabs = panel.tabs && panel.tabs.length > 0;
        
        // 如果是 [區塊面板(有頁籤)]，按頁籤順序處理
        if (hasTabs && !isGrid) {
          panel.tabs.forEach((tab, tabIndex) => {
            const tabTitle = tab.title || "頁籤";
            
            // 獲取該頁籤的區塊屬性
            const tabTableId = tab.tableId || "A"; // 預設為 "A"
            const tabTableIdDisplay = tab.tableId === "custom" ? (tab.tableIdCustom || "") : 
              (tabTableId ? `${tabTableId} 表` : "A 表");
            const tabParentTable = tab.parentTable || "";
            const tabParentTableDisplay = tab.parentTable === "custom" ? (tab.parentTableCustom || "") : 
              (tabParentTable ? `${tabParentTable} 表` : "");
            const tabDbTable = tab.dbTable || "";
            
            // 生成標題：{區塊屬性.資料表識別} : {區塊屬性.頁籤標題} (關聯的父表:{區塊屬性.關聯的父表}) {區塊屬性.DB資料表名(Eng)}
            let tableTitle = tabTableIdDisplay;
            if (tabTitle) {
              tableTitle += ` : ${tabTitle}`;
            }
            if (tabParentTableDisplay && tabParentTableDisplay !== "N/A") {
              tableTitle += ` (關聯的父表:${tabParentTableDisplay})`;
            }
            if (tabDbTable) {
              tableTitle += ` ${tabDbTable}`;
            }
            tableTitle = tableTitle.trim();
            
            // 獲取該頁籤的欄位（根據 tabIndex 過濾）
            const tabFields = (panel.fields || []).filter(field => field.tabIndex === tabIndex);
            
            html += generatePanelTable(tableTitle, tabFields, panelIndex, tabIndex);
          });
        } else {
          // 無頁籤的面板或 GRID 面板
          const panelTableId = panel.tableId || "A"; // 預設為 "A"
        const panelTableIdDisplay = panel.tableId === "custom" ? (panel.tableIdCustom || "") : 
            (panelTableId ? `${panelTableId} 表` : "A 表");
        const panelParentTable = panel.parentTable || "";
        const panelParentTableDisplay = panel.parentTable === "custom" ? (panel.parentTableCustom || "") : 
            (panelParentTable ? `${panelParentTable} 表` : "");
        const panelDbTable = panel.dbTable || "";
          const panelTabTitle = panel.panelTabTitle || panel.title || ""; // 頁籤標題（無頁籤的面板使用面板標題）
          
          // 生成標題：{區塊屬性.資料表識別} : {區塊屬性.頁籤標題} (關聯的父表:{區塊屬性.關聯的父表}) {區塊屬性.DB資料表名(Eng)}
          let tableTitle = panelTableIdDisplay;
          if (panelTabTitle) {
            tableTitle += ` : ${panelTabTitle}`;
          }
          if (panelParentTableDisplay && panelParentTableDisplay !== "N/A") {
            tableTitle += ` (關聯的父表:${panelParentTableDisplay})`;
          }
          if (panelDbTable) {
            tableTitle += ` ${panelDbTable}`;
          }
          tableTitle = tableTitle.trim();
          
          // 欄位資料
          const fields = isGrid ? (panel.gridColumns || []) : (panel.fields || []);
          
          html += generatePanelTable(tableTitle, fields, panelIndex);
        }
      });
      
      return html;
    }
    
    // 生成單一面板的表格
    function generatePanelTable(tableTitle, fields, panelIndex, tabIndex = null) {
      let html = `<table class="field-spec-preview-table">`;
      
      // 標題行（紅色文字，已由 CSS 處理樣式）
      html += `<caption>${tableTitle || "未命名表格"}</caption>`;
        
      // 表頭（已由 CSS 處理樣式）
        html += `<thead>`;
        html += `<tr>`;
        html += `<th>欄位名稱</th>`;
      html += `<th>長度 (字元)</th>`;
        html += `<th>欄位類型</th>`;
      html += `<th>預設值</th>`;
      html += `<th>必填</th>`;
      html += `<th>唯讀</th>`;
      html += `<th>主鍵</th>`;
      html += `<th>下拉選項</th>`;
      html += `<th>關聯功能 / 關聯欄位 / 返回欄位</th>`;
      html += `<th>其他說明</th>`;
        html += `</tr>`;
        html += `</thead>`;
      
      // 資料行
        html += `<tbody>`;
        
      if (fields.length === 0) {
        html += `<tr><td colspan="10" style="text-align: center; color: #9ca3af; padding: 32px; font-style: italic; background: #f9fafb;">此區塊無欄位</td></tr>`;
      } else {
        fields.forEach((field, fieldIndex) => {
          const fieldName = field.label || field.title || "";
          const dbField = field.dbField || "";
          
          // 欄位類型映射
          const fieldTypeMap = {
            real: "實欄位",
            virtual: "虛欄位",
            relation: "關聯欄位"
          };
          const fieldTypeDisplay = fieldTypeMap[field.fieldType] || "實欄位";
          
          const length = field.length || "N/A";
          const defaultValue = field.defaultValue || "";
          const required = field.required ? "Y" : "";
          const readonly = field.readonly ? "Y" : "";
          const primaryKey = field.primaryKey ? "Y" : "";
          const selectOptions = field.selectOptions || "";
          const relationField = field.relationField || "";
          const otherNote = field.otherNote || "N/A";
          
          // 欄位名稱顯示
          const fieldNameDisplay = fieldName || "";
          
          html += `<tr>`;
          html += `<td>${fieldNameDisplay}</td>`;
          html += `<td>${length}</td>`;
          html += `<td>${fieldTypeDisplay}</td>`;
          html += `<td>${defaultValue}</td>`;
          html += `<td>${required}</td>`;
          html += `<td>${readonly}</td>`;
          html += `<td>${primaryKey}</td>`;
          html += `<td>${selectOptions}</td>`;
          html += `<td style="white-space: pre-line;">${relationField}</td>`;
          html += `<td style="white-space: pre-line;">${otherNote}</td>`;
          html += `</tr>`;
        });
      }
        
        html += `</tbody>`;
        html += `</table>`;
      
      return html;
    }

    // 打開欄位規格預覽彈窗
    function openFieldSpecPreviewModal() {
      const panels = canvas.querySelectorAll(".panel");
      if (panels.length === 0) {
        showToast("請先添加區塊面板");
        return;
      }
      
      const previewHTML = generateFieldSpecPreview();
      fieldSpecPreviewContent.innerHTML = previewHTML;
      
      fieldSpecPreviewModal.classList.add("show");
      document.body.style.overflow = "hidden";
    }

    // 關閉欄位規格預覽彈窗
    function closeFieldSpecPreviewModal() {
      fieldSpecPreviewModal.classList.remove("show");
      document.body.style.overflow = "";
    }

    // 匯出 Excel 按鈕
    const btnExportSpecExcel = document.getElementById("btn-export-spec-excel");
    
    // 匯出規格預覽為 Excel
    async function exportSpecToExcel() {
      // 檢查 XLSX 是否已載入
      if (typeof XLSX === 'undefined') {
        showToast("Excel 匯出功能載入中，請稍候再試...");
        console.error('XLSX library is not defined');
        // 等待一下讓腳本有時間載入
        await new Promise(resolve => setTimeout(resolve, 500));
        if (typeof XLSX === 'undefined') {
          showToast("Excel 匯出功能載入失敗，請重新整理頁面");
          return;
        }
      }
      
      const layout = collectLayout();
      const panels = layout.layout.panels;
      const documentTitle = layout.layout.title || "銷售訂單";
      
      // 生成檔名：功能標題_yyMMdd_欄位規格
      const now = new Date();
      const year = String(now.getFullYear()).slice(-2);
      const month = String(now.getMonth() + 1).padStart(2, "0");
      const day = String(now.getDate()).padStart(2, "0");
      const fileName = `${documentTitle}_${year}${month}${day}_欄位規格`;
      
      // 創建工作簿
      const wb = XLSX.utils.book_new();
      
      // 收集所有面板和頁籤的數據到一個數組中
      const allPanelData = [];
      
      // 按面板順序處理
      panels.forEach((panel, panelIndex) => {
        const isGrid = panel.type === "grid-panel";
        const hasTabs = panel.tabs && panel.tabs.length > 0;
        
        // 如果是 [區塊面板(有頁籤)]，按頁籤順序處理
        if (hasTabs && !isGrid) {
          panel.tabs.forEach((tab, tabIndex) => {
            const tabTitle = tab.title || "頁籤";
            
            // 獲取該頁籤的區塊屬性
            const tabTableId = tab.tableId || "A";
            const tabTableIdDisplay = tab.tableId === "custom" ? (tab.tableIdCustom || "") : 
              (tabTableId ? `${tabTableId} 表` : "A 表");
            const tabParentTable = tab.parentTable || "";
            const tabParentTableDisplay = tab.parentTable === "custom" ? (tab.parentTableCustom || "") : 
              (tabParentTable ? `${tabParentTable} 表` : "");
            const tabDbTable = tab.dbTable || "";
            
            // 生成標題
            let tableTitle = tabTableIdDisplay;
            if (tabTitle) {
              tableTitle += ` : ${tabTitle}`;
            }
            if (tabParentTableDisplay && tabParentTableDisplay !== "N/A") {
              tableTitle += ` (關聯的父表:${tabParentTableDisplay})`;
            }
            if (tabDbTable) {
              tableTitle += ` ${tabDbTable}`;
            }
            tableTitle = tableTitle.trim();
            
            // 獲取該頁籤的欄位
            const tabFields = (panel.fields || []).filter(field => field.tabIndex === tabIndex);
            
            // 處理 grid-tab 類型的欄位：將 gridColumns 展開為欄位列表
            const processedFields = [];
            tabFields.forEach(field => {
              if (field.type === "grid-tab" && field.gridColumns && field.gridColumns.length > 0) {
                // 將 gridColumns 展開為欄位列表
                processedFields.push(...field.gridColumns);
              } else if (field.type !== "grid-tab") {
                // 非 grid-tab 類型的欄位直接加入
                processedFields.push(field);
              }
            });
            
            // 生成工作表數據
            const sheetData = generateSheetData(tableTitle, processedFields);
            
            // 如果不是第一個面板/頁籤，添加空行分隔
            if (allPanelData.length > 0) {
              allPanelData.push([]); // 空行分隔
            }
            
            // 將數據添加到總數組中
            allPanelData.push(...sheetData);
          });
        } else {
          // 無頁籤的面板或 GRID 面板
          const panelTableId = panel.tableId || "A";
          const panelTableIdDisplay = panel.tableId === "custom" ? (panel.tableIdCustom || "") : 
            (panelTableId ? `${panelTableId} 表` : "A 表");
          const panelParentTable = panel.parentTable || "";
          const panelParentTableDisplay = panel.parentTable === "custom" ? (panel.parentTableCustom || "") : 
            (panelParentTable ? `${panelParentTable} 表` : "");
          const panelDbTable = panel.dbTable || "";
          const panelTabTitle = panel.panelTabTitle || panel.title || "";
          
          // 生成標題
          let tableTitle = panelTableIdDisplay;
          if (panelTabTitle) {
            tableTitle += ` : ${panelTabTitle}`;
          }
          if (panelParentTableDisplay && panelParentTableDisplay !== "N/A") {
            tableTitle += ` (關聯的父表:${panelParentTableDisplay})`;
          }
          if (panelDbTable) {
            tableTitle += ` ${panelDbTable}`;
          }
          tableTitle = tableTitle.trim();
          
          // 欄位資料
          let fields = isGrid ? (panel.gridColumns || []) : (panel.fields || []);
          
          // 處理 grid-tab 類型的欄位：將 gridColumns 展開為欄位列表
          if (!isGrid) {
            const processedFields = [];
            fields.forEach(field => {
              if (field.type === "grid-tab" && field.gridColumns && field.gridColumns.length > 0) {
                // 將 gridColumns 展開為欄位列表
                processedFields.push(...field.gridColumns);
              } else if (field.type !== "grid-tab") {
                // 非 grid-tab 類型的欄位直接加入
                processedFields.push(field);
              }
            });
            fields = processedFields;
          }
          
          // 生成工作表數據
          const sheetData = generateSheetData(tableTitle, fields);
          
          // 如果不是第一個面板/頁籤，添加空行分隔
          if (allPanelData.length > 0) {
            allPanelData.push([]); // 空行分隔
          }
          
          // 將數據添加到總數組中
          allPanelData.push(...sheetData);
        }
      });
      
      // 創建單一工作表，包含所有數據
      const ws = XLSX.utils.aoa_to_sheet(allPanelData);
      
      // 設置列寬
      ws['!cols'] = [
        { wch: 15 }, // 欄位名稱
        { wch: 12 }, // 長度 (字元)
        { wch: 12 }, // 欄位類型
        { wch: 12 }, // 預設值
        { wch: 8 },  // 必填
        { wch: 8 },  // 唯讀
        { wch: 8 },  // 主鍵
        { wch: 15 }, // 下拉選項
        { wch: 30 }, // 關聯功能 / 關聯欄位 / 返回欄位
        { wch: 20 }  // 其他說明
      ];
      
      // 應用樣式和邊框（需要識別每個標題行和表頭行）
      applyExcelStylesForMergedSheet(ws, allPanelData);
      
      // 添加單一工作表到工作簿（使用功能名稱作為頁籤名稱）
      const sheetName = documentTitle.substring(0, 31); // Excel 工作表名稱限制 31 個字符
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
      
      // 匯出檔案（使用檔案選擇對話框並記憶路徑）
      await saveExcelFile(wb, fileName);
    }
    
    // 儲存 Excel 檔案（使用檔案選擇對話框並記憶路徑）
    async function saveExcelFile(wb, defaultFileName) {
      try {
        // 檢查是否支援 File System Access API
        if ('showSaveFilePicker' in window) {
          // 嘗試從 IndexedDB 讀取上次的目錄 handle
          let startIn = undefined;
          try {
            const savedHandle = await getSavedDirectoryHandle();
            if (savedHandle) {
              startIn = savedHandle;
            }
          } catch (e) {
            console.log('無法讀取記憶的目錄:', e);
          }
          
          // 構建選項對象
          const pickerOptions = {
            suggestedName: defaultFileName + '.xlsx',
            types: [{
              description: 'Excel 檔案',
              accept: {
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']
              }
            }]
          };
          
          // 只有當 startIn 不是 undefined 時才添加它
          if (startIn !== undefined) {
            pickerOptions.startIn = startIn;
          }
          
          // 使用 File System Access API
          const fileHandle = await window.showSaveFilePicker(pickerOptions);
          
          // 將工作簿轉換為二進位資料（使用 xlsx-js-style 的 write 方法以保留樣式）
          const excelBuffer = XLSX.write(wb, { 
            type: 'array', 
            bookType: 'xlsx',
            cellStyles: true // 確保樣式被寫入
          });
          
          // 寫入檔案
          const writable = await fileHandle.createWritable();
          await writable.write(new Blob([excelBuffer], { 
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
          }));
          await writable.close();
          
          // 嘗試記憶檔案所在的目錄
          // 注意：File System Access API 的 FileSystemFileHandle 不支援 getParent() 方法
          // 但我們可以通過請求目錄權限來記憶目錄
          try {
            // 方法：在用戶選擇檔案後，請求選擇目錄來記憶路徑
            // 但這會額外彈出對話框，影響用戶體驗
            // 替代方案：使用瀏覽器的自動記憶功能（大多數瀏覽器會自動記住上次選擇的目錄）
            
            // 實際上，現代瀏覽器（Chrome/Edge）會自動記住 showSaveFilePicker 上次選擇的目錄
            // 所以我們不需要手動記憶，瀏覽器會自動處理
            console.log('檔案已匯出，瀏覽器會自動記住上次選擇的目錄');
            
            // 如果未來需要更精確的控制，可以考慮：
            // 1. 在首次匯出時，額外請求目錄權限（使用 showDirectoryPicker）
            // 2. 將目錄 handle 保存到 IndexedDB
            // 3. 下次匯出時使用保存的目錄 handle 作為 startIn 選項
          } catch (e) {
            console.log('無法記憶目錄:', e);
            // 即使失敗也不影響匯出功能
          }
          
          showToast("Excel 檔案已匯出");
        } else {
          // 降級方案：使用傳統下載方式
          XLSX.writeFile(wb, `${defaultFileName}.xlsx`);
          showToast("Excel 檔案已下載");
        }
      } catch (error) {
        // 如果用戶取消選擇，不顯示錯誤
        if (error.name === 'AbortError') {
          console.log('用戶取消檔案選擇');
          return;
        }
        
        // 其他錯誤：降級到傳統下載方式
        console.warn('File System Access API 失敗，使用傳統下載方式:', error);
        try {
          XLSX.writeFile(wb, `${defaultFileName}.xlsx`);
          showToast("Excel 檔案已下載");
        } catch (downloadError) {
          showToast("匯出失敗：" + downloadError.message);
          console.error('匯出失敗:', downloadError);
        }
      }
    }
    
    // 從 IndexedDB 讀取記憶的目錄 handle（用於開啟舊檔）
    async function getSavedOpenDirectoryHandle() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('FileAccessDB', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['handles'], 'readonly');
          const store = transaction.objectStore('handles');
          const getRequest = store.get('lastOpenDirectory');
          
          getRequest.onsuccess = () => {
            const handle = getRequest.result;
            if (handle) {
              // 驗證 handle 是否仍然有效
              handle.queryPermission({ mode: 'read' }).then(permission => {
                if (permission === 'granted') {
                  resolve(handle);
                } else {
                  resolve(null);
                }
              }).catch(() => resolve(null));
            } else {
              resolve(null);
            }
          };
          getRequest.onerror = () => reject(getRequest.error);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('handles')) {
            db.createObjectStore('handles');
          }
        };
      });
    }
    
    // 儲存目錄 handle 到 IndexedDB（用於開啟舊檔）
    async function saveOpenDirectoryHandle(handle) {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('FileAccessDB', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['handles'], 'readwrite');
          const store = transaction.objectStore('handles');
          
          // 儲存目錄 handle
          const putRequest = store.put(handle, 'lastOpenDirectory');
          
          putRequest.onsuccess = () => {
            console.log('開啟舊檔目錄 handle 已儲存到 IndexedDB');
            resolve();
          };
          putRequest.onerror = () => reject(putRequest.error);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('handles')) {
            db.createObjectStore('handles');
          }
        };
      });
    }
    
    // 從 IndexedDB 讀取記憶的目錄 handle（用於 Excel 匯出）
    async function getSavedDirectoryHandle() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('ExcelExportDB', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['handles'], 'readonly');
          const store = transaction.objectStore('handles');
          const getRequest = store.get('lastDirectory');
          
          getRequest.onsuccess = () => {
            const handle = getRequest.result;
            if (handle) {
              // 驗證 handle 是否仍然有效
              handle.queryPermission({ mode: 'readwrite' }).then(permission => {
                if (permission === 'granted') {
                  resolve(handle);
                } else {
                  resolve(null);
                }
              }).catch(() => resolve(null));
            } else {
              resolve(null);
            }
          };
          getRequest.onerror = () => reject(getRequest.error);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('handles')) {
            db.createObjectStore('handles');
          }
        };
      });
    }
    
    // 儲存目錄 handle 到 IndexedDB
    async function saveDirectoryHandle(handle) {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('ExcelExportDB', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['handles'], 'readwrite');
          const store = transaction.objectStore('handles');
          
          // 儲存目錄 handle
          const putRequest = store.put(handle, 'lastDirectory');
          
          putRequest.onsuccess = () => {
            console.log('目錄 handle 已儲存到 IndexedDB');
            resolve();
          };
          putRequest.onerror = () => reject(putRequest.error);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('handles')) {
            db.createObjectStore('handles');
          }
        };
      });
    }
    
    // 生成工作表數據
    function generateSheetData(tableTitle, fields) {
      const data = [];
      
      // 標題行
      data.push([tableTitle]);
      // 移除空行，標題行後直接接表頭
      
      // 表頭
      data.push([
        "欄位名稱",
        "長度 (字元)",
        "欄位類型",
        "預設值",
        "必填",
        "唯讀",
        "主鍵",
        "下拉選項",
        "關聯功能 / 關聯欄位 / 返回欄位",
        "其他說明"
      ]);
      
      // 資料行
      if (fields.length === 0) {
        data.push(["此區塊無欄位", "", "", "", "", "", "", "", "", ""]);
      } else {
        fields.forEach((field) => {
          const fieldName = field.label || field.title || "";
          const fieldTypeMap = {
            real: "實欄位",
            virtual: "虛欄位",
            relation: "關聯欄位"
          };
          const fieldTypeDisplay = fieldTypeMap[field.fieldType] || "實欄位";
          
          const length = field.length || "N/A";
          const defaultValue = field.defaultValue || "";
          const required = field.required ? "Y" : "";
          const readonly = field.readonly ? "Y" : "";
          const primaryKey = field.primaryKey ? "Y" : "";
          const selectOptions = field.selectOptions || "";
          // 保留換行符號（\n）用於 Excel 顯示
          const relationField = (field.relationField || "").replace(/\r\n/g, '\n').replace(/\r/g, '\n');
          const otherNote = (field.otherNote || "N/A").replace(/\r\n/g, '\n').replace(/\r/g, '\n');
          
          data.push([
            fieldName,
            length,
            fieldTypeDisplay,
            defaultValue,
            required,
            readonly,
            primaryKey,
            selectOptions,
            relationField,
            otherNote
          ]);
        });
      }
      
      return data;
    }
    
    // 應用 Excel 樣式和邊框（用於合併的工作表）
    function applyExcelStylesForMergedSheet(ws, allData) {
      // 檢查是否支援樣式（xlsx-js-style 已載入）
      if (!window._xlsxStyleLoaded || typeof XLSX === 'undefined') {
        console.warn('xlsx-js-style not loaded, skipping styles');
        return;
      }
      
      const range = XLSX.utils.decode_range(ws['!ref']);
      const numCols = range.e.c + 1;
      const totalRows = allData.length;
      
      // 設置行高（預設 30，約 40 像素）
      if (!ws['!rows']) ws['!rows'] = [];
      for (let row = 0; row < totalRows; row++) {
        if (!ws['!rows'][row]) ws['!rows'][row] = {};
        ws['!rows'][row].hpt = 30;
      }
      
      // 遍歷所有行，識別標題行、表頭行和資料行
      let currentRow = 0;
      while (currentRow < totalRows) {
        const rowData = allData[currentRow];
        
        // 跳過空行
        if (!rowData || rowData.length === 0 || (rowData.length === 1 && !rowData[0])) {
          currentRow++;
          continue;
        }
        
        // 檢查是否為標題行（第一個單元格有值，且不是表頭）
        const isTitleRow = rowData[0] && 
                          rowData[0] !== "欄位名稱" && 
                          (currentRow === 0 || !allData[currentRow - 1] || allData[currentRow - 1].length === 0 || !allData[currentRow - 1][0]);
        
        if (isTitleRow) {
          // 標題行樣式
          const titleRow = currentRow;
          
          // 合併標題行單元格（跨所有列）
          if (!ws['!merges']) ws['!merges'] = [];
          ws['!merges'].push({
            s: { r: titleRow, c: 0 },
            e: { r: titleRow, c: numCols - 1 }
          });
          
          // 設置標題行所有單元格的樣式（確保邊框正確顯示）
          for (let col = 0; col < numCols; col++) {
            const cellAddress = XLSX.utils.encode_cell({ r: titleRow, c: col });
            if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: '' };
            
            // 標題行邊框與資料行一樣（thin），底色與表頭一樣（淺藍色）
            const borderStyle = {
              bottom: { style: "thin", color: { rgb: "000000" } },
              top: { style: "thin", color: { rgb: "000000" } },
              left: { style: "thin", color: { rgb: "000000" } },
              right: { style: "thin", color: { rgb: "000000" } }
            };
            
            ws[cellAddress].s = {
              fill: { fgColor: { rgb: "DDEBF7" } }, // 與表頭一樣的淺藍色背景
              font: { bold: true, sz: 14, color: { rgb: "DC2626" } },
              border: borderStyle,
              alignment: { horizontal: "left", vertical: "center" }
            };
          }
          
          currentRow++;
          
          // 下一行應該是表頭行
          if (currentRow < totalRows && allData[currentRow] && allData[currentRow][0] === "欄位名稱") {
            const headerRow = currentRow;
            
            for (let col = 0; col < numCols; col++) {
              const cellAddress = XLSX.utils.encode_cell({ r: headerRow, c: col });
              if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: '' };
              
              ws[cellAddress].s = {
                fill: { fgColor: { rgb: "DDEBF7" } },
                font: { bold: true, sz: 11, color: { rgb: "1E3A5F" } },
                border: {
                  top: { style: "thin", color: { rgb: "000000" } },
                  bottom: { style: "thin", color: { rgb: "000000" } },
                  left: { style: "thin", color: { rgb: "000000" } },
                  right: { style: "thin", color: { rgb: "000000" } }
                },
                alignment: { horizontal: "left", vertical: "center", wrapText: true }
              };
            }
            
            currentRow++;
            
            // 資料行樣式
            while (currentRow < totalRows) {
              const rowData = allData[currentRow];
              
              if (!rowData || rowData.length === 0 || !rowData[0] || 
                  (rowData[0] !== "此區塊無欄位" && rowData[0] !== "" && 
                   rowData[0] !== "欄位名稱" && 
                   (!allData[currentRow - 1] || allData[currentRow - 1].length === 0 || !allData[currentRow - 1][0]))) {
                break;
              }
              
              for (let col = 0; col < numCols; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: currentRow, c: col });
                if (!ws[cellAddress]) continue;
                
                if (!ws[cellAddress].s) ws[cellAddress].s = {};
                
                const isRelationField = col === 8;
                const isOtherNote = col === 9;
                
                ws[cellAddress].s = {
                  fill: { fgColor: { rgb: "FFFFFF" } },
                  font: { sz: 11, color: { rgb: "000000" } },
                  border: {
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } },
                    top: { style: "thin", color: { rgb: "000000" } }
                  },
                  alignment: {
                    horizontal: "left",
                    vertical: "top",
                    wrapText: (isRelationField || isOtherNote) ? true : false
                  }
                };
              }
              
              currentRow++;
            }
          } else {
            currentRow++;
          }
        } else {
          currentRow++;
        }
      }
    }
    
    // 應用 Excel 樣式和邊框
    function applyExcelStyles(ws, totalRows) {
      // 檢查是否支援樣式（xlsx-js-style 已載入）
      if (!window._xlsxStyleLoaded || typeof XLSX === 'undefined') {
        console.warn('xlsx-js-style not loaded, skipping styles');
        return; // 如果樣式庫未載入，跳過樣式應用
      }
      
      const range = XLSX.utils.decode_range(ws['!ref']);
      const numCols = range.e.c + 1;
      
      // 設置行高（預設 30，約 40 像素）
      if (!ws['!rows']) ws['!rows'] = [];
      for (let row = 0; row < totalRows; row++) {
        if (!ws['!rows'][row]) ws['!rows'][row] = {};
        ws['!rows'][row].hpt = 30; // 行高 30（約 40 像素）
      }
      
      // 標題行樣式（第1行，索引0）
      const titleRow = 0;
      // 合併標題行單元格（跨所有列）
      if (!ws['!merges']) ws['!merges'] = [];
      ws['!merges'].push({
        s: { r: titleRow, c: 0 },
        e: { r: titleRow, c: numCols - 1 }
      });
      
      // 設置標題行所有單元格的樣式（確保邊框正確顯示）
      for (let col = 0; col < numCols; col++) {
        const cellAddress = XLSX.utils.encode_cell({ r: titleRow, c: col });
        if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: '' };
        
        // 標題行：紅色文字、邊框與資料行一樣（thin），底色與表頭一樣（淺藍色）
        const borderStyle = {
          bottom: { style: "thin", color: { rgb: "000000" } }, // 細邊框（黑色）
          top: { style: "thin", color: { rgb: "000000" } }, // 細邊框（黑色）
          left: { style: "thin", color: { rgb: "000000" } }, // 細邊框（黑色）
          right: { style: "thin", color: { rgb: "000000" } } // 細邊框（黑色）
        };
        
        ws[cellAddress].s = {
          fill: {
            fgColor: { rgb: "DDEBF7" } // 與表頭一樣的淺藍色背景
          },
          font: {
            bold: true,
            sz: 14,
            color: { rgb: "DC2626" } // 紅色文字（根據圖片）
          },
          border: borderStyle,
          alignment: {
            horizontal: "left",
            vertical: "center"
          }
        };
      }
      
      // 表頭行樣式（第2行，索引1，因為已移除空行）
      const headerRow = 1;
      for (let col = 0; col < numCols; col++) {
        const cellAddress = XLSX.utils.encode_cell({ r: headerRow, c: col });
        if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: '' };
        
        // 表頭：淺藍色背景、深藍色文字、邊框（根據範例檔案）
        const borderStyle = {
          top: { style: "thin", color: { rgb: "000000" } }, // 黑色邊框
          bottom: { style: "thin", color: { rgb: "000000" } },
          left: { style: "thin", color: { rgb: "000000" } },
          right: { style: "thin", color: { rgb: "000000" } } // 確保右邊框也設置
        };
        
        ws[cellAddress].s = {
          fill: {
            fgColor: { rgb: "DDEBF7" } // 淺藍色背景
          },
          font: {
            bold: true,
            sz: 11,
            color: { rgb: "1E3A5F" } // 深藍色文字
          },
          border: borderStyle,
          alignment: {
            horizontal: "left",
            vertical: "center",
            wrapText: true // 允許文字換行
          }
        };
      }
      
      // 資料行樣式（從第3行開始，索引2）
      for (let row = 2; row < totalRows; row++) {
        for (let col = 0; col < numCols; col++) {
          const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
          if (!ws[cellAddress]) continue;
          
          if (!ws[cellAddress].s) {
            ws[cellAddress].s = {};
          }
          
          // 資料行：白色背景、黑色邊框（根據範例檔案）
          const borderStyle = {
            bottom: { style: "thin", color: { rgb: "000000" } }, // 黑色邊框
            left: { style: "thin", color: { rgb: "000000" } },
            right: { style: "thin", color: { rgb: "000000" } }, // 確保右邊框也設置
            top: { style: "thin", color: { rgb: "000000" } }
          };
          
          // 檢查是否為 "關聯功能 / 關聯欄位 / 返回欄位" 或 "其他說明" 欄位（第9和第10欄，索引8和9）
          const isRelationField = col === 8; // 關聯功能 / 關聯欄位 / 返回欄位
          const isOtherNote = col === 9; // 其他說明
          
          ws[cellAddress].s = {
            fill: {
              fgColor: { rgb: "FFFFFF" } // 白色背景
            },
            font: {
              sz: 11,
              color: { rgb: "000000" } // 黑色文字
            },
            border: borderStyle,
            alignment: {
              horizontal: "left",
              vertical: "top", // 頂部對齊，方便多行顯示
              wrapText: (isRelationField || isOtherNote) ? true : false // 這兩個欄位允許換行
            }
          };
        }
      }
    }

    // 事件監聽器
    btnExport.addEventListener("click", openFieldSpecPreviewModal);
    if (btnExportSpecExcel) {
      btnExportSpecExcel.addEventListener("click", exportSpecToExcel);
    }
    fieldSpecPreviewModalClose.addEventListener("click", closeFieldSpecPreviewModal);
    fieldSpecPreviewModalOverlay.addEventListener("click", closeFieldSpecPreviewModal);

    // 按 ESC 鍵關閉欄位規格預覽彈窗
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && fieldSpecPreviewModal.classList.contains("show")) {
        closeFieldSpecPreviewModal();
      }
    });

    function addPanel(config = {}) {
      if (placeholder.parentNode === canvas) {
        placeholder.remove();
      }
      const panel = document.createElement("section");
      panel.className = "panel";
      if (config.type === "grid-panel") {
        panel.classList.add("grid-panel");
      }
      if (config.collapsed) {
        panel.classList.add("collapsed");
      }
      const isGrid = config.type === "grid-panel";
      const isNoTabs = config.type === "panel-no-tabs";
      const tabs = config.tabs || [{ title: config.title || (isGrid ? "GRID 表格" : "基本資料"), active: true }];
      const activeTabIndex = tabs.findIndex(t => t.active) >= 0 ? tabs.findIndex(t => t.active) : 0;
      
      let tabsHTML = "";
      if (!isNoTabs && !isGrid) {
        // 只有非 Grid 面板才顯示頁籤
        tabsHTML = tabs.map((tab, idx) => `
          <div class="panel-tab ${idx === activeTabIndex ? "active" : ""}" data-tab-index="${idx}" draggable="true">
            <input type="text" class="panel-tab-input" value="${tab.title || "頁籤"}" />
            <span class="panel-tab-remove">×</span>
          </div>
        `).join("");
        tabsHTML += `<div class="panel-tab-add">+ 新增頁籤</div>`;
      }

      // 為有頁籤的面板創建多個 tab-body，為無頁籤的面板創建單一 panel-body
      let bodyHTML = "";
      if (!isNoTabs && !isGrid) {
        // 有頁籤的面板：為每個頁籤創建獨立的 tab-body
        bodyHTML = tabs.map((tab, idx) => `
          <div class="tab-body ${idx === activeTabIndex ? "active" : ""}" data-tab-index="${idx}"></div>
        `).join("");
      } else {
        // 無頁籤或 Grid 面板：使用單一 panel-body
        bodyHTML = `<div class="panel-body ${isGrid ? "grid-panel-body" : ""}"></div>`;
      }

      panel.innerHTML = `
        <div class="panel-delete" title="刪除區塊">×</div>
        <div class="panel-header">
          ${!isNoTabs && !isGrid ? `<div class="panel-tabs">${tabsHTML}</div>` : ""}
          <div class="panel-header-controls">
            <div class="panel-drag-handle" title="拖曳排序" draggable="true"></div>
            <button type="button" class="panel-toggle" aria-label="切換區塊展開狀態"></button>
            ${!isGrid ? `<label class="panel-columns">
              欄數
              <select class="panel-column-select">
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="custom">其他...</option>
              </select>
              <input type="number" class="panel-column-custom" min="1" max="20" placeholder="欄數" style="display: none; width: 60px; margin-left: 4px; padding: 4px;" />
            </label>
            <label class="panel-height">
              列高
              <select class="panel-height-select">
                <option value="1">1 列</option>
                <option value="2">2 列</option>
                <option value="3" selected>3 列</option>
                <option value="4">4 列</option>
                <option value="5">5 列</option>
                <option value="6">6 列</option>
                <option value="7">7 列</option>
                <option value="8">8 列</option>
                <option value="custom">其他...</option>
              </select>
              <input type="number" class="panel-height-custom" min="1" placeholder="列數" style="display: none; width: 60px; margin-left: 4px; padding: 4px;" />
            </label>` : ""}
          </div>
        </div>
        ${bodyHTML}
      `;

      // 獲取 body（可能是 panel-body 或 tab-body）
      const body = panel.querySelector(".panel-body") || panel.querySelector(".tab-body.active");
      const toggle = panel.querySelector(".panel-toggle");
      const panelDelete = panel.querySelector(".panel-delete");
      const dragHandle = panel.querySelector(".panel-drag-handle");
      const tabsContainer = panel.querySelector(".panel-tabs");
      const tabInputs = panel.querySelectorAll(".panel-tab-input");
      const tabRemoves = panel.querySelectorAll(".panel-tab-remove");
      const tabAdd = panel.querySelector(".panel-tab-add");
      
      // 如果有 tab-body，設置初始的 activePanelBody
      if (!isNoTabs && !isGrid) {
        const activeTabBody = panel.querySelector(".tab-body.active");
        if (activeTabBody) {
          // 更新面板上的欄數選擇器，顯示當前活動頁籤的欄數
          updatePanelColumnSelect(panel, activeTabBody);
          setActivePanel(activeTabBody);
        }
      }
      const columnSelect = panel.querySelector(".panel-column-select");
      const columnCustom = panel.querySelector(".panel-column-custom");
      const heightSelect = panel.querySelector(".panel-height-select");
      const heightCustom = panel.querySelector(".panel-height-custom");
      const columns = String(config.columns || columnCountSelect.value || "3");
      
      // 面板拖曳排序
      if (dragHandle) {
        dragHandle.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("move-panel", "true");
          e.dataTransfer.effectAllowed = "move";
          panel.classList.add("dragging");
          window._draggedPanel = panel;
        });
        
        dragHandle.addEventListener("dragend", () => {
          panel.classList.remove("dragging");
          canvas.querySelectorAll(".panel").forEach(p => p.classList.remove("drag-over"));
          window._draggedPanel = null;
        });
      }

      if (!isGrid) {
        // 檢查是否為自訂欄數
        const isCustom = columns && !["2", "3", "4", "5"].includes(columns);
        if (isCustom && columnSelect) {
          columnSelect.value = "custom";
          if (columnCustom) {
            columnCustom.style.display = "inline-block";
            columnCustom.value = columns;
          }
        }
        setPanelColumns(panel, columns);
        
        if (columnSelect) {
          columnSelect.addEventListener("change", () => {
            // 對於有頁籤的面板，只應用到當前活動的 tab-body
            const panelHasTabs = panel.querySelector(".panel-tabs");
            const activeTabBody = panelHasTabs ? panel.querySelector(".tab-body.active") : null;
            
            if (columnSelect.value === "custom") {
              // 顯示自訂輸入框
              if (columnCustom) {
                columnCustom.style.display = "inline-block";
                columnCustom.focus();
                // 從當前活動的 tab-body 或 panel 取得當前欄數
                const currentColumns = activeTabBody ? (activeTabBody.dataset.columns || panel.dataset.columns || "3") : (panel.dataset.columns || "3");
                if (!["2", "3", "4", "5"].includes(currentColumns)) {
                  columnCustom.value = currentColumns;
                }
              }
            } else {
              // 隱藏自訂輸入框並更新欄數
              if (columnCustom) {
                columnCustom.style.display = "none";
              }
              setPanelColumns(panel, columnSelect.value, activeTabBody);
            }
          });
        }
        
        if (columnCustom) {
          columnCustom.addEventListener("input", () => {
            const customValue = columnCustom.value;
            if (customValue && parseInt(customValue) > 0 && parseInt(customValue) <= 20) {
              // 對於有頁籤的面板，只應用到當前活動的 tab-body
              const panelHasTabs = panel.querySelector(".panel-tabs");
              const activeTabBody = panelHasTabs ? panel.querySelector(".tab-body.active") : null;
              setPanelColumns(panel, customValue, activeTabBody);
            }
          });
          
          columnCustom.addEventListener("blur", () => {
            const customValue = columnCustom.value;
            // 對於有頁籤的面板，只應用到當前活動的 tab-body
            const panelHasTabs = panel.querySelector(".panel-tabs");
            const activeTabBody = panelHasTabs ? panel.querySelector(".tab-body.active") : null;
            
            if (!customValue || parseInt(customValue) < 1) {
              columnCustom.value = "3";
              setPanelColumns(panel, "3", activeTabBody);
            } else if (parseInt(customValue) > 20) {
              columnCustom.value = "20";
              setPanelColumns(panel, "20", activeTabBody);
            }
          });
        }
        
        // 設置預設列高
        const defaultHeight = isNoTabs ? "1" : "3";
        const panelHeight = config.panelHeight || defaultHeight;
        panel.dataset.panelHeight = panelHeight;
        setPanelHeight(panel, panelHeight);
        
        // 檢查是否為自訂列高
        const isCustomHeight = panelHeight && !["1", "2", "3", "4", "5", "6", "7", "8"].includes(panelHeight);
        if (isCustomHeight && heightSelect) {
          heightSelect.value = "custom";
          if (heightCustom) {
            heightCustom.style.display = "inline-block";
            heightCustom.value = panelHeight;
          }
        } else if (heightSelect) {
          heightSelect.value = panelHeight;
          if (heightCustom) {
            heightCustom.style.display = "none";
          }
        }
        
        // 列高選擇器事件處理
        if (heightSelect) {
          heightSelect.addEventListener("change", () => {
            if (heightSelect.value === "custom") {
              // 顯示自訂輸入框
              if (heightCustom) {
                heightCustom.style.display = "inline-block";
                heightCustom.focus();
                const currentHeight = panel.dataset.panelHeight || "3";
                if (!["1", "2", "3", "4", "5", "6", "7", "8"].includes(currentHeight)) {
                  heightCustom.value = currentHeight;
                }
              }
            } else {
              // 隱藏自訂輸入框並更新列高
              if (heightCustom) {
                heightCustom.style.display = "none";
              }
              setPanelHeight(panel, heightSelect.value);
            }
          });
        }
        
        // 列高自訂輸入框事件處理
        if (heightCustom) {
          heightCustom.addEventListener("input", () => {
            const customValue = heightCustom.value;
            if (customValue && parseInt(customValue) > 0) {
              setPanelHeight(panel, customValue);
            }
          });
          
          heightCustom.addEventListener("blur", () => {
            const customValue = heightCustom.value;
            if (!customValue || parseInt(customValue) < 1) {
              heightCustom.value = "3";
              setPanelHeight(panel, "3");
            }
          });
        }
      } else {
        // 初始化 GRID 面板結構
        initGridPanel(body, config);
      }

      if (isNoTabs) {
        panel.dataset.title = config.title || "區塊";
        // 載入頁籤標題（無頁籤的面板）
        if (config.panelTabTitle) {
          panel.dataset.panelTabTitle = config.panelTabTitle;
          panel.dataset.title = config.panelTabTitle;
        }
      } else {
        panel.dataset.title = tabs[activeTabIndex]?.title || "區塊";
      }

      // 設置資料表識別、關聯的父表和 DB 資料表名
      // 對於有頁籤的面板，為每個 tab-body 設置獨立的屬性；否則設置在 panel 上
      if (!isNoTabs && !isGrid) {
        // 有頁籤的面板：為每個 tab-body 設置屬性
        const tabBodies = panel.querySelectorAll(".tab-body");
        tabBodies.forEach((tabBody, idx) => {
          const tabConfig = config.tabs && config.tabs[idx] ? config.tabs[idx] : {};
          // 設置資料表識別
          if (tabConfig.tableId) {
            tabBody.dataset.panelTableId = tabConfig.tableId;
            if (tabConfig.tableId === "custom" && tabConfig.tableIdCustom) {
              tabBody.dataset.panelTableIdCustom = tabConfig.tableIdCustom;
            }
          } else if (config.tableId) {
            // 如果 tab 沒有設置，使用 panel 的設置
            tabBody.dataset.panelTableId = config.tableId;
            if (config.tableId === "custom" && config.tableIdCustom) {
              tabBody.dataset.panelTableIdCustom = config.tableIdCustom;
            }
          }
          // 關聯的父表
          if (tabConfig.parentTable !== undefined) {
            tabBody.dataset.panelParentTable = tabConfig.parentTable || "";
            if (tabConfig.parentTable === "custom" && tabConfig.parentTableCustom) {
              tabBody.dataset.panelParentTableCustom = tabConfig.parentTableCustom;
            }
          } else if (config.parentTable !== undefined) {
            tabBody.dataset.panelParentTable = config.parentTable || "";
            if (config.parentTable === "custom" && config.parentTableCustom) {
              tabBody.dataset.panelParentTableCustom = config.parentTableCustom;
            }
          } else {
            tabBody.dataset.panelParentTable = "";
          }
          // DB 資料表名
          if (tabConfig.dbTable) {
            tabBody.dataset.panelDbTable = tabConfig.dbTable;
          } else if (config.dbTable) {
            tabBody.dataset.panelDbTable = config.dbTable;
          }
          // 設置頁籤的欄數（優先使用 tabConfig.columns，否則使用 config.columns，最後使用預設值 "3"）
          const tabColumns = tabConfig.columns || config.columns || "3";
          tabBody.dataset.columns = tabColumns;
          tabBody.style.setProperty("--column-count", tabColumns);
        });
      } else {
        // 無頁籤或 Grid 面板：設置在 panel 上
      if (config.tableId) {
        panel.dataset.panelTableId = config.tableId;
        if (config.tableId === "custom" && config.tableIdCustom) {
          panel.dataset.panelTableIdCustom = config.tableIdCustom;
        }
      }
      // 關聯的父表：如果沒有提供，預設為空字串（N/A）
      if (config.parentTable) {
        panel.dataset.panelParentTable = config.parentTable;
        if (config.parentTable === "custom" && config.parentTableCustom) {
          panel.dataset.panelParentTableCustom = config.parentTableCustom;
        }
      } else {
        // 預設為 N/A（空字串）
        panel.dataset.panelParentTable = "";
      }
      if (config.dbTable) {
        panel.dataset.panelDbTable = config.dbTable;
        }
        // 載入頁籤標題（無頁籤的面板和 GRID 面板）
        if (config.panelTabTitle) {
          panel.dataset.panelTabTitle = config.panelTabTitle;
          panel.dataset.title = config.panelTabTitle;
        }
      }

      // 刪除區塊按鈕
      panelDelete.addEventListener("click", (e) => {
        e.stopPropagation();
        if (confirm("確定要刪除此區塊？")) {
          panel.remove();
          selectField(null);
          setActivePanel(null);
          ensurePlaceholder();
        }
      });

      toggle.addEventListener("click", (event) => {
        event.stopPropagation();
        panel.classList.toggle("collapsed");
      });

      // 頁籤相關功能（僅在有頁籤時）
      if (!isNoTabs) {
        // 頁籤拖曳排序
        const tabsContainer = panel.querySelector(".panel-tabs");
        let draggedTab = null;
        let isDragging = false;
        
        if (tabsContainer) {
          panel.querySelectorAll(".panel-tab").forEach((tab) => {
            // 拖曳開始
            tab.addEventListener("dragstart", (e) => {
              draggedTab = tab;
              isDragging = true;
              tab.classList.add("dragging");
              e.dataTransfer.effectAllowed = "move";
            });
            
            // 拖曳結束
            tab.addEventListener("dragend", (e) => {
              tab.classList.remove("dragging");
              tabsContainer.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("drag-over"));
              // 延遲重置，讓點擊事件可以檢查
              setTimeout(() => {
                isDragging = false;
                draggedTab = null;
              }, 100);
            });
            
            // 拖曳懸停
            tab.addEventListener("dragover", (e) => {
              e.preventDefault();
              e.dataTransfer.dropEffect = "move";
              if (draggedTab && draggedTab !== tab) {
                tabsContainer.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("drag-over"));
                tab.classList.add("drag-over");
              }
            });
            
            // 拖曳進入
            tab.addEventListener("dragenter", (e) => {
              e.preventDefault();
              if (draggedTab && draggedTab !== tab) {
                tab.classList.add("drag-over");
              }
            });
            
            // 拖曳離開
            tab.addEventListener("dragleave", (e) => {
              tab.classList.remove("drag-over");
            });
            
            // 放置
            tab.addEventListener("drop", (e) => {
              e.preventDefault();
              e.stopPropagation();
              if (draggedTab && draggedTab !== tab) {
                const tabs = Array.from(tabsContainer.querySelectorAll(".panel-tab"));
                const tabBodies = Array.from(panel.querySelectorAll(".tab-body"));
                const draggedIndex = tabs.indexOf(draggedTab);
                const targetIndex = tabs.indexOf(tab);
                
                // 移動頁籤
                if (draggedIndex < targetIndex) {
                  tabsContainer.insertBefore(draggedTab, tab.nextSibling);
                } else {
                  tabsContainer.insertBefore(draggedTab, tab);
                }
                
                // 移動對應的 tab-body
                const draggedTabBody = tabBodies[draggedIndex];
                const targetTabBody = tabBodies[targetIndex];
                if (draggedTabBody && targetTabBody) {
                  if (draggedIndex < targetIndex) {
                    targetTabBody.parentNode.insertBefore(draggedTabBody, targetTabBody.nextSibling);
                  } else {
                    targetTabBody.parentNode.insertBefore(draggedTabBody, targetTabBody);
                  }
                }
                
                // 更新所有頁籤和 tab-body 的 data-tab-index
                const updatedTabs = Array.from(tabsContainer.querySelectorAll(".panel-tab"));
                const updatedTabBodies = Array.from(panel.querySelectorAll(".tab-body"));
                updatedTabs.forEach((t, newIdx) => {
                  t.dataset.tabIndex = String(newIdx);
                  if (updatedTabBodies[newIdx]) {
                    updatedTabBodies[newIdx].dataset.tabIndex = String(newIdx);
                  }
                });
                
                tabsContainer.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("drag-over"));
              }
            });
          });
        }
        
        // 頁籤切換 - 為所有頁籤綁定點擊事件
        panel.querySelectorAll(".panel-tab").forEach((tab, idx) => {
          tab.addEventListener("click", (e) => {
            // 如果剛剛完成拖曳，不處理點擊
            if (isDragging) {
              return;
            }
            if (e.target.classList.contains("panel-tab-remove") || e.target.classList.contains("panel-tab-input")) {
              return;
            }
            // 如果點擊的是當前 active 頁籤，不處理
            if (tab.classList.contains("active")) {
              return;
            }
            // 切換頁籤 active 狀態
            panel.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("active"));
            tab.classList.add("active");
            
            // 切換對應的 tab-body
            const tabBodies = panel.querySelectorAll(".tab-body");
            const activeTabBody = tabBodies[idx];
            
            tabBodies.forEach((tabBody, bodyIdx) => {
              if (bodyIdx === idx) {
                tabBody.classList.add("active");
              } else {
                tabBody.classList.remove("active");
              }
            });
            
            // 更新面板標題
            const tabInput = tab.querySelector(".panel-tab-input");
            if (tabInput) {
              panel.dataset.title = tabInput.value;
              // 更新頁籤標題輸入框（如果顯示）
              if (propPanelTabTitle && propPanelTabTitleLabel && propPanelTabTitleLabel.style.display !== "none") {
                propPanelTabTitle.value = tabInput.value || "";
              }
            }
            
            // 切換頁籤時，清除選中的欄位，確保顯示區塊屬性
            selectField(null);
            selectGridHeaderCell(null);
            // 更新面板上的欄數選擇器，顯示當前活動頁籤的欄數
            updatePanelColumnSelect(panel, activeTabBody);
            // 重新載入該頁籤的區塊屬性
            setActivePanel(activeTabBody);
          });
        });

        // 頁籤標題編輯
        tabInputs.forEach((input, idx) => {
          input.addEventListener("focus", () => {
            // 當 focus 在頁籤標題輸入框時，切換到該頁籤並顯示區塊屬性
            const tab = input.closest(".panel-tab");
            if (tab && !tab.classList.contains("active")) {
              // 切換頁籤 active 狀態
              panel.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("active"));
              tab.classList.add("active");
              
              // 切換對應的 tab-body
              const tabBodies = panel.querySelectorAll(".tab-body");
              const activeTabBody = tabBodies[idx];
              
              tabBodies.forEach((tabBody, bodyIdx) => {
                if (bodyIdx === idx) {
                  tabBody.classList.add("active");
                } else {
                  tabBody.classList.remove("active");
                }
              });
              
              // 清除選中的欄位，確保顯示區塊屬性
              selectField(null);
              selectGridHeaderCell(null);
              // 更新面板上的欄數選擇器，顯示當前活動頁籤的欄數
              updatePanelColumnSelect(panel, activeTabBody);
              // 顯示該頁籤的區塊屬性
              setActivePanel(activeTabBody);
            } else if (tab && tab.classList.contains("active")) {
              // 如果已經是 active 頁籤，確保顯示區塊屬性
              const tabBodies = panel.querySelectorAll(".tab-body");
              const activeTabBody = tabBodies[idx];
              if (activeTabBody) {
                selectField(null);
                selectGridHeaderCell(null);
                // 更新面板上的欄數選擇器，顯示當前活動頁籤的欄數
                updatePanelColumnSelect(panel, activeTabBody);
                setActivePanel(activeTabBody);
              }
            }
          });
          
          input.addEventListener("input", () => {
            if (idx === activeTabIndex) {
              panel.dataset.title = input.value;
            }
          });
          input.addEventListener("blur", () => {
            if (!input.value.trim()) {
              input.value = "頁籤";
            }
          });
        });

        // 刪除頁籤
        tabRemoves.forEach((remove, idx) => {
          remove.addEventListener("click", (e) => {
            e.stopPropagation();
            if (panel.querySelectorAll(".panel-tab").length <= 1) {
              showToast("至少需要一個頁籤");
              return;
            }
            const tab = remove.closest(".panel-tab");
            const tabIndex = Array.from(panel.querySelectorAll(".panel-tab")).indexOf(tab);
            const wasActive = tab.classList.contains("active");
            
            // 刪除對應的 tab-body
            const tabBodies = panel.querySelectorAll(".tab-body");
            if (tabBodies[tabIndex]) {
              tabBodies[tabIndex].remove();
            }
            
            // 刪除頁籤
            tab.remove();
            
            // 如果刪除的是 active 頁籤，激活第一個頁籤
            if (wasActive) {
              const firstTab = panel.querySelector(".panel-tab");
              if (firstTab) {
                firstTab.classList.add("active");
                panel.dataset.title = firstTab.querySelector(".panel-tab-input").value;
                // 激活第一個 tab-body
                const firstTabBody = panel.querySelector(".tab-body");
                if (firstTabBody) {
                  panel.querySelectorAll(".tab-body").forEach(tb => tb.classList.remove("active"));
                  firstTabBody.classList.add("active");
                  setActivePanel(firstTabBody);
                }
              }
            }
          });
        });

        // 新增頁籤
        if (tabAdd) {
          tabAdd.addEventListener("click", () => {
            // 創建新頁籤
            const newTab = document.createElement("div");
            newTab.className = "panel-tab active";
            newTab.draggable = true;
            newTab.innerHTML = `
              <input type="text" class="panel-tab-input" value="新頁籤" />
              <span class="panel-tab-remove">×</span>
            `;
            panel.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("active"));
            tabAdd.parentElement.insertBefore(newTab, tabAdd);
            
            // 為新頁籤綁定拖曳事件（重用現有的拖曳邏輯）
            const tabsContainer = panel.querySelector(".panel-tabs");
            let isDragging = false; // 在外部作用域定義
            if (tabsContainer) {
              // 重新為所有頁籤綁定拖曳事件，包括新頁籤
              let draggedTab = null;
              tabsContainer.querySelectorAll(".panel-tab").forEach((tab) => {
                const tabWithEvents = tab;
                
                // 拖曳開始
                tabWithEvents.addEventListener("dragstart", (e) => {
                  draggedTab = tabWithEvents;
                  isDragging = true;
                  tabWithEvents.classList.add("dragging");
                  e.dataTransfer.effectAllowed = "move";
                });
                
                // 拖曳結束
                tabWithEvents.addEventListener("dragend", (e) => {
                  tabWithEvents.classList.remove("dragging");
                  tabsContainer.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("drag-over"));
                  // 延遲重置，讓點擊事件可以檢查
                  setTimeout(() => {
                    isDragging = false;
                    draggedTab = null;
                  }, 100);
                });
                
                // 拖曳懸停
                tabWithEvents.addEventListener("dragover", (e) => {
                  e.preventDefault();
                  e.dataTransfer.dropEffect = "move";
                  if (draggedTab && draggedTab !== tabWithEvents) {
                    tabsContainer.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("drag-over"));
                    tabWithEvents.classList.add("drag-over");
                  }
                });
                
                // 拖曳進入
                tabWithEvents.addEventListener("dragenter", (e) => {
                  e.preventDefault();
                  if (draggedTab && draggedTab !== tabWithEvents) {
                    tabWithEvents.classList.add("drag-over");
                  }
                });
                
                // 拖曳離開
                tabWithEvents.addEventListener("dragleave", (e) => {
                  tabWithEvents.classList.remove("drag-over");
                });
                
                // 放置
                tabWithEvents.addEventListener("drop", (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  if (draggedTab && draggedTab !== tabWithEvents) {
                    const tabs = Array.from(tabsContainer.querySelectorAll(".panel-tab"));
                    const tabBodies = Array.from(panel.querySelectorAll(".tab-body"));
                    const draggedIndex = tabs.indexOf(draggedTab);
                    const targetIndex = tabs.indexOf(tabWithEvents);
                    
                    // 移動頁籤
                    if (draggedIndex < targetIndex) {
                      tabsContainer.insertBefore(draggedTab, tabWithEvents.nextSibling);
                    } else {
                      tabsContainer.insertBefore(draggedTab, tabWithEvents);
                    }
                    
                    // 移動對應的 tab-body
                    const draggedTabBody = tabBodies[draggedIndex];
                    const targetTabBody = tabBodies[targetIndex];
                    if (draggedTabBody && targetTabBody) {
                      if (draggedIndex < targetIndex) {
                        targetTabBody.parentNode.insertBefore(draggedTabBody, targetTabBody.nextSibling);
                      } else {
                        targetTabBody.parentNode.insertBefore(draggedTabBody, targetTabBody);
                      }
                    }
                    
                    // 更新所有頁籤和 tab-body 的 data-tab-index
                    const updatedTabs = Array.from(tabsContainer.querySelectorAll(".panel-tab"));
                    const updatedTabBodies = Array.from(panel.querySelectorAll(".tab-body"));
                    updatedTabs.forEach((t, newIdx) => {
                      t.dataset.tabIndex = String(newIdx);
                      if (updatedTabBodies[newIdx]) {
                        updatedTabBodies[newIdx].dataset.tabIndex = String(newIdx);
                      }
                    });
                    
                    tabsContainer.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("drag-over"));
                  }
                });
              });
            }
            
            // 創建對應的新 tab-body
            const newTabBody = document.createElement("div");
            newTabBody.className = "tab-body active";
            const columns = panel.dataset.columns || "3";
            newTabBody.style.setProperty("--column-count", columns);
            newTabBody.dataset.columns = columns;
            
            // 獲取當前面板的列高（所有頁籤都使用相同的列高）
            const currentHeight = parseInt(panel.dataset.panelHeight) || 3;
            // 使用與 setPanelHeight 相同的計算公式：36 * heightValue + 12
            const minHeight = (currentHeight * 36) + 12;
            newTabBody.style.minHeight = `${minHeight}px`;
            newTabBody.dataset.panelHeight = String(currentHeight);
            
            // 初始化新頁籤的區塊屬性（使用預設值）
            newTabBody.dataset.panelTableId = "A";
            newTabBody.dataset.panelParentTable = "";
            newTabBody.dataset.panelDbTable = "";
            
            panel.querySelectorAll(".tab-body").forEach(tb => tb.classList.remove("active"));
            panel.appendChild(newTabBody);
            
            // 為新的 tab-body 綁定拖曳事件
            newTabBody.addEventListener("dragover", (event) => {
              event.preventDefault();
              const moving = event.dataTransfer.getData("move-field");
              if (moving && window._draggedField) {
                event.dataTransfer.dropEffect = "move";
              } else {
                event.dataTransfer.dropEffect = "copy";
              }
            });

            newTabBody.addEventListener("drop", (event) => {
              event.preventDefault();
              event.stopPropagation();
              const moving = event.dataTransfer.getData("move-field");
              if (moving && window._draggedField) {
                const draggedField = window._draggedField;
                // 非 GRID 面板：插入到最後位置
                newTabBody.appendChild(draggedField);
                // 清除拖曳狀態
                draggedField.classList.remove("dragging");
                window._draggedField = null;
                isDraggingField = false;
                selectField(draggedField);
                setActivePanel(newTabBody);
                return;
              }
              const type = event.dataTransfer.getData("field-type");
              if (!type || type === "panel" || type === "panel-no-tabs" || type === "grid-panel") {
                return;
              }
              // 非 GRID 面板：添加欄位
              addField(type, {}, newTabBody);
            });
            
            const newInput = newTab.querySelector(".panel-tab-input");
            newInput.focus();
            newInput.select();
            panel.dataset.title = newInput.value;
            
            // 設置 activePanelBody 為新的 tab-body
            setActivePanel(newTabBody);
            
            // 為新頁籤綁定點擊事件（拖曳事件已在上面綁定）
            newTab.addEventListener("click", (e) => {
              // 如果剛剛完成拖曳，不處理點擊
              if (isDragging) {
                return;
              }
              if (e.target.classList.contains("panel-tab-remove") || e.target.classList.contains("panel-tab-input")) {
                return;
              }
              if (newTab.classList.contains("active")) {
                return;
              }
              panel.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("active"));
              newTab.classList.add("active");
              
              // 切換對應的 tab-body
              panel.querySelectorAll(".tab-body").forEach(tb => tb.classList.remove("active"));
              newTabBody.classList.add("active");
              
              // 切換頁籤時，清除選中的欄位，確保顯示區塊屬性
              selectField(null);
              selectGridHeaderCell(null);
              setActivePanel(newTabBody);
            });
            
            newInput.addEventListener("focus", () => {
              // 當 focus 在頁籤標題輸入框時，切換到該頁籤並顯示區塊屬性
              if (!newTab.classList.contains("active")) {
                // 切換頁籤 active 狀態
                panel.querySelectorAll(".panel-tab").forEach(t => t.classList.remove("active"));
                newTab.classList.add("active");
                
                // 切換對應的 tab-body
                panel.querySelectorAll(".tab-body").forEach(tb => tb.classList.remove("active"));
                newTabBody.classList.add("active");
                
                // 清除選中的欄位，確保顯示區塊屬性
                selectField(null);
                selectGridHeaderCell(null);
                // 顯示該頁籤的區塊屬性
                setActivePanel(newTabBody);
              } else {
                // 如果已經是 active 頁籤，確保顯示區塊屬性
                selectField(null);
                selectGridHeaderCell(null);
                setActivePanel(newTabBody);
              }
            });
            
            newInput.addEventListener("input", () => {
              if (newTab.classList.contains("active")) {
              panel.dataset.title = newInput.value;
              }
            });
            
            // 為新頁籤的刪除按鈕綁定事件
            const newTabRemove = newTab.querySelector(".panel-tab-remove");
            newTabRemove.addEventListener("click", (e) => {
              e.stopPropagation();
              if (panel.querySelectorAll(".panel-tab").length <= 1) {
                showToast("至少需要一個頁籤");
                return;
              }
              // 刪除對應的 tab-body
              newTabBody.remove();
              // 刪除頁籤
              newTab.remove();
              
              // 激活第一個頁籤
              const firstTab = panel.querySelector(".panel-tab");
              if (firstTab) {
                firstTab.classList.add("active");
                panel.dataset.title = firstTab.querySelector(".panel-tab-input").value;
                const firstTabBody = panel.querySelector(".tab-body");
                if (firstTabBody) {
                  panel.querySelectorAll(".tab-body").forEach(tb => tb.classList.remove("active"));
                  firstTabBody.classList.add("active");
                  setActivePanel(firstTabBody);
                }
              }
            });
          });
        }
      }

      // 為所有 body（panel-body 或 tab-body）綁定拖曳事件
      const allBodies = panel.querySelectorAll(".panel-body, .tab-body");
      allBodies.forEach((bodyElement) => {
        bodyElement.addEventListener("dragover", (event) => {
        event.preventDefault();
        const moving = event.dataTransfer.getData("move-field");
        if (moving && window._draggedField) {
          event.dataTransfer.dropEffect = "move";
        } else {
        event.dataTransfer.dropEffect = "copy";
        }
      });

        bodyElement.addEventListener("drop", (event) => {
        event.preventDefault();
        event.stopPropagation();
        const moving = event.dataTransfer.getData("move-field");
        if (moving && window._draggedField) {
          const draggedField = window._draggedField;
          // 如果是 GRID 面板，嘗試替換空白佔位元素
          if (isGrid) {
              const emptyFields = bodyElement.querySelectorAll(".field:not([data-type])");
            if (emptyFields.length > 0) {
              emptyFields[0].replaceWith(draggedField);
            } else {
                bodyElement.appendChild(draggedField);
            }
          } else {
            // 非 GRID 面板：插入到最後位置
              bodyElement.appendChild(draggedField);
          }
          // 清除拖曳狀態
          draggedField.classList.remove("dragging");
          window._draggedField = null;
          isDraggingField = false;
          selectField(draggedField);
            setActivePanel(bodyElement);
          return;
        }
        const type = event.dataTransfer.getData("field-type");
        if (!type || type === "panel" || type === "panel-no-tabs" || type === "grid-panel") {
          return;
        }
        // GRID 面板不接受拖曳欄位
        if (!isGrid) {
            addField(type, {}, bodyElement);
        }
        });
      });

      canvas.appendChild(panel);
      
      // 設置初始的 activePanelBody
      if (!isNoTabs && !isGrid) {
        const activeTabBody = panel.querySelector(".tab-body.active");
        if (activeTabBody) {
          setActivePanel(activeTabBody);
        }
      } else {
      setActivePanel(body);
      }
      
      // 載入欄位：對於有頁籤的面板，根據 tabIndex 將欄位放到對應的 tab-body
      if (!isGrid && Array.isArray(config.fields)) {
        // 判斷是否有頁籤：非 Grid 面板且非無頁籤面板
        const hasTabs = !isNoTabs && !isGrid;
        
        if (hasTabs) {
          // 有頁籤：根據 tabIndex 分組欄位
          const fieldsByTab = {};
          config.fields.forEach((fieldConfig) => {
            const tabIndex = fieldConfig.tabIndex !== undefined ? fieldConfig.tabIndex : 0;
            if (!fieldsByTab[tabIndex]) {
              fieldsByTab[tabIndex] = [];
            }
            fieldsByTab[tabIndex].push(fieldConfig);
          });
          
          // 為每個頁籤添加欄位
          const tabBodies = panel.querySelectorAll(".tab-body");
          console.log("載入頁籤欄位：", {
            tabBodiesCount: tabBodies.length,
            fieldsByTab: Object.keys(fieldsByTab).map(k => ({ tabIndex: k, count: fieldsByTab[k].length }))
          });
          
          tabBodies.forEach((tabBody, tabIdx) => {
            const tabFields = fieldsByTab[tabIdx] || [];
            console.log(`頁籤 ${tabIdx} 的欄位數量：${tabFields.length}`, tabFields.map(f => ({ type: f.type, hasGridColumns: !!f.gridColumns })));
            
            tabFields.forEach((fieldConfig) => {
              // 確保 grid-tab 的配置正確傳遞
              if (fieldConfig && fieldConfig.type === "grid-tab") {
                console.log("處理 grid-tab 欄位：", {
                  tabIndex: fieldConfig.tabIndex,
                  currentTabIdx: tabIdx,
                  hasGridColumns: !!fieldConfig.gridColumns,
                  gridColumnsLength: fieldConfig.gridColumns ? fieldConfig.gridColumns.length : 0,
                  hasGridRows: !!fieldConfig.gridRows,
                  gridRowsLength: fieldConfig.gridRows ? fieldConfig.gridRows.length : 0
                });
                
                // 確保 gridColumns 和 gridRows 存在且為陣列
                const configToPass = {
                  ...fieldConfig,
                  gridColumns: Array.isArray(fieldConfig.gridColumns) ? fieldConfig.gridColumns : [],
                  gridRows: Array.isArray(fieldConfig.gridRows) ? fieldConfig.gridRows : []
                };
                
                // 調試：檢查配置
                if (configToPass.gridColumns.length === 0 && configToPass.gridRows.length === 0) {
                  console.warn("警告：grid-tab 的 gridColumns 和 gridRows 為空", fieldConfig);
                } else {
                  console.log("準備添加 grid-tab，配置：", {
                    columns: configToPass.gridColumns.length,
                    rows: configToPass.gridRows.length,
                    firstColumn: configToPass.gridColumns[0],
                    tabBody: tabBody ? tabBody.className : "null",
                    tabBodyActive: tabBody ? tabBody.classList.contains("active") : false
                  });
                }
                
                console.log("調用 addField 前，tabBody 狀態：", {
                  tabBodyExists: !!tabBody,
                  tabBodyClassName: tabBody ? tabBody.className : "null",
                  tabBodyChildrenCount: tabBody ? tabBody.children.length : 0
                });
                
                addField(fieldConfig.type, configToPass, tabBody);
                
                console.log("調用 addField 後，tabBody 狀態：", {
                  tabBodyChildrenCount: tabBody ? tabBody.children.length : 0,
                  hasGridTab: tabBody ? !!tabBody.querySelector(".field-grid-tab") : false,
                  gridTabElement: tabBody ? tabBody.querySelector(".field-grid-tab") : null
                });
              } else if (fieldConfig) {
                addField(fieldConfig.type, fieldConfig, tabBody);
              }
            });
          });
        } else {
          // 無頁籤：直接添加到 panel-body
        config.fields.forEach((fieldConfig) => {
          addField(fieldConfig.type, fieldConfig, body);
        });
        }
        selectField(null);
      }
    }

    function initGridPanel(gridBody, config = {}) {
      console.log("initGridPanel 被調用，config:", {
        hasGridColumns: !!config.gridColumns,
        gridColumnsLength: config.gridColumns ? config.gridColumns.length : 0,
        hasGridRows: !!config.gridRows,
        gridRowsLength: config.gridRows ? config.gridRows.length : 0
      });
      
      // 清除舊內容
      gridBody.innerHTML = "";
      
      // 創建表頭行
      const headerRow = document.createElement("div");
      headerRow.className = "grid-header-row";
      gridBody.appendChild(headerRow);
      
      // 創建資料行容器
      const dataRows = document.createElement("div");
      dataRows.className = "grid-data-rows";
      gridBody.appendChild(dataRows);
      
      // 創建新增行按鈕
      const addRowBtn = document.createElement("div");
      addRowBtn.className = "grid-add-row-btn";
      addRowBtn.textContent = "+ 新增資料列";
      addRowBtn.addEventListener("click", () => {
        addGridDataRow(gridBody);
      });
      gridBody.appendChild(addRowBtn);
      
      // 初始化欄位
      const columns = config.gridColumns || [];
      console.log("初始化欄位，columns.length:", columns.length);
      if (columns.length > 0) {
        columns.forEach((col, idx) => {
          console.log(`添加欄位 ${idx + 1}:`, col.title, col.width);
          addGridColumn(gridBody, col.title || "新欄位", col.width || 100, {
            dbField: col.dbField || "",
            width: col.widthProp || "small",
            rowHeight: col.rowHeight || "1",
            length: col.length || "N/A",
            fieldType: col.fieldType || "real",
            selectOptions: col.selectOptions || "",
            tcode: col.tcode || "N/A",
            relationField: (col.relationField && col.relationField !== "N/A") ? col.relationField : "",
            otherNote: col.otherNote || "N/A",
            required: col.required || false,
            readonly: col.readonly || false,
            primaryKey: col.primaryKey || false,
            defaultValue: col.defaultValue || ""
          });
        });
      } else {
        console.warn("沒有欄位配置，使用預設4個欄位");
        // 預設4個欄位
        for (let i = 0; i < 4; i++) {
          addGridColumn(gridBody, `欄位${i + 1}`, 100, {});
        }
      }
      
      // 初始化資料行
      const rows = config.gridRows || [];
      console.log("初始化資料行，rows.length:", rows.length);
      if (rows.length > 0) {
        rows.forEach((row, idx) => {
          console.log(`添加資料行 ${idx + 1}:`, row);
          addGridDataRow(gridBody, row);
        });
      } else {
        console.warn("沒有資料行配置，使用預設4行");
        // 預設4行
        for (let i = 0; i < 4; i++) {
          addGridDataRow(gridBody);
        }
      }
      
      // 設置欄寬調整功能
      setupGridColumnResizers(gridBody);
      
      // 確保所有已存在的資料行都有刪除按鈕
      ensureGridDataRowsHaveDeleteBtn(gridBody);
      
      console.log("initGridPanel 完成");
    }

    function ensureGridDataRowsHaveDeleteBtn(gridBody) {
      const dataRows = gridBody.querySelectorAll(".grid-data-row");
      dataRows.forEach((dataRow) => {
        // 檢查是否已經有刪除按鈕
        if (!dataRow.querySelector(".grid-data-row-delete")) {
          // 添加刪除按鈕
          const deleteBtn = document.createElement("div");
          deleteBtn.className = "grid-data-row-delete";
          deleteBtn.title = "刪除列";
          deleteBtn.textContent = "×";
          deleteBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (confirm("確定要刪除此列？")) {
              // 確保刪除整行，包括所有 Cell 和刪除按鈕本身
              const parent = dataRow.parentNode;
              if (parent) {
                dataRow.remove();
              }
            }
          });
          dataRow.appendChild(deleteBtn);
          
          // 更新點擊選中行的邏輯（排除點擊刪除按鈕時）
          const existingClickHandler = dataRow.onclick;
          dataRow.addEventListener("click", (e) => {
            if (e.target.classList.contains("grid-data-row-delete")) {
              return;
            }
            const dataRowsContainer = gridBody.querySelector(".grid-data-rows");
            if (dataRowsContainer) {
              dataRowsContainer.querySelectorAll(".grid-data-row").forEach(r => r.classList.remove("selected"));
              dataRow.classList.add("selected");
            }
          });
        }
      });
    }

    function updateGridHeaderRequired(headerCell) {
      const titleEl = headerCell.querySelector(".header-title");
      const isRequired = headerCell.dataset.required === "true";
      
      if (isRequired) {
        titleEl.classList.add("required");
      } else {
        titleEl.classList.remove("required");
      }
    }

    function updateGridHeaderReadonly(headerCell) {
      const titleEl = headerCell.querySelector(".header-title");
      if (!titleEl) return;
      
      const isReadonly = headerCell.dataset.readonly === "true";
      let currentText = titleEl.textContent.trim();
      
      // 提取實際標題（去掉括號）
      let actualTitle = currentText;
      if (currentText.startsWith("(") && currentText.endsWith(")")) {
        actualTitle = currentText.slice(1, -1).trim();
      }
      
      // 如果唯讀，加上括號；否則移除括號
      if (isReadonly) {
        if (!currentText.startsWith("(") || !currentText.endsWith(")")) {
          titleEl.textContent = `(${actualTitle})`;
        }
      } else {
        if (currentText.startsWith("(") && currentText.endsWith(")")) {
          titleEl.textContent = actualTitle;
        }
      }
    }

    function deleteGridColumn(gridBody, headerCell) {
      const headerRow = gridBody.querySelector(".grid-header-row");
      const dataRows = gridBody.querySelectorAll(".grid-data-row");
      const headerCells = headerRow.querySelectorAll(".grid-header-cell");
      const index = Array.from(headerCells).indexOf(headerCell);
      
      if (index === -1) return;
      
      // 移除表頭單元格
      headerCell.remove();
      
      // 移除所有資料行中對應的單元格
      // 使用更精確的選擇器，只選擇 .grid-data-cell 元素，避免受到刪除按鈕的影響
      dataRows.forEach((row) => {
        const cells = row.querySelectorAll(".grid-data-cell");
        if (cells[index]) {
          cells[index].remove();
        }
      });
      
      // 重新設置調整器
      setupGridColumnResizers(gridBody);
    }

    function addGridColumn(gridBody, title = "新欄位", width = 100, config = {}) {
      const headerRow = gridBody.querySelector(".grid-header-row");
      const dataRows = gridBody.querySelector(".grid-data-rows");
      
      // 創建表頭單元格
      const headerCell = document.createElement("div");
      headerCell.className = "grid-header-cell";
      headerCell.style.width = `${width}px`;
      // 初始化欄位屬性
      headerCell.dataset.dbField = config.dbField || "";
      headerCell.dataset.width = config.width || "small";
      headerCell.dataset.rowHeight = config.rowHeight || "1";
      headerCell.dataset.fieldLength = config.length || "N/A";
      headerCell.dataset.fieldType = config.fieldType || "real";
      headerCell.dataset.selectOptions = config.selectOptions || "";
      headerCell.dataset.fieldTcode = config.tcode || "N/A";
      headerCell.dataset.relationField = (config.relationField && config.relationField !== "N/A") ? config.relationField : "";
      headerCell.dataset.otherNote = config.otherNote || "N/A";
      headerCell.dataset.required = (config.required === true || config.required === "true") ? "true" : "false";
      headerCell.dataset.readonly = (config.readonly === true || config.readonly === "true") ? "true" : "false";
      headerCell.dataset.primaryKey = (config.primaryKey === true || config.primaryKey === "true") ? "true" : "false";
      headerCell.dataset.defaultValue = config.defaultValue || "";
      headerCell.innerHTML = `
        <div class="header-title" contenteditable="true">${title}</div>
        <div class="header-delete" title="刪除欄位">×</div>
        <div class="grid-col-resizer"></div>
      `;
      
      // 在新增欄位按鈕之前插入
      const addHeaderBtn = headerRow.querySelector(".grid-add-header-btn");
      if (addHeaderBtn) {
        headerRow.insertBefore(headerCell, addHeaderBtn);
      } else {
        headerRow.appendChild(headerCell);
      }
      
      // 檢查並設置必填狀態
      updateGridHeaderRequired(headerCell);
      // 檢查並設置唯讀狀態
      updateGridHeaderReadonly(headerCell);
      
      // 標題編輯
      const titleEl = headerCell.querySelector(".header-title");
      // 當標題獲得焦點（進入編輯模式）時，顯示設定面板
      titleEl.addEventListener("focus", () => {
        selectGridHeaderCell(headerCell);
        const panel = gridBody.closest(".panel");
        if (panel) {
          setActivePanel(gridBody);
        }
      });
      titleEl.addEventListener("input", () => {
        updateGridHeaderRequired(headerCell);
      });
      titleEl.addEventListener("blur", () => {
        if (!titleEl.textContent.trim()) {
          titleEl.textContent = title;
        }
        updateGridHeaderRequired(headerCell);
        updateGridHeaderReadonly(headerCell);
      });
      titleEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          titleEl.blur();
        }
      });
      
      // 刪除按鈕
      const deleteBtn = headerCell.querySelector(".header-delete");
      deleteBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const headerCells = headerRow.querySelectorAll(".grid-header-cell");
        if (headerCells.length <= 1) {
          showToast("至少需要一個欄位");
          return;
        }
        if (confirm("確定要刪除此欄位？")) {
          if (selectedGridHeaderCell === headerCell) {
            selectGridHeaderCell(null);
          }
          deleteGridColumn(gridBody, headerCell);
        }
      });
      
      // 為所有資料行添加對應的單元格
      const dataRowList = dataRows.querySelectorAll(".grid-data-row");
      dataRowList.forEach((row) => {
        const cell = document.createElement("div");
        cell.className = "grid-data-cell";
        cell.style.width = `${width}px`;
        cell.innerHTML = `<input type="text" />`;
        row.appendChild(cell);
      });
      
      // 添加新增欄位按鈕（如果還沒有）
      if (!addHeaderBtn) {
        const addBtn = document.createElement("div");
        addBtn.className = "grid-add-header-btn";
        addBtn.textContent = "+ 新增欄位";
        addBtn.addEventListener("click", () => {
          addGridColumn(gridBody, "新欄位", 100, {});
        });
        headerRow.appendChild(addBtn);
      }
      
      // 重新設置調整器
      setupGridColumnResizers(gridBody);
    }

    function addGridDataRow(gridBody, rowData = null) {
      const headerRow = gridBody.querySelector(".grid-header-row");
      const dataRows = gridBody.querySelector(".grid-data-rows");
      const headerCells = headerRow.querySelectorAll(".grid-header-cell");
      
      const dataRow = document.createElement("div");
      dataRow.className = "grid-data-row";
      
      // 點擊選中行（排除點擊刪除按鈕時）
      dataRow.addEventListener("click", (e) => {
        if (e.target.classList.contains("grid-data-row-delete")) {
          return;
        }
        dataRows.querySelectorAll(".grid-data-row").forEach(r => r.classList.remove("selected"));
        dataRow.classList.add("selected");
      });
      
      // 為每個欄位創建單元格
      headerCells.forEach((headerCell, idx) => {
        const cell = document.createElement("div");
        cell.className = "grid-data-cell";
        const width = headerCell.style.width || "100px";
        cell.style.width = width;
        const input = document.createElement("input");
        input.type = "text";
        if (rowData && rowData[idx] !== undefined) {
          input.value = rowData[idx];
        }
        cell.appendChild(input);
        dataRow.appendChild(cell);
      });
      
      // 添加刪除按鈕（必須在所有 Cell 之後添加）
      const deleteBtn = document.createElement("div");
      deleteBtn.className = "grid-data-row-delete";
      deleteBtn.title = "刪除列";
      deleteBtn.textContent = "×";
      deleteBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        if (confirm("確定要刪除此列？")) {
          // 確保刪除整行，包括所有 Cell 和刪除按鈕本身
          const parent = dataRow.parentNode;
          if (parent) {
            dataRow.remove();
          }
        }
      });
      dataRow.appendChild(deleteBtn);
      
      dataRows.appendChild(dataRow);
    }

    function setupGridColumnResizers(gridBody) {
      const headerRow = gridBody.querySelector(".grid-header-row");
      const headerCells = Array.from(headerRow.querySelectorAll(".grid-header-cell"));
      
      headerCells.forEach((headerCell, index) => {
        // 所有欄位都可以調整寬度，包括最後一欄
        const resizer = headerCell.querySelector(".grid-col-resizer");
        if (!resizer) return;
        resizer.style.display = ""; // 確保調整器顯示
        
        let isResizing = false;
        let startX = 0;
        let startWidth = 0;
        
        resizer.addEventListener("mousedown", (e) => {
          isResizing = true;
          startX = e.clientX;
          startWidth = headerCell.offsetWidth;
          resizer.classList.add("active");
          document.body.style.cursor = "col-resize";
          document.body.style.userSelect = "none";
          
          const handleMouseMove = (e) => {
            if (!isResizing) return;
            const diff = e.clientX - startX;
            const newWidth = Math.max(50, startWidth + diff);
            headerCell.style.width = `${newWidth}px`;
            // 同步更新所有資料行的對應單元格
            // 重新查詢所有資料行，確保包含新增的行
            // 使用更精確的選擇器，只選擇 .grid-data-cell 元素，避免受到刪除按鈕的影響
            const allDataRows = gridBody.querySelectorAll(".grid-data-row");
            allDataRows.forEach((row) => {
              const cells = row.querySelectorAll(".grid-data-cell");
              if (cells[index]) {
                cells[index].style.width = `${newWidth}px`;
              }
            });
          };
          
          const handleMouseUp = () => {
            isResizing = false;
            resizer.classList.remove("active");
            document.body.style.cursor = "";
            document.body.style.userSelect = "";
            document.removeEventListener("mousemove", handleMouseMove);
            document.removeEventListener("mouseup", handleMouseUp);
          };
          
          document.addEventListener("mousemove", handleMouseMove);
          document.addEventListener("mouseup", handleMouseUp);
          e.preventDefault();
          e.stopPropagation();
        });
      });
    }

    function addField(type, config = {}, targetBody = activePanelBody, replaceElement = null) {
      // 空欄位和 grid-tab 不需要檢查 fieldTemplates
      if (type !== "empty" && type !== "grid-tab" && !fieldTemplates[type]) {
        return;
      }
      if (!targetBody) {
        showToast("請先選擇要放置欄位的區塊");
        return;
      }
      const wrapper = document.createElement("div");
      wrapper.className = "field";
      wrapper.dataset.type = type;
      const width = config.width || "small";
      wrapper.dataset.width = width;
      const rowHeight = config.rowHeight || "1";
      wrapper.dataset.rowHeight = rowHeight;
      // 設置 grid-row 使欄位可以跨越多行（固定行高 36px = 32px + 4px間隔）
      const rowSpan = parseInt(rowHeight);
      wrapper.style.gridRow = `span ${rowSpan}`;
      const isRequired = config.required === true || config.required === "true";
      wrapper.dataset.required = isRequired ? "true" : "false";
      const isReadonly = config.readonly === true || config.readonly === "true";
      wrapper.dataset.readonly = isReadonly ? "true" : "false";
      const isPrimaryKey = config.primaryKey === true || config.primaryKey === "true";
      wrapper.dataset.primaryKey = isPrimaryKey ? "true" : "false";
      const dbField = config.dbField || "";
      wrapper.dataset.dbField = dbField;
      const fieldLength = config.length || "N/A";
      wrapper.dataset.fieldLength = fieldLength;
      const fieldType = config.fieldType || "real";
      wrapper.dataset.fieldType = fieldType;
      const selectOptions = config.selectOptions || "";
      wrapper.dataset.selectOptions = selectOptions;
      const fieldTcode = config.tcode || "N/A";
      wrapper.dataset.fieldTcode = fieldTcode;
      const relationField = (config.relationField && config.relationField !== "N/A") ? config.relationField : "";
      wrapper.dataset.relationField = relationField;
      const otherNote = config.otherNote || "N/A";
      wrapper.dataset.otherNote = otherNote;
      const textColor = config.textColor || "#233018";
      wrapper.dataset.textColor = textColor;
      wrapper.draggable = true;
      
      // 空欄位：沒有 label 和 control
      if (type === "empty") {
        wrapper.innerHTML = `
          <div class="field-delete" title="刪除欄位">×</div>
        `;
        wrapper.classList.add("field-empty");
      } else if (type === "button") {
        // 按鈕類型：沒有 label，只有 control
        const buttonWidth = config.buttonWidth || "";
        const buttonText = config.value || "按鈕";
        wrapper.innerHTML = `
          <div class="field-delete" title="刪除欄位">×</div>
          <div class="field-control">
            <button type="button" class="field-button" contenteditable="true">${buttonText}</button>
            <div class="button-width-resizer" title="拖曳調整寬度"></div>
          </div>
        `;
        wrapper.classList.add("field-button");
        if (buttonWidth) {
          wrapper.dataset.buttonWidth = buttonWidth;
          const button = wrapper.querySelector(".field-control .field-button");
          if (button) {
            button.style.width = buttonWidth + "px";
          }
        }
        
        // 設置按鈕文字可編輯功能和寬度調整器
        const button = wrapper.querySelector(".field-control .field-button");
        const resizer = wrapper.querySelector(".button-width-resizer");
        
        if (button) {
          // 阻止點擊按鈕時觸發欄位選擇
          button.addEventListener("click", (e) => {
            e.stopPropagation();
          });
          
          // 處理貼上事件：只保留純文字，移除所有格式
          button.addEventListener("paste", (e) => {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData("text/plain");
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
              const range = selection.getRangeAt(0);
              range.deleteContents();
              const textNode = document.createTextNode(text);
              range.insertNode(textNode);
              range.setStartAfter(textNode);
              range.setEndAfter(textNode);
              selection.removeAllRanges();
              selection.addRange(range);
            } else {
              button.textContent = text;
            }
            // 觸發 input 事件以同步更新值
            button.dispatchEvent(new Event("input", { bubbles: true }));
          });
          
          // 當按鈕文字改變時，同步更新值
          button.addEventListener("input", () => {
            wrapper.dataset.value = button.textContent.trim() || "按鈕";
          });
          
          // 當按鈕失去焦點時，確保有內容
          button.addEventListener("blur", () => {
            if (!button.textContent.trim()) {
              button.textContent = "按鈕";
            }
            wrapper.dataset.value = button.textContent.trim();
          });
        }
        
        // 設置按鈕寬度調整器
        if (resizer && button) {
          let isResizing = false;
          let startX = 0;
          let startWidth = 0;
          
          resizer.addEventListener("mousedown", (e) => {
            e.preventDefault();
            e.stopPropagation();
            isResizing = true;
            startX = e.clientX;
            startWidth = button.offsetWidth;
            
            // 計算按鈕所在欄位的最大寬度
            const panel = wrapper.closest(".panel");
            const panelBody = panel?.querySelector(".panel-body");
            const columnCount = parseInt(panel?.dataset.columns || "3");
            const fieldWidth = wrapper.dataset.width || "small";
            let spanColumns = 1;
            if (fieldWidth === "medium") {
              spanColumns = 2;
            } else if (fieldWidth === "full") {
              spanColumns = columnCount;
            }
            
            // 計算欄位實際寬度（考慮 padding 和 gap）
            const fieldRect = wrapper.getBoundingClientRect();
            const maxWidth = fieldRect.width;
            
            resizer.classList.add("active");
            document.body.style.cursor = "ew-resize";
            document.body.style.userSelect = "none";
            
            const handleMouseMove = (e) => {
              if (!isResizing) return;
              const diff = e.clientX - startX;
              const newWidth = Math.max(80, Math.min(maxWidth, startWidth + diff));
              button.style.width = newWidth + "px";
              wrapper.dataset.buttonWidth = newWidth;
            };
            
            const handleMouseUp = () => {
              isResizing = false;
              resizer.classList.remove("active");
              document.body.style.cursor = "";
              document.body.style.userSelect = "";
              document.removeEventListener("mousemove", handleMouseMove);
              document.removeEventListener("mouseup", handleMouseUp);
            };
            
            document.addEventListener("mousemove", handleMouseMove);
            document.addEventListener("mouseup", handleMouseUp);
          });
        }
      } else if (type === "fixedtext") {
        // 固定文字類型：沒有 label，只有 control，無框線、背景透明
        // 優先使用實際值，如果沒有則使用預設值
        const fixedTextValue = config.value || config.defaultValue || "固定文字";
        wrapper.innerHTML = `
          <div class="field-delete" title="刪除欄位">×</div>
          <div class="field-control">
            ${fieldTemplates[type](fixedTextValue)}
          </div>
        `;
        wrapper.classList.add("field-fixedtext");
        // 設置文字顏色
        const input = wrapper.querySelector(".field-control input");
        if (input) {
          input.style.color = textColor;
        }
      } else if (type === "grid-tab") {
        // GRID 頁籤：沒有 label，只有 control，包含完整的 GRID 結構
        wrapper.innerHTML = `
          <div class="field-delete" title="刪除欄位">×</div>
          <div class="field-control">
            <div class="grid-panel-body"></div>
          </div>
        `;
        wrapper.classList.add("field-grid-tab");
        // GRID 頁籤必須全寬
        wrapper.dataset.width = "full";
        wrapper.draggable = true;
        
        // 先將 wrapper 添加到目標容器，確保 DOM 結構完整
        if (replaceElement && replaceElement.parentNode) {
          replaceElement.parentNode.replaceChild(wrapper, replaceElement);
        } else {
          targetBody.appendChild(wrapper);
        }
        
        // 驗證 wrapper 是否正確添加到 DOM
        const isInDOM = targetBody.contains(wrapper);
        console.log("grid-tab wrapper 已添加到 DOM", {
          isInDOM: isInDOM,
          targetBody: targetBody ? {
            className: targetBody.className,
            hasActive: targetBody.classList.contains("active"),
            childrenCount: targetBody.children.length,
            display: window.getComputedStyle(targetBody).display
          } : "null",
          wrapper: wrapper ? {
            className: wrapper.className,
            hasGridPanelBody: !!wrapper.querySelector(".grid-panel-body"),
            parentElement: wrapper.parentElement ? wrapper.parentElement.className : "null"
          } : "null"
        });
        
        if (!isInDOM) {
          console.error("錯誤：grid-tab wrapper 沒有正確添加到 DOM！");
        }
        
        // 初始化 GRID 頁籤
        const gridBody = wrapper.querySelector(".grid-panel-body");
        if (gridBody) {
          // 傳遞 gridColumns 和 gridRows 配置
          // 確保從 config 中正確讀取 gridColumns 和 gridRows
          const gridColumns = Array.isArray(config.gridColumns) ? config.gridColumns : [];
          const gridRows = Array.isArray(config.gridRows) ? config.gridRows : [];
          
          console.log("grid-tab addField 收到配置：", {
            gridColumnsLength: gridColumns.length,
            gridRowsLength: gridRows.length,
            targetBody: targetBody ? targetBody.className : "null",
            gridBody: gridBody ? "found" : "not found"
          });
          
          // 調試：檢查配置
          if (gridColumns.length === 0 && gridRows.length === 0) {
            console.warn("警告：grid-tab 初始化時 gridColumns 和 gridRows 為空", config);
          } else {
            console.log("開始初始化 grid-tab:", {
              columns: gridColumns.length,
              rows: gridRows.length,
              firstColumn: gridColumns[0]
            });
          }
          
          const gridConfig = {
            gridColumns: gridColumns,
            gridRows: gridRows
          };
          
          // 調用 initGridPanel 初始化 GRID 結構
          try {
            initGridPanel(gridBody, gridConfig);
            
            // 驗證初始化後的結構
            const headerCells = gridBody.querySelectorAll(".grid-header-cell");
            const dataRows = gridBody.querySelectorAll(".grid-data-row");
            const isInDOM = targetBody.contains(wrapper);
            
            console.log("grid-tab 初始化完成，驗證：", {
              isInDOM: isInDOM,
              headerCellsCount: headerCells.length,
              dataRowsCount: dataRows.length,
              targetBodyActive: targetBody.classList.contains("active"),
              targetBodyDisplay: window.getComputedStyle(targetBody).display,
              wrapperDisplay: window.getComputedStyle(wrapper).display
            });
            
            if (!isInDOM) {
              console.error("嚴重錯誤：grid-tab wrapper 沒有在 DOM 中！");
            }
          } catch (error) {
            console.error("初始化 grid-tab 時發生錯誤：", error);
            console.error("錯誤堆疊：", error.stack);
          }
        } else {
          console.error("錯誤：找不到 grid-panel-body 元素", {
            wrapper: wrapper,
            wrapperHTML: wrapper ? wrapper.innerHTML.substring(0, 200) : "null",
            targetBody: targetBody
          });
        }
        
        // 設置其他屬性
        const isRequired = config.required === true || config.required === "true";
        wrapper.dataset.required = isRequired ? "true" : "false";
        const isReadonly = config.readonly === true || config.readonly === "true";
        wrapper.dataset.readonly = isReadonly ? "true" : "false";
        const isPrimaryKey = config.primaryKey === true || config.primaryKey === "true";
        wrapper.dataset.primaryKey = isPrimaryKey ? "true" : "false";
        wrapper.dataset.dbField = config.dbField || "";
        wrapper.dataset.fieldLength = config.length || "N/A";
        wrapper.dataset.fieldType = config.fieldType || "real";
        wrapper.dataset.selectOptions = config.selectOptions || "";
        wrapper.dataset.fieldTcode = config.tcode || "N/A";
        wrapper.dataset.relationField = (config.relationField && config.relationField !== "N/A") ? config.relationField : "";
        wrapper.dataset.otherNote = config.otherNote || "N/A";
        
        // 設置拖曳功能（與其他欄位相同）
        wrapper.addEventListener("dragstart", (event) => {
          event.dataTransfer.setData("move-field", "true");
          window._draggedField = wrapper;
          wrapper.classList.add("dragging");
          isDraggingField = true;
        });

        wrapper.addEventListener("dragover", (event) => {
          event.preventDefault();
          if (window._draggedField && window._draggedField !== wrapper) {
            const targetContainer = wrapper.parentElement;
            targetContainer.querySelectorAll(".field").forEach(f => {
              if (f !== wrapper && f !== window._draggedField) {
                f.classList.remove("drag-over");
              }
            });
            wrapper.classList.add("drag-over");
          }
        });

        wrapper.addEventListener("drop", (event) => {
          event.preventDefault();
          event.stopPropagation();
          wrapper.classList.remove("drag-over");
          const targetContainer = wrapper.parentElement;
          if (window._draggedField && window._draggedField !== wrapper) {
            targetContainer.insertBefore(window._draggedField, wrapper);
            selectField(window._draggedField);
          }
        });

        wrapper.addEventListener("dragend", (event) => {
          wrapper.classList.remove("dragging");
          document.querySelectorAll(".field").forEach(f => {
            f.classList.remove("drag-over");
          });
          window._draggedField = null;
          isDraggingField = false;
        });
        
        // 設置刪除功能
        const fieldDelete = wrapper.querySelector(".field-delete");
        if (fieldDelete) {
          fieldDelete.addEventListener("click", (e) => {
            e.stopPropagation();
            if (confirm("確定要刪除此欄位？")) {
              wrapper.remove();
              selectField(null);
            }
          });
        }
        
        // 不需要繼續執行後續的代碼，直接返回
        return;
      } else {
        const labelClass = isRequired ? "field-label required" : "field-label";
        // 如果是 text 類型且列高 > 1，使用 textarea 而不是 input
        let controlHTML = fieldTemplates[type]();
        if (type === "text" && parseInt(rowHeight) > 1) {
          const placeholder = fieldTemplates.text().match(/placeholder="([^"]*)"/)?.[1] || "請輸入內容";
          controlHTML = `<textarea placeholder="${placeholder}"></textarea>`;
        }
        wrapper.innerHTML = `
          <div class="field-delete" title="刪除欄位">×</div>
          <div class="${labelClass}">
            <span class="label-text" contenteditable="true">${config.label || defaultLabel(type)}</span>
          </div>
          <div class="field-control">
            ${controlHTML}
          </div>
        `;
      }

      // 空欄位不需要處理 control
      if (type !== "empty") {
        const controlInput = wrapper.querySelector(".field-control input, .field-control textarea, .field-control select, .field-control button");
        const placeholderInput = wrapper.querySelector(".field-control input, .field-control textarea");
        if (placeholderInput && placeholderInput.placeholder) {
          placeholderInput.setAttribute("data-placeholder", placeholderInput.placeholder);
        }
        // 如果是 select 類型且有下拉選項，更新選項
        if (type === "select" && selectOptions && controlInput && controlInput.tagName === "SELECT") {
          const options = selectOptions.split(";").filter(opt => opt.trim());
          controlInput.innerHTML = '<option value="">請選擇</option>';
          options.forEach(opt => {
            const option = document.createElement("option");
            option.value = opt.trim();
            option.textContent = opt.trim();
            controlInput.appendChild(option);
          });
        }
        
        // 保存預設值到 dataset.defaultValue（欄位規格中的預設值）
        if (typeof config.defaultValue !== "undefined") {
          wrapper.dataset.defaultValue = config.defaultValue ?? "";
        }
        
        // 更新唯讀樣式（如果欄位有唯讀屬性）
        const isReadonly = wrapper.dataset.readonly === "true";
        updateFieldReadonlyStyle(wrapper, isReadonly);
        
        // 如果是數值欄位，添加千分逗號格式化
        if (type === "number" && controlInput && controlInput.tagName === "INPUT") {
          controlInput.classList.add("number-input");
          
          // 格式化函數：添加千分逗號
          const formatNumber = (value) => {
            if (!value) return "";
            // 移除所有非數字字符（保留負號和小數點）
            const numStr = value.toString().replace(/[^\d.-]/g, "");
            if (!numStr) return "";
            // 分割整數和小數部分
            const parts = numStr.split(".");
            // 格式化整數部分（添加千分逗號）
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join(".");
          };
          
          // 解析函數：移除千分逗號
          const parseNumber = (value) => {
            return value.toString().replace(/,/g, "");
          };
          
          // 輸入時格式化
          controlInput.addEventListener("input", (e) => {
            const cursorPos = e.target.selectionStart;
            const oldValue = e.target.value;
            const newValue = formatNumber(parseNumber(oldValue));
            e.target.value = newValue;
            // 恢復游標位置（考慮新增的逗號）
            const diff = newValue.length - oldValue.length;
            e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
          });
          
          // 失去焦點時確保格式化
          controlInput.addEventListener("blur", (e) => {
            e.target.value = formatNumber(parseNumber(e.target.value));
          });
        }
        
        // 如果是下拉選單，設置預設值顯示
        if (type === "select" && controlInput && controlInput.tagName === "SELECT") {
          const defaultValue = config.defaultValue || "";
          if (defaultValue) {
            // 嘗試找到匹配的選項
            const options = Array.from(controlInput.options);
            const matchingOption = options.find(opt => 
              opt.value === defaultValue || 
              opt.textContent === defaultValue ||
              opt.value.trim() === defaultValue.trim() ||
              opt.textContent.trim() === defaultValue.trim()
            );
            if (matchingOption) {
              controlInput.value = matchingOption.value;
            } else {
              // 如果找不到匹配的選項，添加一個預設值選項
              const defaultOption = document.createElement("option");
              defaultOption.value = defaultValue;
              defaultOption.textContent = defaultValue;
              defaultOption.selected = true;
              controlInput.insertBefore(defaultOption, controlInput.firstChild);
            }
          }
        }
        
        // 設置欄位的實際輸入值（如果有的話）
        if (typeof config.value !== "undefined" && config.value !== "" && controlInput) {
          if (controlInput.tagName === "SELECT") {
            // 對於 select，嘗試找到匹配的選項
            const options = Array.from(controlInput.options);
            const matchingOption = options.find(opt => opt.value === config.value || opt.textContent === config.value);
            if (matchingOption) {
              controlInput.value = matchingOption.value;
            }
          } else if (controlInput.tagName === "TEXTAREA") {
            controlInput.value = config.value;
          } else if (controlInput.tagName === "INPUT") {
            if (type === "number") {
              // 數值欄位需要格式化
              const formatNumber = (value) => {
                if (!value) return "";
                const numStr = value.toString().replace(/[^\d.-]/g, "");
                if (!numStr) return "";
                const parts = numStr.split(".");
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return parts.join(".");
              };
              controlInput.value = formatNumber(config.value);
            } else {
              controlInput.value = config.value;
            }
          }
        } else if (type === "number" && controlInput && controlInput.tagName === "INPUT" && config.defaultValue) {
          // 如果沒有實際值但有預設值，顯示預設值（格式化）
          const formatNumber = (value) => {
            if (!value) return "";
            const numStr = value.toString().replace(/[^\d.-]/g, "");
            if (!numStr) return "";
            const parts = numStr.split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join(".");
          };
          controlInput.value = formatNumber(config.defaultValue);
        }
        
        // 注意：欄位規格中的預設值與欄位的實際值是分離的
        // 但匯出時會同時保存兩者，載入時會恢復實際值
      }

      wrapper.addEventListener("dragstart", (event) => {
        event.dataTransfer.setData("move-field", "true");
        window._draggedField = wrapper;
        wrapper.classList.add("dragging");
        isDraggingField = true;
      });

      wrapper.addEventListener("dragover", (event) => {
        event.preventDefault();
        if (window._draggedField && window._draggedField !== wrapper) {
          const targetContainer = wrapper.parentElement;
          // 清除其他欄位的 drag-over 狀態
          targetContainer.querySelectorAll(".field").forEach(f => {
            if (f !== wrapper && f !== window._draggedField) {
              f.classList.remove("drag-over");
            }
          });
          // 設置當前欄位的 drag-over 狀態
          wrapper.classList.add("drag-over");
        }
      });

      wrapper.addEventListener("dragleave", (event) => {
        // 只有當離開欄位本身時才移除 drag-over 狀態
        if (!wrapper.contains(event.relatedTarget)) {
          wrapper.classList.remove("drag-over");
        }
      });

      wrapper.addEventListener("drop", (event) => {
        event.preventDefault();
        event.stopPropagation();
        wrapper.classList.remove("drag-over");
        const targetContainer = wrapper.parentElement;
        if (window._draggedField && window._draggedField !== wrapper) {
          // 插入到目標欄位之前，其他欄位會自動往後推（由左而右）
              targetContainer.insertBefore(window._draggedField, wrapper);
          selectField(window._draggedField);
        }
      });

      wrapper.addEventListener("dragend", (event) => {
        wrapper.classList.remove("dragging");
        // 清除所有欄位的 drag-over 狀態
        document.querySelectorAll(".field").forEach(f => {
          f.classList.remove("drag-over");
        });
        window._draggedField = null;
        isDraggingField = false;
      });

      // GRID 面板不使用 addField 函數
      const isGridPanel = targetBody.classList.contains("grid-panel-body");
      if (isGridPanel) {
        return; // GRID 面板有自己的處理邏輯
      }
      
      // 刪除欄位按鈕
      const fieldDelete = wrapper.querySelector(".field-delete");
      fieldDelete.addEventListener("click", (e) => {
        e.stopPropagation();
        if (confirm("確定要刪除此欄位？")) {
          wrapper.remove();
          selectField(null);
        }
      });
      
      if (replaceElement) {
        replaceElement.replaceWith(wrapper);
      } else {
        targetBody.appendChild(wrapper);
      }
      
      // 為欄位內的 input/textarea/select 添加 focus 事件處理器，確保 focus 時正確設置 selectedField
      const controlInput = wrapper.querySelector(".field-control input, .field-control textarea, .field-control select");
      if (controlInput) {
        controlInput.addEventListener("focus", (e) => {
          e.stopPropagation();
          // 先設置選中的欄位
          selectField(wrapper);
          // 然後設置活動面板
          const body = wrapper.closest(".panel-body, .tab-body");
          if (body) {
            setActivePanel(body);
          }
          // 確保「開窗設定」按鈕正確啟用（直接更新，不依賴其他邏輯）
          if (btnFieldSpecModal) {
            const isEmpty = wrapper.dataset.type === "empty";
            const isButton = wrapper.dataset.type === "button";
            const isFixedText = wrapper.dataset.type === "fixedtext";
            btnFieldSpecModal.disabled = isEmpty || isButton || isFixedText;
          }
        }, true); // 使用捕獲階段，確保在其他事件之前處理
      }
      
      // 設置標題可編輯功能
      const labelText = wrapper.querySelector(".label-text");
      if (labelText) {
        // 阻止點擊標題時觸發欄位選擇
        labelText.addEventListener("click", (e) => {
          e.stopPropagation();
        });
        
        // 處理貼上事件：只保留純文字，移除所有格式
        labelText.addEventListener("paste", (e) => {
          e.preventDefault();
          const text = (e.clipboardData || window.clipboardData).getData("text/plain");
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            const textNode = document.createTextNode(text);
            range.insertNode(textNode);
            range.setStartAfter(textNode);
            range.setEndAfter(textNode);
            selection.removeAllRanges();
            selection.addRange(range);
          } else {
            labelText.textContent = text;
          }
          // 觸發 input 事件以同步更新屬性面板
          labelText.dispatchEvent(new Event("input", { bubbles: true }));
        });
        
        // 當標題內容改變時，同步更新屬性面板
        labelText.addEventListener("input", () => {
          if (selectedField === wrapper && propLabel) {
            propLabel.value = labelText.textContent.trim() || "未命名欄位";
          }
        });
        
        // 當標題失去焦點時，確保有內容
        labelText.addEventListener("blur", () => {
          if (!labelText.textContent.trim()) {
            labelText.textContent = "未命名欄位";
          }
        });
      }
      
      selectField(wrapper);
      setActivePanel(targetBody);
    }


    function setPanelColumns(panel, columns, targetBody = null) {
      // 如果指定了 targetBody，只應用到該 body（用於有頁籤的面板）
      if (targetBody) {
        targetBody.style.setProperty("--column-count", columns);
        // 保存到 targetBody 的 dataset
        targetBody.dataset.columns = columns;
      } else {
        // 沒有指定 targetBody，應用到所有 tab-body 和 panel-body（向後兼容）
        panel.querySelectorAll(".tab-body, .panel-body").forEach((body) => {
      body.style.setProperty("--column-count", columns);
          body.dataset.columns = columns;
        });
      panel.dataset.columns = columns;
      }
      
      // 更新面板上的欄數選擇器
      updatePanelColumnSelect(panel, targetBody);
    }
    
    function updatePanelColumnSelect(panel, targetBody = null) {
      const select = panel.querySelector(".panel-column-select");
      const customInput = panel.querySelector(".panel-column-custom");
      
      if (!select) return;
      
      // 如果有指定 targetBody，從 targetBody 取得欄數；否則從 panel 取得
      let columns;
      if (targetBody) {
        columns = targetBody.dataset.columns || panel.dataset.columns || "3";
      } else {
        columns = panel.dataset.columns || "3";
      }
      
        const isCustom = !["2", "3", "4", "5"].includes(String(columns));
        if (isCustom) {
          select.value = "custom";
          if (customInput) {
            customInput.style.display = "inline-block";
            customInput.value = columns;
          }
        } else {
          select.value = String(columns);
          if (customInput) {
            customInput.style.display = "none";
        }
      }
    }

    function defaultLabel(type) {
      switch (type) {
        case "text":
          return "客戶名稱";
        case "number":
          return "數量";
        case "date":
          return "下單日期";
        case "select":
          return "單據狀態";
        case "textarea":
          return "備註說明";
        case "button":
          return "按鈕";
        case "fixedtext":
          return "固定文字";
        default:
          return "未命名欄位";
      }
    }

    function selectField(field) {
      // 清除其他選中狀態
      if (selectedField) {
        selectedField.classList.remove("selected");
      }
      if (selectedGridHeaderCell) {
        selectedGridHeaderCell.classList.remove("selected");
        selectedGridHeaderCell = null;
      }
      selectedField = field;

      const disabled = !field;
      [propLabel, propDbField, propWidth, propRowHeight, propLength, propFieldType, propSelectOptions, propRelationField, propOtherNote, propRequired, propReadonly, propPrimaryKey, propDefault].forEach((el) => {
        el.disabled = disabled;
        if (!field) {
          if (el.type === "checkbox") {
            el.checked = false;
          } else if (el === propLength) {
            el.value = "N/A";
          } else if (el === propFieldType) {
            el.value = "real";
          } else if (el === propRelationField || el === propOtherNote) {
            el.value = "N/A";
          } else {
            el.value = "";
          }
        }
      });

      if (field) {
        field.classList.add("selected");
        const isEmpty = field.dataset.type === "empty";
        const isButton = field.dataset.type === "button";
        const isFixedText = field.dataset.type === "fixedtext";
        
        // 隱藏/顯示 label 輸入框和必填選項
        const labelInput = propLabel.closest("label");
        if (labelInput) {
          labelInput.style.display = (isEmpty || isButton || isFixedText) ? "none" : "flex";
        }
        const dbFieldInput = propDbField.closest("label");
        if (dbFieldInput) {
          dbFieldInput.style.display = (isEmpty || isButton || isFixedText) ? "none" : "flex";
        }
        // 顯示/隱藏文字顏色選擇器
        if (propTextColorLabel) {
          propTextColorLabel.style.display = isFixedText ? "flex" : "none";
        }
        const lengthInput = propLength.closest("label");
        if (lengthInput) {
          lengthInput.style.display = (isEmpty || isButton || isFixedText) ? "none" : "flex";
        }
        const fieldTypeInput = propFieldType.closest("label");
        if (fieldTypeInput) {
          fieldTypeInput.style.display = (isEmpty || isButton || isFixedText) ? "none" : "flex";
        }
        const selectOptionsInput = propSelectOptions.closest("label");
        if (selectOptionsInput) {
          selectOptionsInput.style.display = (isEmpty || isButton || isFixedText) ? "none" : "flex";
        }
        // propTcode 輸入框已移除
        const relationFieldInput = propRelationField.closest("label");
        if (relationFieldInput) {
          relationFieldInput.style.display = (isEmpty || isButton || isFixedText) ? "none" : "flex";
        }
        const otherNoteInput = propOtherNote.closest("label");
        if (otherNoteInput) {
          otherNoteInput.style.display = (isEmpty || isButton || isFixedText) ? "none" : "flex";
        }
        const requiredInput = propRequired.closest("label");
        if (requiredInput) {
          requiredInput.style.display = (isEmpty || isButton || isFixedText) ? "none" : "flex";
        }
        const readonlyInput = propReadonly.closest("label");
        if (readonlyInput) {
          readonlyInput.style.display = (isEmpty || isButton || isFixedText) ? "none" : "flex";
        }
        const primaryKeyInput = propPrimaryKey.closest("label");
        if (primaryKeyInput) {
          primaryKeyInput.style.display = (isEmpty || isButton || isFixedText) ? "none" : "flex";
        }
        
        if (isEmpty) {
          propLabel.value = "";
          propDbField.value = "";
          propLength.value = "N/A";
          propFieldType.value = "real";
          propSelectOptions.value = "";
          // propTcode 已移除
          propRelationField.value = "";
          propOtherNote.value = "N/A";
          propDefault.value = field.dataset.defaultValue || "";
          propRequired.checked = false;
          propReadonly.checked = false;
          propPrimaryKey.checked = false;
        } else if (isButton) {
          propLabel.value = "";
          propDbField.value = "";
          propLength.value = "N/A";
          propFieldType.value = "real";
          propSelectOptions.value = "";
          // propTcode 已移除
          propRelationField.value = "";
          propOtherNote.value = "N/A";
          propDefault.value = field.dataset.defaultValue || "";
          propRequired.checked = false;
          propReadonly.checked = false;
          propPrimaryKey.checked = false;
        } else if (isFixedText) {
          propLabel.value = "";
          propDbField.value = "";
          propLength.value = "N/A";
          propFieldType.value = "real";
          propSelectOptions.value = "";
          // propTcode 已移除
          propRelationField.value = "";
          propOtherNote.value = "N/A";
          propDefault.value = field.dataset.defaultValue || "";
          propTextColor.value = field.dataset.textColor || "#233018";
          propRequired.checked = false;
          propReadonly.checked = false;
          propPrimaryKey.checked = false;
        } else {
          const labelText = field.querySelector(".label-text");
          propLabel.value = labelText ? labelText.textContent : "";
          propDbField.value = field.dataset.dbField || "";
          propLength.value = field.dataset.fieldLength || "N/A";
          propFieldType.value = field.dataset.fieldType || "real";
          propSelectOptions.value = field.dataset.selectOptions || "";
          // propTcode 已移除
          propRelationField.value = (field.dataset.relationField && field.dataset.relationField !== "N/A") ? field.dataset.relationField : "";
          propOtherNote.value = field.dataset.otherNote || "N/A";
          propDefault.value = field.dataset.defaultValue || "";
          propRequired.checked = field.dataset.required === "true";
          propReadonly.checked = field.dataset.readonly === "true";
          propPrimaryKey.checked = field.dataset.primaryKey === "true";
          
          // 更新唯讀樣式
          const isReadonly = field.dataset.readonly === "true";
          updateFieldReadonlyStyle(field, isReadonly);
        }
        propWidth.value = field.dataset.width || "small";
        propRowHeight.value = field.dataset.rowHeight || "1";
      } else {
        // 恢復 label 輸入框和必填選項顯示
        const labelInput = propLabel.closest("label");
        if (labelInput) {
          labelInput.style.display = "flex";
        }
        const dbFieldInput = propDbField.closest("label");
        if (dbFieldInput) {
          dbFieldInput.style.display = "flex";
        }
        const lengthInput = propLength.closest("label");
        if (lengthInput) {
          lengthInput.style.display = "flex";
        }
        const fieldTypeInput = propFieldType.closest("label");
        if (fieldTypeInput) {
          fieldTypeInput.style.display = "flex";
        }
        const selectOptionsInput = propSelectOptions.closest("label");
        if (selectOptionsInput) {
          selectOptionsInput.style.display = "flex";
        }
        // propTcode 輸入框已移除
        const relationFieldInput = propRelationField.closest("label");
        if (relationFieldInput) {
          relationFieldInput.style.display = "flex";
        }
        const otherNoteInput = propOtherNote.closest("label");
        if (otherNoteInput) {
          otherNoteInput.style.display = "flex";
        }
        const requiredInput = propRequired.closest("label");
        if (requiredInput) {
          requiredInput.style.display = "flex";
        }
        const readonlyInput = propReadonly.closest("label");
        if (readonlyInput) {
          readonlyInput.style.display = "flex";
        }
        const primaryKeyInput = propPrimaryKey.closest("label");
        if (primaryKeyInput) {
          primaryKeyInput.style.display = "flex";
        }
        // 隱藏文字顏色選擇器
        if (propTextColorLabel) {
          propTextColorLabel.style.display = "none";
        }
      }
      
      // 隱藏區塊屬性，顯示欄位屬性
      fieldProperties.style.display = "block";
      if (panelPropertiesSection) {
        panelPropertiesSection.style.display = "none";
      }

      // 更新「開窗設定」按鈕的啟用/禁用狀態
      if (btnFieldSpecModal) {
        const isEmpty = field && field.dataset.type === "empty";
        const isButton = field && field.dataset.type === "button";
        const isFixedText = field && field.dataset.type === "fixedtext";
        btnFieldSpecModal.disabled = !field || isEmpty || isButton || isFixedText;
      }
    }

    function selectGridHeaderCell(headerCell) {
      // 清除其他選中狀態
      if (selectedField) {
        selectedField.classList.remove("selected");
        selectedField = null;
      }
      if (selectedGridHeaderCell) {
        selectedGridHeaderCell.classList.remove("selected");
      }
      selectedGridHeaderCell = headerCell;

      const disabled = !headerCell;
      [propLabel, propDbField, propWidth, propRowHeight, propLength, propFieldType, propSelectOptions, propRelationField, propOtherNote, propRequired, propReadonly, propPrimaryKey, propDefault].forEach((el) => {
        el.disabled = disabled;
        if (!headerCell) {
          if (el.type === "checkbox") {
            el.checked = false;
          } else if (el === propLength) {
            el.value = "N/A";
          } else if (el === propFieldType) {
            el.value = "real";
          } else if (el === propRelationField || el === propOtherNote) {
            el.value = "N/A";
          } else {
            el.value = "";
          }
        }
      });

      if (headerCell) {
        headerCell.classList.add("selected");
        
        // 顯示所有欄位屬性輸入框
        const labelInput = propLabel.closest("label");
        if (labelInput) {
          labelInput.style.display = "flex";
        }
        const dbFieldInput = propDbField.closest("label");
        if (dbFieldInput) {
          dbFieldInput.style.display = "flex";
        }
        const lengthInput = propLength.closest("label");
        if (lengthInput) {
          lengthInput.style.display = "flex";
        }
        const fieldTypeInput = propFieldType.closest("label");
        if (fieldTypeInput) {
          fieldTypeInput.style.display = "flex";
        }
        const selectOptionsInput = propSelectOptions.closest("label");
        if (selectOptionsInput) {
          selectOptionsInput.style.display = "flex";
        }
        // propTcode 輸入框已移除
        const relationFieldInput = propRelationField.closest("label");
        if (relationFieldInput) {
          relationFieldInput.style.display = "flex";
        }
        const otherNoteInput = propOtherNote.closest("label");
        if (otherNoteInput) {
          otherNoteInput.style.display = "flex";
        }
        const requiredInput = propRequired.closest("label");
        if (requiredInput) {
          requiredInput.style.display = "flex";
        }
        const readonlyInput = propReadonly.closest("label");
        if (readonlyInput) {
          readonlyInput.style.display = "flex";
        }
        const primaryKeyInput = propPrimaryKey.closest("label");
        if (primaryKeyInput) {
          primaryKeyInput.style.display = "flex";
        }
        
        // 載入 grid header cell 的屬性
        const titleEl = headerCell.querySelector(".header-title");
        let titleText = titleEl ? titleEl.textContent.trim() : "";
        // 如果標題有括號（唯讀狀態），提取實際標題
        if (titleText.startsWith("(") && titleText.endsWith(")")) {
          titleText = titleText.slice(1, -1).trim();
        }
        propLabel.value = titleText;
        propDbField.value = headerCell.dataset.dbField || "";
        propWidth.value = headerCell.dataset.width || "small";
        propRowHeight.value = headerCell.dataset.rowHeight || "1";
        propLength.value = headerCell.dataset.fieldLength || "N/A";
        propFieldType.value = headerCell.dataset.fieldType || "real";
        propSelectOptions.value = headerCell.dataset.selectOptions || "";
        // propTcode 已移除
        propRelationField.value = (headerCell.dataset.relationField && headerCell.dataset.relationField !== "N/A") ? headerCell.dataset.relationField : "";
        propOtherNote.value = headerCell.dataset.otherNote || "N/A";
        propDefault.value = headerCell.dataset.defaultValue || "";
        propRequired.checked = headerCell.dataset.required === "true";
        propReadonly.checked = headerCell.dataset.readonly === "true";
        propPrimaryKey.checked = headerCell.dataset.primaryKey === "true";
        
        // 更新必填狀態的顯示
        updateGridHeaderRequired(headerCell);
        // 更新唯讀狀態的顯示
        updateGridHeaderReadonly(headerCell);
      } else {
        // 恢復 label 輸入框和必填選項顯示
        const labelInput = propLabel.closest("label");
        if (labelInput) {
          labelInput.style.display = "flex";
        }
        const dbFieldInput = propDbField.closest("label");
        if (dbFieldInput) {
          dbFieldInput.style.display = "flex";
        }
        const lengthInput = propLength.closest("label");
        if (lengthInput) {
          lengthInput.style.display = "flex";
        }
        const fieldTypeInput = propFieldType.closest("label");
        if (fieldTypeInput) {
          fieldTypeInput.style.display = "flex";
        }
        const selectOptionsInput = propSelectOptions.closest("label");
        if (selectOptionsInput) {
          selectOptionsInput.style.display = "flex";
        }
        // propTcode 輸入框已移除
        const relationFieldInput = propRelationField.closest("label");
        if (relationFieldInput) {
          relationFieldInput.style.display = "flex";
        }
        const otherNoteInput = propOtherNote.closest("label");
        if (otherNoteInput) {
          otherNoteInput.style.display = "flex";
        }
        const requiredInput = propRequired.closest("label");
        if (requiredInput) {
          requiredInput.style.display = "flex";
        }
        const readonlyInput = propReadonly.closest("label");
        if (readonlyInput) {
          readonlyInput.style.display = "flex";
        }
        const primaryKeyInput = propPrimaryKey.closest("label");
        if (primaryKeyInput) {
          primaryKeyInput.style.display = "flex";
        }
      }
      
      // 隱藏區塊屬性，顯示欄位屬性
      fieldProperties.style.display = "block";
      if (panelPropertiesSection) {
        panelPropertiesSection.style.display = "none";
      }

      // 更新「開窗設定」按鈕的啟用/禁用狀態
      if (btnFieldSpecModal) {
        btnFieldSpecModal.disabled = !headerCell;
      }
    }

    function setActivePanel(body) {
      canvas.querySelectorAll(".panel").forEach((panel) => panel.classList.remove("active"));
      activePanelBody = body || null;
      if (body) {
        const panel = body.closest(".panel");
        panel.classList.add("active");
        
        // 如果沒有選中欄位或 grid header cell，顯示區塊屬性
        if (!selectedField && !selectedGridHeaderCell) {
          // 禁用「開窗設定」按鈕
          if (btnFieldSpecModal) {
            btnFieldSpecModal.disabled = true;
          }
          // 對於有頁籤的面板，從 tab-body 載入屬性；否則從 panel 載入
          const panelHasTabs = panel.querySelector(".panel-tabs");
          const targetElement = (panelHasTabs && body && body.classList.contains("tab-body")) ? body : panel;
          
          // 載入資料表識別
          const tableId = targetElement.dataset.panelTableId || "";
          if (tableId === "custom") {
            propPanelTableId.value = "custom";
            propPanelTableIdCustom.style.display = "block";
            propPanelTableIdCustom.value = targetElement.dataset.panelTableIdCustom || "";
          } else if (tableId && ["A", "B", "C", "D", "E"].includes(tableId)) {
            propPanelTableId.value = tableId;
            propPanelTableIdCustom.style.display = "none";
            propPanelTableIdCustom.value = "";
          } else {
            propPanelTableId.value = "A";
            propPanelTableIdCustom.style.display = "none";
            propPanelTableIdCustom.value = "";
          }
          
          // 載入關聯的父表
          const parentTable = targetElement.dataset.panelParentTable || "";
          if (parentTable === "custom") {
            propPanelParentTable.value = "custom";
            propPanelParentTableCustom.style.display = "block";
            propPanelParentTableCustom.value = targetElement.dataset.panelParentTableCustom || "";
          } else if (parentTable && ["A", "B", "C", "D", "E"].includes(parentTable)) {
            propPanelParentTable.value = parentTable;
            propPanelParentTableCustom.style.display = "none";
            propPanelParentTableCustom.value = "";
          } else {
            // 預設為 N/A（空字串）
            propPanelParentTable.value = "";
            propPanelParentTableCustom.style.display = "none";
            propPanelParentTableCustom.value = "";
            // 如果目標元素沒有設置 parentTable，則設置預設值
            if (!targetElement.dataset.panelParentTable) {
              targetElement.dataset.panelParentTable = "";
            }
          }
          
          // 載入 DB 資料表名(Eng)
          propPanelDbTable.value = targetElement.dataset.panelDbTable || "";
          
          // 載入頁籤標題（適用於所有面板類型）
          if (propPanelTabTitle && propPanelTabTitleLabel) {
            // 顯示頁籤標題輸入框
            propPanelTabTitleLabel.style.display = "block";
            if (panelHasTabs) {
              // 有頁籤的面板：載入當前活動頁籤的標題
              const activeTab = panel.querySelector(".panel-tab.active");
              if (activeTab) {
                const tabInput = activeTab.querySelector(".panel-tab-input");
                if (tabInput) {
                  propPanelTabTitle.value = tabInput.value || "";
                } else {
                  propPanelTabTitle.value = panel.dataset.panelTabTitle || "";
                }
              } else {
                propPanelTabTitle.value = panel.dataset.panelTabTitle || "";
              }
            } else {
              // 無頁籤的面板或 GRID 面板：載入面板標題
              propPanelTabTitle.value = panel.dataset.panelTabTitle || panel.dataset.title || "";
            }
          }
          
          // GRID 面板和非 GRID 面板都顯示區塊屬性
          fieldProperties.style.display = "none";
          if (panelPropertiesSection) {
            panelPropertiesSection.style.display = "block";
          }
        } else {
          fieldProperties.style.display = "block";
          if (panelPropertiesSection) {
            panelPropertiesSection.style.display = "none";
          }
          // 如果有選中的欄位，更新「開窗設定」按鈕的啟用/禁用狀態
          if (btnFieldSpecModal && selectedField) {
            const isEmpty = selectedField.dataset.type === "empty";
            const isButton = selectedField.dataset.type === "button";
            const isFixedText = selectedField.dataset.type === "fixedtext";
            btnFieldSpecModal.disabled = isEmpty || isButton || isFixedText;
          } else if (btnFieldSpecModal && selectedGridHeaderCell) {
            btnFieldSpecModal.disabled = false;
          }
        }
      } else {
        // 禁用「開窗設定」按鈕
        if (btnFieldSpecModal) {
          btnFieldSpecModal.disabled = true;
        }
        // 清空區塊屬性輸入框
        propPanelTableId.value = "A";
        propPanelTableIdCustom.style.display = "none";
        propPanelTableIdCustom.value = "";
        propPanelParentTable.value = "";
        propPanelParentTableCustom.style.display = "none";
        propPanelParentTableCustom.value = "";
        propPanelDbTable.value = "";
        if (propPanelTabTitle) {
          propPanelTabTitle.value = "";
        }
        if (propPanelTabTitleLabel) {
          propPanelTabTitleLabel.style.display = "none";
        }
        
        fieldProperties.style.display = "block";
        if (panelPropertiesSection) {
          panelPropertiesSection.style.display = "none";
        }
      }
      ensurePlaceholder();
    }

    function ensurePlaceholder() {
      const hasPanel = canvas.querySelector(".panel");
      if (!hasPanel) {
        const titleRow = canvas.querySelector(".doc-title-row");
        if (!placeholder.parentNode) {
          titleRow.insertAdjacentElement("afterend", placeholder);
        }
      } else if (hasPanel && placeholder.parentNode) {
        placeholder.remove();
      }
    }

    function collectLayout() {
      const panels = Array.from(canvas.querySelectorAll(".panel")).map((panel) => {
        const isGrid = panel.classList.contains("grid-panel");
        const hasTabs = panel.querySelector(".panel-tabs") !== null;
        const tabs = hasTabs ? Array.from(panel.querySelectorAll(".panel-tab")).map((tab, idx) => {
          const tabBody = panel.querySelectorAll(".tab-body")[idx];
          const tabConfig = {
          title: tab.querySelector(".panel-tab-input").value || "頁籤",
          active: tab.classList.contains("active")
          };
          // 為每個頁籤保存獨立的區塊屬性
          if (tabBody) {
            if (tabBody.dataset.panelTableId) {
              tabConfig.tableId = tabBody.dataset.panelTableId;
              if (tabBody.dataset.panelTableId === "custom" && tabBody.dataset.panelTableIdCustom) {
                tabConfig.tableIdCustom = tabBody.dataset.panelTableIdCustom;
              }
            }
            if (tabBody.dataset.panelParentTable) {
              tabConfig.parentTable = tabBody.dataset.panelParentTable;
              if (tabBody.dataset.panelParentTable === "custom" && tabBody.dataset.panelParentTableCustom) {
                tabConfig.parentTableCustom = tabBody.dataset.panelParentTableCustom;
              }
            }
            if (tabBody.dataset.panelDbTable) {
              tabConfig.dbTable = tabBody.dataset.panelDbTable;
            }
            // 保存頁籤的欄數和列高
            if (tabBody.dataset.columns) {
              tabConfig.columns = tabBody.dataset.columns;
            }
            if (tabBody.dataset.panelHeight) {
              tabConfig.panelHeight = tabBody.dataset.panelHeight;
            }
          }
          return tabConfig;
        }) : [];
        
        // 收集欄位：對於有頁籤的面板，為每個頁籤收集欄位
        let fields = [];
        if (!isGrid) {
          if (hasTabs) {
            // 有頁籤：為每個 tab-body 收集欄位
            const tabBodies = panel.querySelectorAll(".tab-body");
            tabBodies.forEach((tabBody, tabIdx) => {
              const tabFields = Array.from(tabBody.querySelectorAll(".field")).map((field) => {
                const isEmpty = field.dataset.type === "empty";
                const isButton = field.dataset.type === "button";
                const isFixedText = field.dataset.type === "fixedtext";
                const isGridTab = field.dataset.type === "grid-tab";
                const labelText = (isEmpty || isButton || isFixedText || isGridTab) ? null : field.querySelector(".label-text");
                const defaultValue = field.dataset.defaultValue || "";
                
                let fieldValue = "";
                let gridColumns = [];
                let gridRows = [];
                
                if (isGridTab) {
                  // GRID 頁籤：收集 GRID 結構
                  const gridBody = field.querySelector(".grid-panel-body");
                  if (gridBody) {
                    // 收集表頭欄位
                    const headerCells = gridBody.querySelectorAll(".grid-header-cell");
                    gridColumns = Array.from(headerCells).map((cell) => {
                      let title = cell.querySelector(".header-title")?.textContent.trim() || "新欄位";
                      // 如果標題有括號（唯讀狀態），提取實際標題
                      if (title.startsWith("(") && title.endsWith(")")) {
                        title = title.slice(1, -1).trim();
                      }
                      return {
                        title,
                        width: parseInt(cell.style.width) || 100,
                        dbField: cell.dataset.dbField || "",
                        widthProp: cell.dataset.width || "small",
                        rowHeight: cell.dataset.rowHeight || "1",
                        length: cell.dataset.fieldLength || "N/A",
                        fieldType: cell.dataset.fieldType || "real",
                        selectOptions: cell.dataset.selectOptions || "",
                        tcode: cell.dataset.fieldTcode || "N/A",
                        relationField: (cell.dataset.relationField && cell.dataset.relationField !== "N/A") ? cell.dataset.relationField : "",
                        otherNote: cell.dataset.otherNote || "N/A",
                        required: cell.dataset.required === "true",
                        readonly: cell.dataset.readonly === "true",
                        primaryKey: cell.dataset.primaryKey === "true",
                        defaultValue: cell.dataset.defaultValue || ""
                      };
                    });
                    
                    // 收集資料行
                    const dataRows = gridBody.querySelectorAll(".grid-data-row");
                    gridRows = Array.from(dataRows).map((row) => {
                      const cells = row.querySelectorAll(".grid-data-cell input");
                      return Array.from(cells).map((input) => input.value || "");
                    });
                  }
                } else if (!isEmpty) {
                  const control = field.querySelector(".field-control");
                  if (control) {
                    if (isButton) {
                      const button = control.querySelector("button");
                      if (button) {
                        fieldValue = button.textContent.trim() || "";
                      }
                    } else {
                      const input = control.querySelector("input");
                      const textarea = control.querySelector("textarea");
                      const select = control.querySelector("select");
                      
                      if (input) {
                        fieldValue = input.value || "";
                      } else if (textarea) {
                        fieldValue = textarea.value || "";
                      } else if (select) {
                        fieldValue = select.value || "";
                      }
                    }
                  }
                }
                
                const result = {
                  type: field.dataset.type,
                  label: labelText ? labelText.textContent.trim() : "",
                  dbField: field.dataset.dbField || "",
                  width: field.dataset.width || "small",
                  rowHeight: field.dataset.rowHeight || "1",
                  length: field.dataset.fieldLength || "N/A",
                  fieldType: field.dataset.fieldType || "real",
                  selectOptions: field.dataset.selectOptions || "",
                  tcode: field.dataset.fieldTcode || "N/A",
                  relationField: (field.dataset.relationField && field.dataset.relationField !== "N/A") ? field.dataset.relationField : "",
                  otherNote: field.dataset.otherNote || "N/A",
                  required: field.dataset.required === "true",
                  readonly: field.dataset.readonly === "true",
                  primaryKey: field.dataset.primaryKey === "true",
                  defaultValue,
                  value: fieldValue,
                  tabIndex: tabIdx
                };
                
                // GRID 頁籤：添加 GRID 結構資料
                if (isGridTab) {
                  result.gridColumns = gridColumns;
                  result.gridRows = gridRows;
                }
                
                if (isFixedText && field.dataset.textColor) {
                  result.textColor = field.dataset.textColor;
                }
                if (isButton && field.dataset.buttonWidth) {
                  result.buttonWidth = field.dataset.buttonWidth;
                }
                return result;
              });
              fields = fields.concat(tabFields);
            });
          } else {
            // 無頁籤：從 panel-body 收集欄位
            const body = panel.querySelector(".panel-body");
            if (body) {
              fields = Array.from(body.querySelectorAll(".field")).map((field) => {
          const isEmpty = field.dataset.type === "empty";
          const isButton = field.dataset.type === "button";
          const isFixedText = field.dataset.type === "fixedtext";
          const labelText = (isEmpty || isButton || isFixedText) ? null : field.querySelector(".label-text");
          const defaultValue = field.dataset.defaultValue || "";
                
                let fieldValue = "";
                if (!isEmpty) {
                  const control = field.querySelector(".field-control");
                  if (control) {
                    if (isButton) {
                      const button = control.querySelector("button");
                      if (button) {
                        fieldValue = button.textContent.trim() || "";
                      }
                    } else {
                      const input = control.querySelector("input");
                      const textarea = control.querySelector("textarea");
                      const select = control.querySelector("select");
                      
                      if (input) {
                        fieldValue = input.value || "";
                      } else if (textarea) {
                        fieldValue = textarea.value || "";
                      } else if (select) {
                        fieldValue = select.value || "";
                      }
                    }
                  }
                }
                
          const result = {
            type: field.dataset.type,
            label: labelText ? labelText.textContent.trim() : "",
            dbField: field.dataset.dbField || "",
            width: field.dataset.width || "small",
            rowHeight: field.dataset.rowHeight || "1",
            length: field.dataset.fieldLength || "N/A",
            fieldType: field.dataset.fieldType || "real",
            selectOptions: field.dataset.selectOptions || "",
            tcode: field.dataset.fieldTcode || "N/A",
                  relationField: (field.dataset.relationField && field.dataset.relationField !== "N/A") ? field.dataset.relationField : "",
            otherNote: field.dataset.otherNote || "N/A",
            required: field.dataset.required === "true",
            readonly: field.dataset.readonly === "true",
            primaryKey: field.dataset.primaryKey === "true",
                  defaultValue,
                  value: fieldValue
          };
          if (isFixedText && field.dataset.textColor) {
            result.textColor = field.dataset.textColor;
          }
          if (isButton && field.dataset.buttonWidth) {
            result.buttonWidth = field.dataset.buttonWidth;
          }
          return result;
        });
            }
          }
        }
        
        const result = {
          type: isGrid ? "grid-panel" : (hasTabs ? "panel" : "panel-no-tabs"),
          title: panel.dataset.title || "區塊",
          tabs: hasTabs && tabs.length > 0 ? tabs : (hasTabs ? [{ title: panel.dataset.title || "區塊", active: true }] : []),
          columns: panel.dataset.columns || "3",
          collapsed: panel.classList.contains("collapsed"),
          fields
        };
        
        // 保存資料表識別、關聯的父表和 DB 資料表名
        // 對於有頁籤的面板，屬性已保存在每個 tab 的配置中；對於無頁籤的面板，保存在 panel 上
        if (!hasTabs) {
        if (panel.dataset.panelTableId) {
          result.tableId = panel.dataset.panelTableId;
          if (panel.dataset.panelTableId === "custom" && panel.dataset.panelTableIdCustom) {
            result.tableIdCustom = panel.dataset.panelTableIdCustom;
          }
        }
        if (panel.dataset.panelParentTable) {
          result.parentTable = panel.dataset.panelParentTable;
          if (panel.dataset.panelParentTable === "custom" && panel.dataset.panelParentTableCustom) {
            result.parentTableCustom = panel.dataset.panelParentTableCustom;
          }
        }
        if (panel.dataset.panelDbTable) {
          result.dbTable = panel.dataset.panelDbTable;
          }
          // 保存頁籤標題（無頁籤的面板）
          if (panel.dataset.panelTabTitle) {
            result.panelTabTitle = panel.dataset.panelTabTitle;
          }
        }
        
        if (!isGrid) {
          const defaultHeight = hasTabs ? "3" : "1";
          result.panelHeight = panel.dataset.panelHeight || defaultHeight;
        } else {
          // GRID 面板：保存頁籤標題
          if (panel.dataset.panelTabTitle) {
            result.panelTabTitle = panel.dataset.panelTabTitle;
          }
        }
        
        if (isGrid) {
          const gridBody = panel.querySelector(".grid-panel-body");
          const headerCells = gridBody?.querySelectorAll(".grid-header-cell");
          const dataRows = gridBody?.querySelectorAll(".grid-data-row");
          
          result.gridColumns = Array.from(headerCells || []).map(cell => {
            let title = cell.querySelector(".header-title")?.textContent.trim() || "";
            // 如果標題有括號（唯讀狀態），提取實際標題
            if (title.startsWith("(") && title.endsWith(")")) {
              title = title.slice(1, -1).trim();
            }
            return {
            title,
            width: parseInt(cell.style.width) || 100,
            dbField: cell.dataset.dbField || "",
            widthProp: cell.dataset.width || "small",
            rowHeight: cell.dataset.rowHeight || "1",
            length: cell.dataset.fieldLength || "N/A",
            fieldType: cell.dataset.fieldType || "real",
            selectOptions: cell.dataset.selectOptions || "",
            tcode: cell.dataset.fieldTcode || "N/A",
            relationField: (cell.dataset.relationField && cell.dataset.relationField !== "N/A") ? cell.dataset.relationField : "",
            otherNote: cell.dataset.otherNote || "N/A",
            required: cell.dataset.required === "true",
            readonly: cell.dataset.readonly === "true",
            primaryKey: cell.dataset.primaryKey === "true",
            defaultValue: cell.dataset.defaultValue || ""
            };
          });
          
          result.gridRows = Array.from(dataRows || []).map(row => {
            const cells = row.querySelectorAll(".grid-data-cell input");
            return Array.from(cells).map(input => input.value || "");
          });
        }
        
        return result;
      });
      return {
        meta: {
          version: 2,
          generatedAt: new Date().toISOString()
        },
        layout: {
          title: documentTitleInput.value || "銷售訂單",
          panels
        }
      };
    }

    function applyLayout(payload) {
      if (!payload) {
        throw new Error("匯入資料為空");
      }
      
      // 確保有 layout 物件
      const layout = payload.layout;
      if (!layout) {
        throw new Error("找不到 layout 資料");
      }
      
      // 驗證 panels 是陣列
      if (!Array.isArray(layout.panels)) {
        throw new Error("panels 必須是陣列格式");
      }
      
      // 清空畫布
      canvas.querySelectorAll(".panel").forEach((panel) => panel.remove());
      selectField(null);
      selectGridHeaderCell(null);
      setActivePanel(null);
      ensurePlaceholder();
      
      // 設定標題
      const title = layout.title || "銷售訂單";
      documentTitleInput.value = title;
      
      // 載入所有面板
      let loadedCount = 0;
      let errorCount = 0;
      const errors = [];
      
      layout.panels.forEach((panelConfig, index) => {
        try {
          if (!panelConfig) {
            throw new Error("面板配置為空");
          }
          
        addPanel(panelConfig);
          loadedCount++;
        } catch (error) {
          errorCount++;
          const errorMsg = `面板 ${index + 1} 載入失敗：${error.message}`;
          errors.push(errorMsg);
          console.error(errorMsg, error);
        }
      });
      
      // 清理狀態
      selectField(null);
      selectGridHeaderCell(null);
      setActivePanel(null);
      ensurePlaceholder();
      
      // 如果有錯誤，顯示警告但不清除已載入的面板
      if (errorCount > 0) {
        const errorMessage = `成功載入 ${loadedCount} 個面板，${errorCount} 個面板載入失敗。\n\n錯誤詳情：\n${errors.join("\n")}`;
        console.warn(errorMessage);
        if (loadedCount === 0) {
          // 如果全部失敗，拋出錯誤
          throw new Error(errorMessage);
        } else {
          // 部分成功，顯示警告
          alert(`部分載入成功：\n成功：${loadedCount} 個\n失敗：${errorCount} 個\n\n請查看控制台了解詳細錯誤。`);
        }
      }
    }

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2000);
    }

    // 登入驗證邏輯
    const loginScreen = document.getElementById("login-screen");
    const mainApp = document.getElementById("main-app");
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    const loginUsername = document.getElementById("login-username");
    const loginPassword = document.getElementById("login-password");

    // 固定帳號密碼
    const VALID_USERNAME = "chi";
    const VALID_PASSWORD = "23736165";

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      const username = loginUsername.value.trim();
      const password = loginPassword.value;

      // 驗證帳號密碼
      if (username === VALID_USERNAME && password === VALID_PASSWORD) {
        // 登入成功：隱藏登入畫面，顯示主畫面
        loginScreen.style.display = "none";
        mainApp.style.display = "block";
        loginError.style.display = "none";
        
        // 清除密碼欄位
        loginPassword.value = "";
      } else {
        // 登入失敗：顯示錯誤訊息
        loginError.style.display = "block";
        loginPassword.value = "";
        loginPassword.focus();
      }
    });

    // 按 Enter 鍵提交表單
    loginUsername.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        loginPassword.focus();
      }
    });

    loginPassword.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        loginForm.dispatchEvent(new Event("submit"));
      }
    });

    // 登出功能
    const btnLogout = document.getElementById("btn-logout");
    btnLogout.addEventListener("click", () => {
      // 隱藏主畫面
      mainApp.style.display = "none";
      
      // 顯示登入畫面
      loginScreen.style.display = "flex";
      
      // 清空登入表單
      loginUsername.value = "";
      loginPassword.value = "";
      loginError.style.display = "none";
      
      // 聚焦到帳號欄位
      loginUsername.focus();
    });
  </script>
  </div>
</body>
</html>

